<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø© - ØªØ±Ø­Ø§Ù„ Ø²ÙˆÙ†Ø§</title>
    
    <!-- âœ… Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    
    <!-- âœ… Leaflet Ù„Ù„Ø®Ø±ÙŠØ·Ø© -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- âœ… Supabase Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --primary-light: #e0e7ff;
            --secondary: #10b981;
            --secondary-dark: #059669;
            --danger: #ef4444;
            --warning: #f59e0b;
            --light: #f9fafb;
            --dark: #111827;
            --gray: #6b7280;
            --gray-light: #e5e7eb;
            --radius: 12px;
            --radius-lg: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .app-container {
            max-width: 500px;
            width: 100%;
            min-height: auto;
            background: var(--light);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: containerAppear 0.5s ease-out;
        }
        
        @keyframes containerAppear {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        /* âœ… Header Ù…Ø«Ù„ ØªØ·Ø¨ÙŠÙ‚ ØªØ±Ø­Ø§Ù„ */
        .app-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 24px;
            text-align: center;
            border-bottom: 4px solid var(--primary-dark);
            position: relative;
        }
        
        .app-header h1 {
            font-size: 24px;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .logo-img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            animation: logoPulse 2s infinite;
        }
        
        @keyframes logoPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .urgent-badge {
            position: absolute;
            top: 10px;
            left: 20px;
            background: var(--danger);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            animation: urgentPulse 1s infinite;
        }
        
        @keyframes urgentPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* âœ… Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© */
        .page-content {
            padding: 32px 24px;
        }
        
        .card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 28px;
            box-shadow: var(--shadow-lg);
            border: 2px solid var(--primary-light);
            margin-bottom: 24px;
            text-align: center;
            animation: cardAppear 0.6s ease-out 0.2s both;
        }
        
        @keyframes cardAppear {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        .ride-icon {
            font-size: 72px;
            margin-bottom: 20px;
            color: var(--primary);
            animation: iconFloat 3s ease-in-out infinite;
        }
        
        @keyframes iconFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .ride-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 12px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .ride-subtitle {
            color: var(--gray);
            font-size: 16px;
            margin-bottom: 32px;
            line-height: 1.6;
        }
        
        /* âœ… ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø© */
        .ride-details {
            background: linear-gradient(135deg, #f0f9ff 0%, #fef7ff 100%);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 28px;
            border-right: 4px solid var(--primary);
            border-left: 4px solid var(--primary-light);
            animation: detailsSlide 0.7s ease-out 0.4s both;
        }
        
        @keyframes detailsSlide {
            from { 
                opacity: 0; 
                transform: translateX(-20px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid rgba(79, 70, 229, 0.1);
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .detail-row:hover {
            background: rgba(79, 70, 229, 0.05);
            padding-right: 8px;
            border-radius: 8px;
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            color: var(--primary-dark);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .detail-value {
            font-weight: 700;
            color: var(--dark);
            text-align: left;
            max-width: 60%;
        }
        
        /* âœ… Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
        .map-container {
            width: 100%;
            height: 220px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin: 24px 0;
            border: 3px solid var(--primary-light);
            box-shadow: var(--shadow);
            animation: mapExpand 0.8s ease-out 0.6s both;
        }
        
        @keyframes mapExpand {
            from { 
                opacity: 0; 
                height: 0; 
                margin: 0; 
            }
            to { 
                opacity: 1; 
                height: 220px; 
                margin: 24px 0; 
            }
        }
        
        #ride-map {
            width: 100%;
            height: 100%;
        }
        
        /* âœ… Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ */
        .countdown {
            text-align: center;
            margin: 24px 0;
            padding: 20px;
            background: linear-gradient(135deg, #fef2f2 0%, #fef3c7 100%);
            border-radius: var(--radius-lg);
            border: 3px solid var(--danger);
            position: relative;
            overflow: hidden;
            animation: countdownAppear 0.5s ease-out 0.8s both;
        }
        
        @keyframes countdownAppear {
            from { 
                opacity: 0; 
                transform: scale(0.8); 
            }
            to { 
                opacity: 1; 
                transform: scale(1); 
            }
        }
        
        .countdown::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--danger), var(--warning));
            animation: countdownBar 45s linear forwards;
        }
        
        @keyframes countdownBar {
            from { width: 100%; }
            to { width: 0%; }
        }
        
        .countdown-title {
            font-size: 16px;
            color: var(--gray);
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .countdown-timer {
            font-size: 48px;
            font-weight: 900;
            color: var(--danger);
            text-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
            font-family: 'Tajawal', monospace;
        }
        
        /* âœ… Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .buttons-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 28px 0;
            animation: buttonsAppear 0.5s ease-out 1s both;
        }
        
        @keyframes buttonsAppear {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        .btn {
            padding: 18px 24px;
            border-radius: var(--radius);
            border: none;
            font-family: 'Tajawal', sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:active::after {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.5);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.5);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }
        
        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.5);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary-light);
            transform: translateY(-3px);
        }
        
        /* âœ… Ø§Ù„Ø­Ø§Ù„Ø© */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 700;
            margin-bottom: 20px;
            animation: statusPulse 2s infinite;
        }
        
        @keyframes statusPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); }
        }
        
        .status-pending {
            background: linear-gradient(135deg, #fef3c7, #f59e0b);
            color: #92400e;
        }
        
        .status-accepted {
            background: linear-gradient(135deg, #dcfce7, var(--secondary));
            color: var(--secondary-dark);
        }
        
        /* âœ… ØµÙˆØª ÙˆØ§Ù‡ØªØ²Ø§Ø² */
        .sound-control {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
        }
        
        .sound-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }
        
        .sound-btn:hover {
            transform: scale(1.1);
            background: var(--primary-light);
        }
        
        /* âœ… Responsive */
        @media (max-width: 480px) {
            .page-content {
                padding: 20px 16px;
            }
            
            .card {
                padding: 20px;
            }
            
            .buttons-grid {
                grid-template-columns: 1fr;
            }
            
            .countdown-timer {
                font-size: 36px;
            }
            
            .ride-icon {
                font-size: 56px;
            }
        }
        
        /* âœ… Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* âœ… Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            left: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 10000;
            animation: notificationSlide 0.3s ease;
            border-right: 4px solid var(--primary);
            max-width: 500px;
            margin: 0 auto;
        }
        
        @keyframes notificationSlide {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- âœ… Ø²Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ØµÙˆØª -->
    <div class="sound-control">
        <div class="sound-btn" id="sound-toggle" onclick="toggleSound()">
            <ion-icon name="volume-high-outline" id="sound-icon" style="font-size: 24px; color: var(--primary);"></ion-icon>
        </div>
    </div>
    
    <div class="app-container">
        <!-- âœ… Header -->
        <header class="app-header">
            <div class="urgent-badge">
                <ion-icon name="alert-circle"></ion-icon>
                Ø·Ù„Ø¨ Ø¹Ø§Ø¬Ù„
            </div>
            <h1>
                <img src="icons/icon-512x512.png" alt="ØªØ±Ø­Ø§Ù„ Ø²ÙˆÙ†Ø§" class="logo-img">
                ØªØ±Ø­Ù€Ù€Ø§Ù„ Ø²ÙˆÙ†Ù€Ù€Ø§
            </h1>
            <p style="margin-top: 8px; opacity: 0.9; font-size: 14px;">Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±ÙƒÙˆØ¨ - ØªØ­Ø¯ÙŠØ« Ù…Ø¨Ø§Ø´Ø±</p>
        </header>
        
        <!-- âœ… Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© -->
        <div class="page-content">
            <div class="card">
                <div class="ride-icon">
                    <ion-icon name="car-sport-outline"></ion-icon>
                </div>
                
                <div id="status-area">
                    <div class="status-badge status-pending">
                        <ion-icon name="time-outline"></ion-icon>
                        <span id="status-text">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯Ùƒ</span>
                    </div>
                </div>
                
                <h1 class="ride-title" id="ride-title">ğŸš¨ Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯</h1>
                <p class="ride-subtitle" id="ride-subtitle">Ù„Ø¯ÙŠÙƒ <strong>45 Ø«Ø§Ù†ÙŠØ©</strong> Ù„Ù„Ø±Ø¯ Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø³Ø§Ø¦Ù‚ Ø¢Ø®Ø±</p>
                
                <!-- âœ… Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ -->
                <div class="countdown">
                    <div class="countdown-title">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø±Ø¯</div>
                    <div class="countdown-timer" id="countdown-timer">45</div>
                </div>
                
                <!-- âœ… ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø© -->
                <div class="ride-details">
                    <h3 style="text-align: right; margin-bottom: 20px; color: var(--primary); display: flex; align-items: center; gap: 10px;">
                        <ion-icon name="information-circle-outline"></ion-icon>
                        ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©
                    </h3>
                    
                    <div id="ride-details-content">
                        <div class="detail-row">
                            <span class="detail-label">
                                <ion-icon name="person-circle-outline"></ion-icon>
                                Ø§Ù„Ø¹Ù…ÙŠÙ„:
                            </span>
                            <span class="detail-value" id="customer-name">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">
                                <ion-icon name="call-outline"></ion-icon>
                                Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:
                            </span>
                            <span class="detail-value" id="customer-phone">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">
                                <ion-icon name="car-outline"></ion-icon>
                                Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©:
                            </span>
                            <span class="detail-value" id="vehicle-type">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">
                                <ion-icon name="navigate-outline"></ion-icon>
                                Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚:
                            </span>
                            <span class="detail-value" id="pickup-location">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">
                                <ion-icon name="location-outline"></ion-icon>
                                Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙˆØµÙˆÙ„:
                            </span>
                            <span class="detail-value" id="destination">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">
                                <ion-icon name="speedometer-outline"></ion-icon>
                                Ø§Ù„Ù…Ø³Ø§ÙØ©:
                            </span>
                            <span class="detail-value" id="distance">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">
                                <ion-icon name="cash-outline"></ion-icon>
                                Ø§Ù„Ø³Ø¹Ø±:
                            </span>
                            <span class="detail-value" id="price" style="color: var(--primary); font-size: 18px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                        </div>
                    </div>
                </div>
                
                <!-- âœ… Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© -->
                <div class="map-container">
                    <div id="ride-map"></div>
                </div>
                
                <!-- âœ… Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
                <div class="buttons-grid" id="buttons-area">
                    <button class="btn btn-primary" onclick="acceptRide()" id="accept-btn">
                        <ion-icon name="checkmark-circle-outline"></ion-icon>
                        Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©
                    </button>
                    
                    <button class="btn btn-danger" onclick="declineRide()" id="decline-btn">
                        <ion-icon name="close-circle-outline"></ion-icon>
                        Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©
                    </button>
                    
                    <button class="btn btn-secondary" onclick="callCustomer()" id="call-btn">
                        <ion-icon name="call-outline"></ion-icon>
                        Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø¢Ù†
                    </button>
                    
                    <button class="btn btn-outline" onclick="showRoute()" id="route-btn">
                        <ion-icon name="map-outline"></ion-icon>
                        Ø¹Ø±Ø¶ Ø§Ù„Ø·Ø±ÙŠÙ‚
                    </button>
                </div>
                
                <!-- âœ… Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
                <div id="response-message" style="text-align: center; margin-top: 20px;"></div>
                
                <!-- âœ… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
                <div style="margin-top: 20px; padding: 16px; background: #f8fafc; border-radius: var(--radius); border: 1px dashed var(--gray-light);">
                    <div style="display: flex; justify-content: space-between; font-size: 14px; color: var(--gray);">
                        <span>
                            <ion-icon name="time-outline"></ion-icon>
                            ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©: <span id="response-time">0</span> Ø«Ø§Ù†ÙŠØ©
                        </span>
                        <span>
                            <ion-icon name="flash-outline"></ion-icon>
                            ØªØ­Ø¯ÙŠØ«: <span id="last-update">Ø§Ù„Ø¢Ù†</span>
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- âœ… Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© -->
            <button class="btn btn-outline" onclick="goBackToDashboard()" style="width: 100%; margin-top: 16px;">
                <ion-icon name="arrow-back-outline"></ion-icon>
                Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            </button>
        </div>
    </div>
    
    <!-- âœ… Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª -->
    <audio id="notification-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="accept-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="decline-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3" type="audio/mpeg">
    </audio>
    
    <script>
        // ==============================================
        // âœ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        // ==============================================
        const SB_URL = 'https://zsmlyiygjagmhnglrhoa.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzbWx5aXlnamFnbWhuZ2xyaG9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NDc3NjMsImV4cCI6MjA4MTUyMzc2M30.QviVinAng-ILq0umvI5UZCFEvNpP3nI0kW_hSaXxNps';
        
        const tarhalDB = supabase.createClient(SB_URL, SB_KEY);
        let rideId = null;
        let countdown = 45;
        let countdownInterval = null;
        let rideData = null;
        let rideMap = null;
        let soundEnabled = true;
        let vibrationEnabled = true;
        let startTime = Date.now();
        
        // ==============================================
        // âœ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
        // ==============================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ ØµÙØ­Ø© Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø© Ø¬Ø§Ù‡Ø²Ø©');
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ rideId Ù…Ù† URL
            const urlParams = new URLSearchParams(window.location.search);
            rideId = urlParams.get('rideId');
            
            if (!rideId) {
                showError('Ø±Ù‚Ù… Ø§Ù„Ø±Ø­Ù„Ø© ØºÙŠØ± ØµØ§Ù„Ø­', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¹ÙˆØ¯Ø© ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ø§Ø¨Ø·');
                return;
            }
            
            // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ÙˆØ§Ù„Ø§Ù‡ØªØ²Ø§Ø²
            playNotificationSound();
            triggerVibration();
            
            // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
            startCountdown();
            
            // ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©
            await loadRideDetails();
            
            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
            initMap();
            
            // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            startAutoRefresh();
            
            // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
            updateResponseTime();
        });
        
        // ==============================================
        // âœ… Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª ÙˆØ§Ù„Ø§Ù‡ØªØ²Ø§Ø²
        // ==============================================
        function playNotificationSound() {
            if (!soundEnabled) return;
            
            const sound = document.getElementById('notification-sound');
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.log('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:', e));
                
                // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ Ù„Ù„ØªØ°ÙƒÙŠØ±
                setTimeout(() => {
                    if (countdown > 0 && soundEnabled) {
                        sound.play().catch(e => console.log('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:', e));
                    }
                }, 10000);
            }
        }
        
        function playAcceptSound() {
            if (!soundEnabled) return;
            const sound = document.getElementById('accept-sound');
            if (sound) {
                sound.currentTime = 0;
                sound.play();
            }
        }
        
        function playDeclineSound() {
            if (!soundEnabled) return;
            const sound = document.getElementById('decline-sound');
            if (sound) {
                sound.currentTime = 0;
                sound.play();
            }
        }
        
        function triggerVibration() {
            if (!vibrationEnabled || !navigator.vibrate) return;
            
            // Ù†Ù…Ø· Ø§Ù‡ØªØ²Ø§Ø² Ù…ÙƒØ«Ù Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡
            navigator.vibrate([200, 100, 200, 100, 200, 100, 500]);
            
            // ØªÙƒØ±Ø§Ø± Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² ÙƒÙ„ 15 Ø«Ø§Ù†ÙŠØ©
            if (countdown > 0) {
                setTimeout(triggerVibration, 15000);
            }
        }
        
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const icon = document.getElementById('sound-icon');
            
            if (soundEnabled) {
                icon.name = 'volume-high-outline';
                showNotification('ğŸ”Š ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª', 'success');
                playNotificationSound();
            } else {
                icon.name = 'volume-mute-outline';
                showNotification('ğŸ”‡ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª', 'info');
            }
        }
        
        // ==============================================
        // âœ… Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
        // ==============================================
        function startCountdown() {
            const timerElement = document.getElementById('countdown-timer');
            
            countdownInterval = setInterval(() => {
                countdown--;
                timerElement.textContent = countdown;
                
                // ØªØºÙŠÙŠØ± Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù…Ø¹ Ø§Ù„ÙˆÙ‚Øª
                if (countdown <= 10) {
                    timerElement.style.color = '#ef4444';
                    timerElement.style.animation = 'pulse 0.5s infinite alternate';
                    
                    // ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø¶Ø§ÙÙŠ Ø¹Ù†Ø¯ Ù‚Ø±Ø¨ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                    if (soundEnabled && countdown <= 5) {
                        playNotificationSound();
                    }
                } else if (countdown <= 20) {
                    timerElement.style.color = '#f59e0b';
                }
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    autoDeclineRide();
                }
                
                updateResponseTime();
            }, 1000);
        }
        
        // ==============================================
        // âœ… ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ù† Supabase
        // ==============================================
        async function loadRideDetails() {
            try {
                showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©...');
                
                // Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù…Ù† Supabase
                const { data, error } = await tarhalDB
                    .from('rides')
                    .select('*')
                    .eq('id', rideId)
                    .single();
                
                if (error) throw error;
                
                rideData = data;
                
                // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                document.getElementById('customer-name').textContent = data.customer_name || 'Ø¹Ù…ÙŠÙ„ ØªØ±Ø­Ø§Ù„';
                document.getElementById('customer-phone').textContent = data.customer_phone || '+249 xxx xxx xxx';
                document.getElementById('vehicle-type').textContent = getVehicleTypeName(data.vehicle_type);
                document.getElementById('pickup-location').textContent = data.pickup_location || 'Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                document.getElementById('destination').textContent = data.destination || 'ÙˆØ¬Ù‡Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©';
                document.getElementById('distance').textContent = `${data.distance_km || '0'} ÙƒÙ…`;
                document.getElementById('price').textContent = `${(data.amount || 0).toLocaleString()} SDG`;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                document.getElementById('ride-title').textContent = `Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© #${data.id}`;
                
                showNotification('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©', 'success');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„:', error);
                showError('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
                
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©
                useMockData();
            }
        }
        
        function useMockData() {
            const mockData = {
                customer_name: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯',
                customer_phone: '+249 90 123 4567',
                vehicle_type: 'economy',
                pickup_location: 'Ø§Ù„Ø®Ø±Ø·ÙˆÙ… - Ø§Ù„Ø¹Ù…Ø§Ø±Ø§Øª',
                destination: 'Ø£Ù… Ø¯Ø±Ù…Ø§Ù† - Ø§Ù„Ø³ÙˆÙ‚',
                distance_km: 5.2,
                amount: 12500
            };
            
            rideData = mockData;
            
            document.getElementById('customer-name').textContent = mockData.customer_name;
            document.getElementById('customer-phone').textContent = mockData.customer_phone;
            document.getElementById('vehicle-type').textContent = getVehicleTypeName(mockData.vehicle_type);
            document.getElementById('pickup-location').textContent = mockData.pickup_location;
            document.getElementById('destination').textContent = mockData.destination;
            document.getElementById('distance').textContent = `${mockData.distance_km} ÙƒÙ…`;
            document.getElementById('price').textContent = `${mockData.amount.toLocaleString()} SDG`;
        }
        
        // ==============================================
        // âœ… Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©
        // ==============================================
        function initMap() {
            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø®Ø±Ø·ÙˆÙ… ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ
                const defaultCoords = [15.5007, 32.5599];
                
                rideMap = L.map('ride-map').setView(defaultCoords, 13);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap',
                    maxZoom: 19
                }).addTo(rideMap);
                
                // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø§Øª Ù„Ù„Ù…ÙˆÙ‚Ø¹ÙŠÙ†
                const pickupMarker = L.marker(defaultCoords, {
                    icon: L.divIcon({
                        html: '<div style="background: #4f46e5; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                        className: 'pickup-marker'
                    })
                }).addTo(rideMap)
                  .bindPopup('ğŸ“ Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚')
                  .openPopup();
                
                // Ø¥Ø¶Ø§ÙØ© Ø®Ø· Ø¨ÙŠÙ† Ø§Ù„Ù†Ù‚Ø§Ø·
                const polyline = L.polyline([
                    defaultCoords,
                    [15.5500, 32.6000]
                ], {
                    color: '#4f46e5',
                    weight: 4,
                    opacity: 0.7,
                    dashArray: '10, 10'
                }).addTo(rideMap);
                
                // Ø¶Ø¨Ø· Ø§Ù„Ø¹Ø±Ø¶ Ù„ÙŠØ´Ù…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª
                rideMap.fitBounds(polyline.getBounds());
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©:', error);
                document.querySelector('.map-container').innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--primary);">
                        <ion-icon name="map-outline" style="font-size: 48px;"></ion-icon>
                        <p style="margin-top: 10px;">Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø±Ø­Ù„Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                    </div>
                `;
            }
        }
        
        function showRoute() {
            if (!rideMap) return;
            
            // Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª
            showNotification('ğŸ—ºï¸ Ø¬Ø§Ø±ÙŠ Ø¹Ø±Ø¶ Ø£ÙØ¶Ù„ Ø§Ù„Ø·Ø±Ù‚...', 'info');
            
            // ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ø³ØªØ³ØªØ®Ø¯Ù… Ø®Ø¯Ù…Ø© Ù…Ø«Ù„ Mapbox Ø£Ùˆ Google Maps Directions API
            setTimeout(() => {
                showNotification('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙØ¶Ù„ Ø·Ø±ÙŠÙ‚ Ù„Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'success');
            }, 1500);
        }
        
        // ==============================================
        // âœ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø±Ø­Ù„Ø©
        // ==============================================
        async function acceptRide() {
            clearInterval(countdownInterval);
            playAcceptSound();
            
            const acceptBtn = document.getElementById('accept-btn');
            const declineBtn = document.getElementById('decline-btn');
            const responseMessage = document.getElementById('response-message');
            const statusArea = document.getElementById('status-area');
            
            // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            disableButtons();
            acceptBtn.innerHTML = '<span class="loading"></span> Ø¬Ø§Ø±ÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„...';
            
            try {
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø© ÙÙŠ Supabase
                const { error } = await tarhalDB
                    .from('rides')
                    .update({
                        status: 'accepted',
                        driver_id: localStorage.getItem('driver_id'),
                        accepted_at: new Date().toISOString(),
                        response_time: Math.floor((Date.now() - startTime) / 1000)
                    })
                    .eq('id', rideId);
                
                if (error) throw error;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                statusArea.innerHTML = `
                    <div class="status-badge status-accepted">
                        <ion-icon name="checkmark-circle"></ion-icon>
                        <span>ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!</span>
                    </div>
                `;
                
                responseMessage.innerHTML = `
                    <div style="color: var(--secondary-dark); background: #dcfce7; padding: 20px; border-radius: var(--radius); border: 2px solid var(--secondary);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                            <ion-icon name="checkmark-circle" style="font-size: 32px;"></ion-icon>
                            <div>
                                <strong style="font-size: 18px;">ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!</strong><br>
                                <span style="font-size: 14px;">ØªÙ… Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ø¹Ù…ÙŠÙ„. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªÙˆØ¬Ù‡ Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚.</span>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-secondary" onclick="callCustomer()" style="padding: 10px;">
                                <ion-icon name="call-outline"></ion-icon> Ø§Ù„Ø§ØªØµØ§Ù„
                            </button>
                            <button class="btn btn-outline" onclick="shareLocation()" style="padding: 10px;">
                                <ion-icon name="share-outline"></ion-icon> Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹
                            </button>
                        </div>
                    </div>
                `;
                
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
                document.getElementById('buttons-area').style.display = 'none';
                document.querySelector('.countdown').style.display = 'none';
                
                showNotification('ğŸ‰ ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©! ØªÙˆØ¬Ù‡ Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚.', 'success');
                
                // ØªØ­Ø¯ÙŠØ« JSONBin (Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù…Ù‡)
                await updateDriverStatus('accepted');
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„ (ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø­Ù‚ÙŠÙ‚ÙŠ)
                // await notifyCustomer('accepted');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©:', error);
                responseMessage.innerHTML = `
                    <div style="color: var(--danger); background: #fee2e2; padding: 16px; border-radius: var(--radius);">
                        <ion-icon name="warning" style="font-size: 24px; vertical-align: middle;"></ion-icon>
                        <strong>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù‚Ø¨ÙˆÙ„:</strong><br>
                        ${error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±'}
                    </div>
                `;
                
                enableButtons();
                acceptBtn.innerHTML = '<ion-icon name="checkmark-circle-outline"></ion-icon> Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©';
            }
        }
        
        async function declineRide() {
            clearInterval(countdownInterval);
            playDeclineSound();
            
            const declineBtn = document.getElementById('decline-btn');
            const responseMessage = document.getElementById('response-message');
            
            disableButtons();
            declineBtn.innerHTML = '<span class="loading"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¶...';
            
            try {
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø© ÙÙŠ Supabase
                const { error } = await tarhalDB
                    .from('rides')
                    .update({
                        status: 'declined',
                        declined_at: new Date().toISOString(),
                        response_time: Math.floor((Date.now() - startTime) / 1000)
                    })
                    .eq('id', rideId);
                
                if (error) throw error;
                
                responseMessage.innerHTML = `
                    <div style="color: #92400e; background: #fef3c7; padding: 20px; border-radius: var(--radius); border: 2px solid #f59e0b;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <ion-icon name="information-circle" style="font-size: 32px;"></ion-icon>
                            <div>
                                <strong style="font-size: 18px;">ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©</strong><br>
                                <span style="font-size: 14px;">Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø³Ø§Ø¦Ù‚ Ø¢Ø®Ø±. Ø´ÙƒØ±Ø§Ù‹ Ù„Ø±Ø¯Ùƒ Ø§Ù„Ø³Ø±ÙŠØ¹.</span>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('buttons-area').style.display = 'none';
                document.querySelector('.countdown').style.display = 'none';
                document.getElementById('status-area').innerHTML = `
                    <div class="status-badge" style="background: #fef3c7; color: #92400e;">
                        <ion-icon name="close-circle"></ion-icon>
                        <span>ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©</span>
                    </div>
                `;
                
                showNotification('ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©', 'info');
                
                // ØªØ­Ø¯ÙŠØ« JSONBin
                await updateDriverStatus('declined');
                
                // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
                setTimeout(() => {
                    goBackToDashboard();
                }, 5000);
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©:', error);
                responseMessage.innerHTML = `
                    <div style="color: var(--danger); background: #fee2e2; padding: 16px; border-radius: var(--radius);">
                        <ion-icon name="warning" style="font-size: 24px; vertical-align: middle;"></ion-icon>
                        <strong>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¶:</strong><br>
                        ${error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±'}
                    </div>
                `;
                
                enableButtons();
                declineBtn.innerHTML = '<ion-icon name="close-circle-outline"></ion-icon> Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©';
            }
        }
        
        function autoDeclineRide() {
            showNotification('â° Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø±Ø¯! ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.', 'warning');
            declineRide();
        }
        
        // ==============================================
        // âœ… Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
        // ==============================================
        function callCustomer() {
            const phone = document.getElementById('customer-phone').textContent;
            const cleanPhone = phone.replace(/\D/g, '');
            
            if (cleanPhone && cleanPhone.length >= 9) {
                window.open(`tel:${cleanPhone}`, '_self');
                showNotification('ğŸ“ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„...', 'info');
            } else {
                showNotification('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± Ù…ØªÙˆÙØ±', 'warning');
            }
        }
        
        function shareLocation() {
            if (navigator.share) {
                navigator.share({
                    title: 'Ù…ÙˆÙ‚Ø¹ÙŠ - ØªØ±Ø­Ø§Ù„',
                    text: `Ø£Ù†Ø§ ÙÙŠ Ø·Ø±ÙŠÙ‚ÙŠ Ø¥Ù„ÙŠÙƒ! ÙˆÙ‚Øª Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: 10 Ø¯Ù‚Ø§Ø¦Ù‚`,
                    url: window.location.href
                });
            } else {
                showNotification('Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­', 'warning');
            }
        }
        
        function goBackToDashboard() {
            // ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø­Ù‚ÙŠÙ‚ÙŠ: window.location.href = '/driver-dashboard-screen'
            showNotification('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©...', 'info');
            setTimeout(() => {
                window.close();
                // Ø£Ùˆ: window.history.back();
                // Ø£Ùˆ: window.location.href = 'index.html';
            }, 1000);
        }
        
        function getVehicleTypeName(type) {
            const names = {
                'tuktuk': 'ØªÙˆÙƒ ØªÙˆÙƒ',
                'economy': 'Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©',
                'comfort': 'Ù…ØªÙˆØ³Ø·Ø©',
                'vip': 'VIP',
                'driver': 'Ø®Ø§Øµ Ø¨Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†'
            };
            return names[type] || type;
        }
        
        function disableButtons() {
            document.querySelectorAll('#buttons-area button').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.6';
            });
        }
        
        function enableButtons() {
            document.querySelectorAll('#buttons-area button').forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
            });
        }
        
        function updateResponseTime() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('response-time').textContent = elapsed;
            document.getElementById('last-update').textContent = `Ù‚Ø¨Ù„ ${elapsed} Ø«Ø§Ù†ÙŠØ©`;
        }
        
        function startAutoRefresh() {
            // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ
            setInterval(() => {
                if (countdown > 0) {
                    updateResponseTime();
                }
            }, 10000);
        }
        
        async function updateDriverStatus(status) {
            try {
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ JSONBin
                const driverId = localStorage.getItem('driver_id');
                if (!driverId) return;
                
                await fetch('https://api.jsonbin.io/v3/b/69470e32ae596e708fa76869', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': '$2a$10$.o4BAbiMjGS4tEZUVokTsufL18lsFyO30xIOXO8wT4dP/sqGN/61e'
                    },
                    body: JSON.stringify({
                        last_ride_status: status,
                        last_response_time: Math.floor((Date.now() - startTime) / 1000),
                        updated_at: new Date().toISOString()
                    })
                });
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚:', error);
            }
        }
        
        // ==============================================
        // âœ… Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        // ==============================================
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            let icon = 'information-circle';
            let color = 'var(--primary)';
            
            if (type === 'success') {
                icon = 'checkmark-circle';
                color = 'var(--secondary)';
            } else if (type === 'error' || type === 'warning') {
                icon = 'warning';
                color = type === 'error' ? 'var(--danger)' : 'var(--warning)';
            }
            
            notification.style.borderRightColor = color;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <ion-icon name="${icon}" style="font-size: 24px; color: ${color};"></ion-icon>
                    <div style="flex: 1;">${message}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ 4 Ø«ÙˆØ§Ù†ÙŠ
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-20px)';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }
        
        function showError(title, message) {
            showNotification(`<strong>${title}</strong><br>${message}`, 'error');
        }
        
        function showLoading(message) {
            document.getElementById('status-text').innerHTML = `
                <span class="loading" style="border-color: var(--primary) transparent var(--primary) transparent;"></span>
                ${message}
            `;
        }
        
        // âœ… Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· CSS Ù„Ù„Ø­Ø±ÙƒØ§Øª
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0%, 100% { transform: scale(1); opacity: 1; }
                50% { transform: scale(1.05); opacity: 0.9; }
            }
        `;
        document.head.appendChild(style);
        
        console.log('ğŸ¯ ØµÙØ­Ø© Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¹Ù…Ù„!');
    </script>
</body>
</html>
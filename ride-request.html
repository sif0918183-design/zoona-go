<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ±Ø­Ø§Ù„ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† - Ø·Ù„Ø¨ Ø±Ø­Ù„Ø©</title>
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
    <link rel="stylesheet" href="css/main.css">
    <style>
        .ride-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px 20px;
            text-align: center;
            border-radius: 0 0 25px 25px;
            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .ride-header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }
        
        .ride-header p {
            margin: 10px 0 0;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 20px;
        }
        
        .map-container {
            width: 100%;
            height: 300px;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border: 3px solid white;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
            margin: 25px 0 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title::after {
            content: '';
            flex: 1;
            height: 2px;
            background: var(--gray-light);
        }
        
        .vehicle-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .vehicle-option {
            background: white;
            border-radius: 15px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid var(--gray-light);
            position: relative;
            overflow: hidden;
        }
        
        .vehicle-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .vehicle-option.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
        }
        
        .vehicle-icon {
            font-size: 36px;
            margin-bottom: 10px;
            display: block;
        }
        
        .vehicle-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 5px;
        }
        
        .vehicle-price {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin: 5px 0;
        }
        
        .vehicle-details {
            font-size: 12px;
            color: var(--gray);
            margin-top: 5px;
        }
        
        .price-calculation {
            background: #f0f9ff;
            border-radius: 15px;
            padding: 20px;
            margin: 25px 0;
            border: 2px dashed var(--primary-light);
            text-align: center;
            display: none;
        }
        
        .price-calculation.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .distance-display {
            font-size: 16px;
            color: var(--gray);
            margin-bottom: 15px;
        }
        
        .final-price {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }
        
        .price-note {
            font-size: 12px;
            color: var(--gray);
            margin-top: 10px;
        }
        
        .searching-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            text-align: center;
            padding: 20px;
        }
        
        .searching-content {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            max-width: 400px;
            width: 90%;
        }
        
        .searching-icon {
            font-size: 64px;
            margin-bottom: 20px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .searching-text {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .searching-details {
            color: var(--gray);
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .cancel-search {
            background: #f3f4f6;
            color: var(--gray);
            border: none;
        }
        
        .cancel-search:hover {
            background: #e5e7eb;
        }
        
        .location-inputs {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .input-with-icon {
            position: relative;
        }
        
        .input-with-icon input {
            padding-right: 45px;
        }
        
        .input-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: var(--gray);
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .back-btn:hover {
            opacity: 0.9;
        }
        
        @media (max-width: 480px) {
            .vehicle-options {
                grid-template-columns: 1fr;
            }
            
            .map-container {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ø±Ø£Ø³ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø© -->
        <div class="ride-header">
            <button class="back-btn" onclick="goBack()">
                <span>â†©ï¸</span> Ø§Ù„Ø¹ÙˆØ¯Ø©
            </button>
            <h1>ğŸš– Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h1>
            <p>Ø§Ø®ØªØ± ÙˆØ¬Ù‡ØªÙƒ ÙˆÙ†ÙˆØ¹ Ø³ÙŠØ§Ø±ØªÙƒ</p>
        </div>
        
        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <div class="main-content">
            <!-- Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
            <div class="map-container" id="ride-map"></div>
            
            <!-- Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙˆØ¬Ù‡Ø© -->
            <div class="location-inputs">
                <h3 style="margin: 0 0 15px 0; color: var(--primary);">ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø©</h3>
                
                <div class="input-group">
                    <label>Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ:</label>
                    <div class="input-with-icon">
                        <input type="text" id="current-location" placeholder="Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ..." readonly>
                        <span class="input-icon">ğŸ“</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Ø§Ù„ÙˆØ¬Ù‡Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</label>
                    <div class="input-with-icon">
                        <input type="text" id="destination-input" placeholder="Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø©" readonly>
                        <span class="input-icon">ğŸ¯</span>
                    </div>
                </div>
                
                <p style="font-size: 12px; color: var(--gray); margin-top: 10px; text-align: center;">
                    ğŸ’¡ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ù†Ù‚Ø·Ø© ÙÙŠ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ ÙˆØ¬Ù‡ØªÙƒ
                </p>
            </div>
            
            <!-- Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
            <h3 class="section-title">ğŸš— Ø§Ø®ØªØ± ÙØ¦Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</h3>
            
            <div class="vehicle-options">
                <div class="vehicle-option" onclick="selectVehicle('tuktuk')" data-price="5000">
                    <span class="vehicle-icon" style="color: var(--tuk-tuk);">ğŸ›º</span>
                    <div class="vehicle-name">Ø±ÙƒØ´Ø©</div>
                    <div class="vehicle-price">5,000 SDG</div>
                    <div class="vehicle-details">+ 2,000 Ù„ÙƒÙ„ ÙƒÙ… Ø¥Ø¶Ø§ÙÙŠ</div>
                </div>
                
                <div class="vehicle-option" onclick="selectVehicle('economy')" data-price="6000">
                    <span class="vehicle-icon" style="color: var(--economy);">ğŸš˜</span>
                    <div class="vehicle-name">Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©</div>
                    <div class="vehicle-price">6,000 SDG</div>
                    <div class="vehicle-details">+ 3,000 Ù„ÙƒÙ„ ÙƒÙ… Ø¥Ø¶Ø§ÙÙŠ</div>
                </div>
                
                <div class="vehicle-option" onclick="selectVehicle('comfort')" data-price="7000">
                    <span class="vehicle-icon" style="color: var(--comfort);">ğŸš–</span>
                    <div class="vehicle-name">Ù…ØªÙˆØ³Ø·Ø©</div>
                    <div class="vehicle-price">7,000 SDG</div>
                    <div class="vehicle-details">+ 3,500 Ù„ÙƒÙ„ ÙƒÙ… Ø¥Ø¶Ø§ÙÙŠ</div>
                </div>
                
                <div class="vehicle-option" onclick="selectVehicle('vip')" data-price="10000">
                    <span class="vehicle-icon" style="color: var(--vip);">ğŸï¸</span>
                    <div class="vehicle-name">VIP</div>
                    <div class="vehicle-price">10,000 SDG</div>
                    <div class="vehicle-details">+ 5,000 Ù„ÙƒÙ„ ÙƒÙ… Ø¥Ø¶Ø§ÙÙŠ</div>
                </div>
            </div>
            
            <!-- Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± -->
            <div id="price-calculation" class="price-calculation">
                <div class="distance-display" id="distance-display">
                    Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©: <span id="distance-value">0</span> ÙƒÙ…
                </div>
                <div class="final-price" id="final-price">0 SDG</div>
                <div class="price-note">
                    Ø§Ù„Ø³Ø¹Ø± ÙŠØ´Ù…Ù„ Ø±Ø³ÙˆÙ… Ø§Ù„Ø®Ø¯Ù…Ø© (6%)
                </div>
            </div>
            
            <!-- Ø²Ø± ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ -->
            <button class="btn btn-primary" id="confirm-btn" onclick="confirmRideRequest()" disabled style="width: 100%; padding: 20px; font-size: 18px;">
                <span>ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚</span>
            </button>
        </div>
    </div>
    
    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚ -->
    <div id="searching-overlay" class="searching-overlay hidden">
        <div class="searching-content">
            <div class="searching-icon">ğŸš—</div>
            <div class="searching-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚</div>
            <div class="searching-details">
                Ù†Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ø³Ø§Ø¦Ù‚ Ù…ØªØ§Ø­ ÙÙŠ Ù…Ù†Ø·Ù‚ØªÙƒ
                <br>Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ù‡Ø°Ø§ Ù…Ù† 10-30 Ø«Ø§Ù†ÙŠØ©
            </div>
            
            <div id="searching-driver-info" style="margin: 20px 0; padding: 15px; background: #f0f9ff; border-radius: 10px; display: none;">
                <div style="font-weight: 600; margin-bottom: 5px;" id="driver-name-display"></div>
                <div style="font-size: 14px; color: var(--gray);" id="driver-car-display"></div>
                <div style="margin-top: 10px; font-size: 12px; color: var(--primary);" id="driver-distance"></div>
            </div>
            
            <div id="searching-timer" style="font-size: 32px; font-weight: 700; color: var(--primary); margin: 20px 0;">
                40
            </div>
            
            <button class="btn cancel-search" onclick="cancelRideSearch()" style="width: 100%;">
                <span>âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨Ø­Ø«</span>
            </button>
        </div>
    </div>
    
    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© -->
    <div id="active-trip-overlay" class="overlay hidden">
        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
    </div>
    
    <!-- Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
    <div id="notification-area"></div>
    
    <!-- Ù…Ù„ÙØ§Øª JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const SB_URL = 'https://zsmlyiygjagmhnglrhoa.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzbWx5aXlnamFnbWhuZ2xyaG9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NDc3NjMsImV4cCI6MjA4MTUyMzc2M30.QviVinAng-ILq0umvI5UZCFEvNpP3nI0kW_hSaXxNps';
        const supabase = supabase.createClient(SB_URL, SB_KEY);
        
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        let currentUser = null;
        let rideMap = null;
        let userMarker = null;
        let destinationMarker = null;
        let userPosition = null;
        let destinationPosition = null;
        let selectedVehicleType = null;
        let selectedVehiclePrice = 0;
        let rideDistance = 0;
        let calculatedPrice = 0;
        let currentRideId = null;
        let searchTimer = 40;
        let searchInterval = null;
        let searchingDrivers = [];
        let currentSearchIndex = 0;
        
        // Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ÙØ¦Ø§Øª
        const VEHICLE_PRICES = {
            tuktuk: { base: 5000, perKm: 2000 },
            economy: { base: 6000, perKm: 3000 },
            comfort: { base: 7000, perKm: 3500 },
            vip: { base: 10000, perKm: 5000 }
        };
        
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            initMap();
        });
        
        async function checkAuth() {
            const savedUser = localStorage.getItem('tarhal_customer');
            
            if (!savedUser) {
                window.location.href = 'index.html';
                return;
            }
            
            currentUser = JSON.parse(savedUser);
        }
        
        function initMap() {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
            rideMap = L.map('ride-map').setView([15.5007, 32.5599], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(rideMap);
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    userPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    rideMap.setView([userPosition.lat, userPosition.lng], 15);
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
                    userMarker = L.marker([userPosition.lat, userPosition.lng], {
                        icon: L.divIcon({
                            html: '<div style="background: var(--primary); width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"></div>',
                            className: 'user-marker'
                        })
                    })
                    .addTo(rideMap)
                    .bindPopup('Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ')
                    .openPopup();
                    
                    // ØªØ­Ø¯ÙŠØ« Ø­Ù‚Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                    reverseGeocode(userPosition.lat, userPosition.lng, 'current');
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                    rideMap.on('click', (e) => {
                        setDestination(e.latlng.lat, e.latlng.lng);
                    });
                    
                }, (error) => {
                    console.error('Geolocation error:', error);
                    showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹', 'warning');
                    
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙˆÙ‚Ø¹ Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø§Ù„Ø®Ø±Ø·ÙˆÙ…)
                    userPosition = { lat: 15.5007, lng: 32.5599 };
                    rideMap.setView([15.5007, 32.5599], 12);
                });
            }
        }
        
        function setDestination(lat, lng) {
            destinationPosition = { lat, lng };
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ù‚Ù„ Ø§Ù„ÙˆØ¬Ù‡Ø©
            reverseGeocode(lat, lng, 'destination');
            
            if (destinationMarker) {
                destinationMarker.setLatLng([lat, lng]);
            } else {
                destinationMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        html: '<div style="background: var(--danger); width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"></div>',
                        className: 'destination-marker'
                    })
                })
                .addTo(rideMap)
                .bindPopup('Ø§Ù„ÙˆØ¬Ù‡Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©')
                .openPopup();
            }
            
            // Ø±Ø³Ù… Ø®Ø· Ø¨ÙŠÙ† Ø§Ù„Ù†Ù‚Ø·ØªÙŠÙ†
            if (userMarker && destinationMarker) {
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ø· Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ ÙˆØ¬Ø¯
                if (window.ridePolyline) {
                    rideMap.removeLayer(window.ridePolyline);
                }
                
                window.ridePolyline = L.polyline([
                    [userPosition.lat, userPosition.lng],
                    [lat, lng]
                ], {
                    color: var(--primary),
                    weight: 3,
                    opacity: 0.7,
                    dashArray: '10, 10'
                }).addTo(rideMap);
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ§Ù„Ø³Ø¹Ø±
                calculateDistanceAndPrice();
            }
        }
        
        async function reverseGeocode(lat, lng, field) {
            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø© Nominatim Ù„Ù„Ø¹ÙƒØ³ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=ar`
                );
                
                const data = await response.json();
                let displayName = 'Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                
                if (data.display_name) {
                    // ØªÙ‚Ù„ÙŠÙ„ Ø·ÙˆÙ„ Ø§Ù„Ø§Ø³Ù… Ù„Ù„Ø¹Ø±Ø¶
                    const parts = data.display_name.split(',');
                    displayName = parts.slice(0, 3).join(',');
                }
                
                if (field === 'current') {
                    document.getElementById('current-location').value = displayName;
                } else if (field === 'destination') {
                    document.getElementById('destination-input').value = displayName;
                }
                
            } catch (error) {
                console.error('Reverse geocode error:', error);
            }
        }
        
        function calculateDistanceAndPrice() {
            if (!userPosition || !destinationPosition || !selectedVehicleType) return;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© (ØªÙ‚Ø±ÙŠØ¨ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙŠØºØ© Ù‡Ø§ÙØ±Ø³Ø§ÙŠÙ†)
            const R = 6371; // Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø£Ø±Ø¶ Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª
            const lat1 = userPosition.lat * Math.PI / 180;
            const lat2 = destinationPosition.lat * Math.PI / 180;
            const deltaLat = (destinationPosition.lat - userPosition.lat) * Math.PI / 180;
            const deltaLng = (destinationPosition.lng - userPosition.lng) * Math.PI / 180;
            
            const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                    Math.cos(lat1) * Math.cos(lat2) *
                    Math.sin(deltaLng/2) * Math.sin(deltaLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            rideDistance = R * c;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø±
            const vehiclePrice = VEHICLE_PRICES[selectedVehicleType];
            const additionalKm = Math.max(0, rideDistance - 1);
            calculatedPrice = vehiclePrice.base + (additionalKm * vehiclePrice.perKm);
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø³Ø§Ø¨
            const priceCalc = document.getElementById('price-calculation');
            priceCalc.classList.add('show');
            
            document.getElementById('distance-value').textContent = rideDistance.toFixed(1);
            document.getElementById('final-price').textContent = `${calculatedPrice.toLocaleString()} SDG`;
            
            // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯
            document.getElementById('confirm-btn').disabled = false;
        }
        
        function selectVehicle(type) {
            selectedVehicleType = type;
            selectedVehiclePrice = VEHICLE_PRICES[type].base;
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
            document.querySelectorAll('.vehicle-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù„Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±
            event.currentTarget.classList.add('selected');
            
            if (destinationPosition) {
                calculateDistanceAndPrice();
            }
        }
        
        async function confirmRideRequest() {
            if (!selectedVehicleType || !destinationPosition || !userPosition) {
                showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø© ÙˆØ§Ø®ØªÙŠØ§Ø± ÙØ¦Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©', 'warning');
                return;
            }
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø­Ø«
            document.getElementById('searching-overlay').classList.remove('hidden');
            
            try {
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù‚Ø±ÙŠØ¨ÙŠÙ†
                const { data: nearbyDrivers, error } = await supabase.rpc('search_nearby_drivers_by_type', {
                    user_lat: userPosition.lat,
                    user_lng: userPosition.lng,
                    radius_meters: 20000,
                    car_type: selectedVehicleType
                });
                
                if (error || !nearbyDrivers || nearbyDrivers.length === 0) {
                    showNotification('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…ØªØ§Ø­ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹', 'warning');
                    cancelRideSearch();
                    return;
                }
                
                searchingDrivers = nearbyDrivers;
                currentSearchIndex = 0;
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø©
                const { data: ride, error: rideError } = await supabase
                    .from('rides')
                    .insert([{
                        customer_id: currentUser.id,
                        customer_name: currentUser.full_name,
                        customer_phone: currentUser.phone,
                        customer_phone2: currentUser.phone2,
                        pickup_lat: userPosition.lat,
                        pickup_lng: userPosition.lng,
                        destination_lat: destinationPosition.lat,
                        destination_lng: destinationPosition.lng,
                        distance_km: rideDistance,
                        vehicle_type: selectedVehicleType,
                        amount: calculatedPrice,
                        status: 'searching',
                        created_at: new Date()
                    }])
                    .select()
                    .single();
                
                if (rideError) throw rideError;
                
                currentRideId = ride.id;
                
                // Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚
                startDriverSearch();
                
            } catch (error) {
                console.error('Ride request error:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø©', 'error');
                cancelRideSearch();
            }
        }
        
        function startDriverSearch() {
            // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
            searchTimer = 40;
            const timerElement = document.getElementById('searching-timer');
            timerElement.textContent = searchTimer;
            
            searchInterval = setInterval(() => {
                searchTimer--;
                timerElement.textContent = searchTimer;
                
                if (searchTimer <= 0) {
                    clearInterval(searchInterval);
                    
                    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„ØªØ§Ù„ÙŠ Ø£Ùˆ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«
                    currentSearchIndex++;
                    if (currentSearchIndex < searchingDrivers.length) {
                        searchTimer = 40;
                        searchNextDriver();
                    } else {
                        endDriverSearch();
                    }
                }
            }, 1000);
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø£ÙˆÙ„
            searchNextDriver();
        }
        
        function searchNextDriver() {
            if (currentSearchIndex >= searchingDrivers.length) {
                endDriverSearch();
                return;
            }
            
            const driver = searchingDrivers[currentSearchIndex];
            
            // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚
            const driverInfo = document.getElementById('searching-driver-info');
            driverInfo.style.display = 'block';
            
            document.getElementById('driver-name-display').textContent = driver.full_name;
            document.getElementById('driver-car-display').textContent = `${driver.car_model} - ${getVehicleTypeName(driver.car_type)}`;
            document.getElementById('driver-distance').textContent = `Ø¹Ù„Ù‰ Ø¨Ø¹Ø¯ ${Math.round(driver.distance)} Ù…ØªØ±`;
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø© Ù„Ù„Ø³Ø§Ø¦Ù‚ (Ù…Ø­Ø§ÙƒØ§Ø©)
            sendRideRequestToDriver(driver);
        }
        
        function sendRideRequestToDriver(driver) {
            // ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ù‡Ù†Ø§ Ù†Ø±Ø³Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¯ÙØ¹ Ù„Ù„Ø³Ø§Ø¦Ù‚
            // Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©ØŒ Ø³Ù†Ù†ØªØ¸Ø± 5-15 Ø«Ø§Ù†ÙŠØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹
            const waitTime = Math.random() * 10000 + 5000;
            
            setTimeout(() => {
                if (searchTimer > 0) {
                    // Ù…Ø­Ø§ÙƒØ§Ø© Ø±ÙØ¶ Ø§Ù„Ø³Ø§Ø¦Ù‚
                    currentSearchIndex++;
                    searchNextDriver();
                }
            }, waitTime);
        }
        
        function endDriverSearch() {
            clearInterval(searchInterval);
            
            if (currentSearchIndex >= searchingDrivers.length) {
                showNotification('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø§Ø¦Ù‚ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹', 'warning');
                cancelRideSearch();
                
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø©
                updateRideStatus('no_driver_found');
            }
        }
        
        async function updateRideStatus(status) {
            if (!currentRideId) return;
            
            try {
                await supabase
                    .from('rides')
                    .update({ status: status })
                    .eq('id', currentRideId);
            } catch (error) {
                console.error('Update ride status error:', error);
            }
        }
        
        function cancelRideSearch() {
            clearInterval(searchInterval);
            document.getElementById('searching-overlay').classList.add('hidden');
            
            if (currentRideId) {
                updateRideStatus('cancelled');
            }
        }
        
        function getVehicleTypeName(type) {
            const names = {
                tuktuk: 'Ø±ÙƒØ´Ø©',
                economy: 'Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©',
                comfort: 'Ù…ØªÙˆØ³Ø·Ø©',
                vip: 'VIP'
            };
            return names[type] || type;
        }
        
        function goBack() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø© ÙˆØ§Ù„Ø¹ÙˆØ¯Ø©ØŸ')) {
                window.location.href = 'home.html';
            }
        }
        
        function showNotification(message, type = 'info') {
            const notificationArea = document.getElementById('notification-area');
            
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                padding: 15px 20px;
                border-radius: 12px;
                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                z-index: 99999;
                animation: slideInRight 0.5s ease;
                border-right: 5px solid ${colors[type] || colors.info};
                max-width: 300px;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 24px;">
                        ${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸'}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; margin-bottom: 5px; color: #1f2937;">
                            ${type === 'success' ? 'Ù†Ø¬Ø§Ø­' : type === 'error' ? 'Ø®Ø·Ø£' : type === 'warning' ? 'ØªØ­Ø°ÙŠØ±' : 'Ù…Ø¹Ù„ÙˆÙ…Ø©'}
                        </div>
                        <div style="color: #4b5563; font-size: 14px;">${message}</div>
                    </div>
                </div>
            `;
            
            notificationArea.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.5s ease reverse';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ุชุฑุญุงู ุงูุณูุฏุงู - Tarhal</title>
    
    <!-- ุฅุนุฏุงุฏุงุช PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <link rel="icon" href="data:,"> 

    <!-- ููุชุจุงุช ุฎุงุฑุฌูุฉ -->
    <script src="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- ุฎุท Tajawal -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- ูููุงุช ุงูุชุทุจูู -->
    <link rel="stylesheet" href="css/main.css">
</head>
<body>

    <!-- ุดุงุดุฉ ุงุฎุชูุงุฑ ููุน ุงูุญุณุงุจ -->
    <div id="welcome-screen" class="container">
        <div class="welcome-card">
            <div class="logo-container">
                <div class="logo">๐</div>
                <h1>ุชุฑุญุงู ุงูุณูุฏุงู</h1>
                <p class="tagline">ุฑุญูุชู ุงูุขููุฉ ุจูู ูุฏูู</p>
            </div>
            
            <div class="welcome-buttons">
                <button class="btn btn-primary btn-large" onclick="showSection('customer-login')">
                    <span>๐ค ุฏุฎูู ุทุงูุจ ุฑุญูุฉ</span>
                </button>
                
                <button class="btn btn-driver btn-large" onclick="showSection('driver-login')">
                    <span>๐ ุฏุฎูู ุณุงุฆู</span>
                </button>
            </div>
            
            <div class="staff-access">
                <small>ูููุตูู ุฅูู ููุญุฉ ุงูุชุญูู: <a href="#" onclick="showStaffAccess()">ุงุถุบุท ููุง</a></small>
            </div>
        </div>
    </div>

    <!-- ุดุงุดุฉ ุชุณุฌูู ุงูุฏุฎูู ููุฒุจูู -->
    <div id="customer-login" class="container hidden">
        <div class="card">
            <div class="card-header">
                <h2>๐ค ุชุณุฌูู ุฏุฎูู ุทุงูุจ ุฑุญูุฉ</h2>
                <p>ุฃุฏุฎู ุฑูู ุงููุงุชุณุงุจ ููููุฉ ุงููุฑูุฑ</p>
            </div>
            
            <div class="form-group">
                <input type="tel" id="customer-login-phone" placeholder="ุฑูู ุงููุงุชุณุงุจ" required>
            </div>
            
            <div class="form-group">
                <input type="password" id="customer-login-password" placeholder="ูููุฉ ุงููุฑูุฑ" required>
            </div>
            
            <button class="btn btn-primary" onclick="loginCustomer()">
                <span>๐ ุชุณุฌูู ุงูุฏุฎูู</span>
            </button>
            
            <div class="divider">
                <span>ุฃู</span>
            </div>
            
            <button class="btn btn-secondary" onclick="showSection('customer-register')">
                <span>๐ ููุณ ูุฏูู ุญุณุงุจุ ุณุฌู ุญุณุงุจ ุงูุขู</span>
            </button>
            
            <button class="btn btn-back" onclick="showSection('welcome-screen')">
                <span>โฉ๏ธ ุงูุนูุฏุฉ</span>
            </button>
        </div>
    </div>

    <!-- ุดุงุดุฉ ุชุณุฌูู ุฒุจูู ุฌุฏูุฏ -->
    <div id="customer-register" class="container hidden">
        <div class="card">
            <div class="card-header">
                <h2>๐ ุชุณุฌูู ุญุณุงุจ ุฌุฏูุฏ</h2>
                <p>ุงููุฃ ุงูุจูุงูุงุช ุงูุชุงููุฉ ูุฅูุดุงุก ุญุณุงุจ</p>
            </div>
            
            <div id="registration-form">
                <div class="form-group">
                    <input type="text" id="fullname" placeholder="ุงูุงุณู ุงูุฑุจุงุนู" required>
                </div>
                
                <div class="form-group">
                    <input type="tel" id="phone" placeholder="ุฑูู ุงููุงุชุณุงุจ" required>
                </div>
                
                <div class="form-group">
                    <input type="tel" id="phone2" placeholder="ุฑูู ุฅุถุงูู (ุงุฎุชูุงุฑู)">
                </div>
                
                <div class="form-group">
                    <input type="password" id="password" placeholder="ูููุฉ ุงููุฑูุฑ" required>
                </div>
                
                <button class="btn btn-primary" id="btn-register" onclick="handleRegister()">
                    <span>โ ุชุณุฌูู ุญุณุงุจ ุฌุฏูุฏ</span>
                </button>
            </div>
            
            <div id="verification-section" class="hidden" style="margin-top: 20px;">
                <div class="success-message">
                    <p>โ ุชู ุญูุธ ุจูุงูุงุชู ุจูุฌุงุญ!</p>
                    <p class="small">ุงุถุบุท ุฃุฏูุงู ููุชูุนูู ุนุจุฑ ูุงุชุณุงุจ ุงูุฅุฏุงุฑุฉ:</p>
                </div>
                <button class="btn btn-whatsapp" id="btn-verify" onclick="sendWhatsAppMessage()">
                    <span>๐ฌ ุชุฃููุฏ ุงูุญุณุงุจ ุนุจุฑ ุฑูู ูุงุชุณุงุจ</span>
                </button>
                
                <div class="note">
                    <small>ุจุนุฏ ุฅุฑุณุงู ุฑุณุงูุฉ ุงูุชูุนููุ ุณุชุตูู ุฑุณุงูุฉ ุชุฃููุฏ ุฎูุงู ุฏูุงุฆู</small>
                </div>
            </div>
            
            <button class="btn btn-back" onclick="showSection('customer-login')">
                <span>โฉ๏ธ ุงูุนูุฏุฉ ูุชุณุฌูู ุงูุฏุฎูู</span>
            </button>
        </div>
    </div>

    <!-- ุดุงุดุฉ ุชุณุฌูู ุงูุฏุฎูู ููุณุงุฆู -->
    <div id="driver-login" class="container hidden">
        <div class="card">
            <div class="card-header">
                <h2>๐ ุชุณุฌูู ุฏุฎูู ุงูุณุงุฆู</h2>
                <p>ุฃุฏุฎู ุฑูู ุงููุงุชุณุงุจ ููููุฉ ุงููุฑูุฑ</p>
            </div>
            
            <div class="form-group">
                <input type="tel" id="driver-login-phone" placeholder="ุฑูู ุงููุงุชุณุงุจ" required>
            </div>
            
            <div class="form-group">
                <input type="password" id="driver-login-password" placeholder="ูููุฉ ุงููุฑูุฑ" required>
            </div>
            
            <button class="btn btn-driver" onclick="loginDriver()">
                <span>๐ ุฏุฎูู ุงูุณุงุฆู</span>
            </button>
            
            <div class="divider">
                <span>ุฃู</span>
            </div>
            
            <button class="btn btn-secondary" onclick="openDriverRegistrationWhatsApp()">
                <span>๐ ููุณ ูุฏูู ุญุณุงุจ ุณุงุฆูุ ุณุฌู ูุณุงุฆู ุงูุขู</span>
            </button>
            
            <button class="btn btn-back" onclick="showSection('welcome-screen')">
                <span>โฉ๏ธ ุงูุนูุฏุฉ</span>
            </button>
        </div>
    </div>

    <!-- ุจุงูู ุงูุฃูุณุงู ููุง ูู ูู ุงูููุฏ ุงูุฃุตูู (Home Screen, Ride Request, Driver Dashboard, etc.) -->
    <!-- ุณูุชู ููููุง ุฅูู ูููุงุช ูููุตูุฉ -->
    <div id="home-screen" class="container hidden"></div>
    <div id="ride-request" class="container hidden"></div>
    <div id="driver-dashboard" class="container hidden"></div>
    <div id="active-trip-overlay" class="overlay hidden"></div>
    <div id="incoming-ride-overlay" class="overlay hidden"></div>

    <!-- ูุงูุฐุฉ ุฑูุฒ ุงูุชุญูู ููููุธููู -->
    <div id="staff-passcode-modal" class="overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3>๐ ุฏุฎูู ููุญุฉ ุงูุชุญูู</h3>
                <p>ุฃุฏุฎู ุฑูุฒ ุงูุชุญูู ูููุตูู ุฅูู ููุญุฉ ุงูุฅุฏุงุฑุฉ</p>
            </div>
            
            <div class="form-group">
                <input type="password" id="staff-passcode" placeholder="ูููุฉ ุงููุฑูุฑ" autocomplete="off">
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="verifyStaffPasscode()">
                    <span>โ ุชุฃููุฏ ุงูุฏุฎูู</span>
                </button>
                <button class="btn btn-back" onclick="closeStaffPasscodeModal()">
                    <span>โฉ๏ธ ุฅูุบุงุก</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ููุทูุฉ ุงูุฅุดุนุงุฑุงุช -->
    <div id="notification-area"></div>

    <!-- ูููุงุช JavaScript -->
    <script>
        // ุฅุนุฏุงุฏุงุช Supabase
        const SB_URL = 'https://zsmlyiygjagmhnglrhoa.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzbWx5aXlnamFnbWhuZ2xyaG9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NDc3NjMsImV4cCI6MjA4MTUyMzc2M30.QviVinAng-ILq0umvI5UZCFEvNpP3nI0kW_hSaXxNps';
        const supabase = supabase.createClient(SB_URL, SB_KEY);
        
        // ูุชุบูุฑุงุช ุนุงูุฉ
        let currentUser = null;
        let currentDriver = null;
    </script>
    
    <script src="js/auth.js"></script>
    <script src="js/map.js"></script>
    <script src="js/ride.js"></script>
    <script src="js/driver.js"></script>
    <script src="js/notifications.js"></script>
    
    <script>
        // ุชููุฆุฉ ุงูุชุทุจูู
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });
        
        async function initApp() {
            // ุงูุชุญูู ูู ูุฌูุฏ ูุณุชุฎุฏู ูุณุฌู
            const savedUser = localStorage.getItem('tarhal_customer');
            const savedDriver = localStorage.getItem('tarhal_driver');
            
            if (savedDriver) {
                // ุชุญููู ููุญุฉ ุงูุณุงุฆู
                window.location.href = 'driver-dashboard.html';
            } else if (savedUser) {
                // ุชุญููู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ููุฒุจูู
                window.location.href = 'home.html';
            } else {
                // ุนุฑุถ ุดุงุดุฉ ุงูุชุฑุญูุจ
                showSection('welcome-screen');
            }
        }
        
        // ุฏูุงู ุงูุชููู
        function showSection(sectionId) {
            document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
        }
        
        // ุฏุฎูู ุงูููุธููู
        function showStaffAccess() {
            document.getElementById('staff-passcode-modal').classList.remove('hidden');
        }
        
        function closeStaffPasscodeModal() {
            document.getElementById('staff-passcode-modal').classList.add('hidden');
            document.getElementById('staff-passcode').value = '';
        }
        
        async function verifyStaffPasscode() {
            const passcode = document.getElementById('staff-passcode').value;
            
            try {
                const { data: settings, error } = await supabase
                    .from('system_settings')
                    .select('value')
                    .eq('key', 'staff_passcode')
                    .single();
                
                if (error) throw error;
                
                if (settings && settings.value === passcode) {
                    // ูุชุญ ููุญุฉ ุงูุชุญูู
                    window.location.href = 'admin-panel.html';
                } else {
                    showNotification('ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ', 'error');
                }
            } catch (error) {
                console.error('Error verifying passcode:', error);
                showNotification('ุญุฏุซ ุฎุทุฃ ูู ุงูุชุญูู', 'error');
            }
        }
        
        // ุชุณุฌูู ุงูุณุงุฆู ุงูุฌุฏูุฏ ุนุจุฑ ูุงุชุณุงุจ
        function openDriverRegistrationWhatsApp() {
            const adminNumber = "249XXXXXXXXX"; // ุถุน ุฑูู ูุงุชุณุงุจ ุงูุฅุฏุงุฑุฉ ููุง
            const message = "ูุฑุญุจุงูุ ุฃุฑุบุจ ูู ุงูุชุณุฌูู ูุณุงุฆู ูู ุชุทุจูู ุชุฑุญุงู";
            const whatsappUrl = `https://wa.me/${adminNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }
        
        // ูุธููุฉ ุนุฑุถ ุงูุฅุดุนุงุฑุงุช (ุณูุชู ุชูุตูููุง ูู notifications.js)
        function showNotification(message, type = 'info') {
            // ุณูุชู ุชูุตูู ูุฐู ุงููุธููุฉ ูู ููู notifications.js
            console.log(`${type}: ${message}`);
        }
    </script>
</body>
</html>
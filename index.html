<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ±Ø­Ø§Ù„ Ø²ÙˆÙ†Ø§ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† - Tarhal</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <link rel="icon" href="icons/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- Tajawal Font -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <!-- Ionicons Icons -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    
    <!-- Firebase for Notifications -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --primary-light: #e0e7ff;
            --secondary: #10b981;
            --secondary-dark: #059669;
            --warning: #f59e0b;
            --danger: #ef4444;
            --danger-dark: #dc2626;
            --light: #f9fafb;
            --dark: #111827;
            --gray: #6b7280;
            --gray-light: #e5e7eb;
            
            --driver: #16a34a;
            --tuk-tuk: #059669;
            --economy: #2563eb;
            --comfort: #7c3aed;
            --vip: #d97706;
            --staff: #7c3aed;
            
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --radius: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            overflow: hidden !important;
            max-height: 100vh;
            height: 100vh;
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .app-container {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--light);
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        /* Header - Ù…Ø®ÙØ¶ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ */
        .app-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 12px 16px !important;
            text-align: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 9999 !important;
            border-bottom: 3px solid var(--primary-dark);
            min-height: 65px !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .app-header h1 {
            font-size: 18px !important;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px !important;
        }
        
        .app-header .logo-img {
            width: 45px !important;
            height: 45px !important;
            object-fit: contain;
        }
        
        /* Screens */
        .screen {
            padding: 16px;
            height: calc(100vh - 65px) !important;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-light);
            margin-bottom: 16px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 12px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        /* Buttons */
        .btn {
            padding: 14px 20px;
            border-radius: var(--radius);
            border: none;
            font-family: 'Tajawal', sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .btn:active {
            transform: translateY(2px);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.3);
        }
        
        .btn-secondary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-secondary:hover {
            background: var(--secondary-dark);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }
        
        .btn-driver {
            background: var(--driver);
            color: white;
        }
        
        .btn-driver:hover {
            background: #15803d;
            box-shadow: 0 6px 20px rgba(22, 163, 74, 0.3);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary-light);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: var(--danger-dark);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--dark);
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--gray-light);
            border-radius: var(--radius);
            font-family: 'Tajawal', sans-serif;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .form-input::placeholder {
            color: var(--gray);
        }
        
        /* Welcome Screen */
        .welcome-card {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, #e0e7ff 0%, #ede9fe 100%);
            border: none;
            margin-top: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .welcome-icon {
            font-size: 56px;
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        .welcome-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .welcome-subtitle {
            color: var(--gray);
            font-size: 15px;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .role-selection {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .role-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            text-align: right;
        }
        
        .role-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
        }
        
        .role-icon {
            font-size: 28px;
            color: var(--primary);
        }
        
        .role-info h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--dark);
        }
        
        .role-info p {
            font-size: 13px;
            color: var(--gray);
            line-height: 1.5;
        }
        
        /* Login Screens */
        .login-form {
            max-width: 400px;
            margin: 0 auto;
            width: 100%;
        }
        
        .form-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--gray-light);
        }
        
        .form-footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .form-footer .register-text {
            margin-bottom: 16px;
        }
        
        .form-footer .register-text a {
            display: inline;
        }
        
        .form-footer .back-link {
            display: inline-flex;
            justify-content: center;
            margin-top: 8px;
            padding: 8px 14px;
            border-radius: 12px;
            background: #f1f2ff;
            font-size: 13px;
        }
        
        .form-footer a:hover {
            text-decoration: underline;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: white;
            border-radius: var(--radius);
            padding: 14px;
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            border-right: 4px solid var(--primary);
            animation: slideIn 0.3s ease;
            max-width: 500px;
            margin: 0 auto;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .notification-icon {
            font-size: 22px;
        }
        
        .notification-success {
            border-right-color: var(--secondary);
        }
        
        .notification-error {
            border-right-color: var(--danger);
        }
        
        .notification-warning {
            border-right-color: var(--warning);
        }
        
        /* Overlay Modals */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal {
            background: white;
            border-radius: var(--radius-xl);
            padding: 28px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.4s ease;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(40px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 22px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .modal-subtitle {
            color: var(--gray);
            font-size: 15px;
        }
        
        /* Home Screen */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 24px;
        }
        
        .user-avatar {
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
            font-weight: 700;
        }
        
        .user-info h3 {
            font-size: 17px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--dark);
        }
        
        .user-info p {
            color: var(--gray);
            font-size: 13px;
        }
        
        .verified-badge {
            background: var(--secondary);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .home-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
            flex: 1;
            max-height: 300px;
        }
        
        .action-card {
            background: white;
            border-radius: var(--radius);
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid var(--gray-light);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 100px;
        }
        
        .action-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
            border-color: var(--primary-light);
        }
        
        .action-icon {
            font-size: 28px;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .action-card h4 {
            font-size: 15px;
            font-weight: 700;
            color: var(--dark);
        }
        
        /* Ride Request */
        .map-wrapper {
            position: relative;
            margin-bottom: 20px;
            border-radius: var(--radius);
            overflow: hidden;
            border: 2px solid var(--gray-light);
            height: 180px !important;
        }
        
        .map-container {
            width: 100%;
            height: 180px !important;
            border-radius: var(--radius);
            overflow: hidden;
            position: relative;
        }
        
        .map-controls {
            position: absolute;
            bottom: 12px;
            right: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }
        
        .map-control-btn {
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid var(--gray-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            color: var(--primary);
            font-size: 18px;
        }
        
        .map-control-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary);
            transform: scale(1.05);
        }
        
        .map-control-btn:active {
            transform: scale(0.95);
        }
        
        .vehicle-options {
            display: flex !important;
            overflow-x: auto !important;
            flex-wrap: nowrap !important;
            gap: 8px !important;
            padding-bottom: 8px !important;
            margin-bottom: 20px !important;
        }
        
        .vehicle-option {
            border: 2px solid var(--gray-light);
            border-radius: var(--radius);
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-width: 90px !important;
            flex-shrink: 0 !important;
        }
        
        .vehicle-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .vehicle-option.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }
        
        .vehicle-icon {
            font-size: 22px;
            margin-bottom: 6px;
        }
        
        .vehicle-name {
            font-weight: 700;
            margin-bottom: 4px;
            font-size: 13px;
        }
        
        .vehicle-price {
            color: var(--primary);
            font-weight: 800;
            font-size: 15px;
            direction: ltr;
            text-align: center;
        }
        
        .price-breakdown {
            background: var(--light);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .price-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--gray-light);
            font-size: 14px;
        }
        
        .price-row:last-child {
            border-bottom: none;
            font-weight: 800;
            font-size: 18px;
            color: var(--primary);
            direction: ltr;
            text-align: left;
        }
        
        /* Driver Dashboard */
        .driver-status {
            background: var(--light);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .status-offline {
            background: #fee2e2;
            color: var(--danger);
        }
        
        .status-online {
            background: #dcfce7;
            color: var(--secondary-dark);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-offline .status-dot {
            background: var(--danger);
        }
        
        .status-online .status-dot {
            background: var(--secondary);
        }
        
        .driver-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 14px;
            text-align: center;
            border: 1px solid var(--gray-light);
        }
        
        .stat-value {
            font-size: 22px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 11px;
            color: var(--gray);
        }
        
        /* Responsive */
        @media (max-width: 480px) {
            .screen {
                padding: 14px;
            }
            
            .card {
                padding: 16px;
            }
            
            .home-actions {
                grid-template-columns: 1fr;
            }
            
            .vehicle-option {
                min-width: 85px !important;
            }
        }
        
        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Utility Classes */
        .text-center { text-align: center; }
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 12px; }
        .mb-3 { margin-bottom: 16px; }
        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 12px; }
        .mt-3 { margin-top: 16px; }
        .p-1 { padding: 8px; }
        .p-2 { padding: 12px; }
        .p-3 { padding: 16px; }
        
        /* PWA Install Prompt */
        #pwa-install-prompt {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: white;
            padding: 14px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideUp 0.3s ease;
        }
        
        .pwa-mode .app-header {
            padding-top: env(safe-area-inset-top, 12px);
        }
        
        .app-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* In-app Notification */
        .in-app-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            left: 20px;
            background: white;
            border-radius: 12px;
            padding: 14px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 9999;
            animation: slideDown 0.3s ease;
            border-right: 4px solid #4f46e5;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
            margin: 0 auto;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Notification Activation Modal */
        #notification-activation-prompt {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 99999;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        
        /* Sound Control */
        .sound-control-panel {
            position: fixed;
            bottom: 80px;
            left: 20px;
            z-index: 1000;
        }
        
        #volume-slider {
            display: none;
            margin-top: 8px;
            background: white;
            padding: 8px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        /* Splash Screen */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            animation: fadeIn 0.5s ease;
        }
        
        .splash-logo {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            animation: pulse 1.5s infinite;
        }
        
        .splash-title {
            color: white;
            font-size: 26px;
            margin-bottom: 10px;
            font-weight: 800;
        }
        
        .splash-subtitle {
            color: rgba(255,255,255,0.9);
            font-size: 15px;
            margin-bottom: 30px;
        }
        
        .splash-progress-container {
            width: 120px;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .splash-progress {
            height: 100%;
            background: white;
            width: 0%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© */
        .leaflet-pane.leaflet-marker-pane,
        .leaflet-pane.leaflet-shadow-pane {
            display: none !important;
        }
        
        /* Location Loading */
        .location-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 16px 20px;
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            box-shadow: var(--shadow-xl);
            text-align: center;
            max-width: 280px;
            width: 90%;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -40%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }
        
        .location-loading .loading {
            width: 25px;
            height: 25px;
            border: 3px solid var(--primary-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .user-marker, .destination-marker {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* ØªØ­Ø³ÙŠÙ† ØªØ®Ø·ÙŠØ· Ø§Ù„Ø´Ø§Ø´Ø§Øª */
        .screen-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 10px;
        }
        
        /* Ride Request Screen - Ù…Ø­ØªÙˆÙ‰ Ù…ØµØºØ± */
        #ride-request-screen .card {
            padding: 16px;
        }
        
        #ride-request-screen .card-title {
            margin-bottom: 12px;
            font-size: 17px;
        }
        
        #ride-request-screen .mb-3 {
            margin-bottom: 12px !important;
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div id="splash-screen">
        <img src="icons/icon-512x512.png" alt="ØªØ±Ø­Ø§Ù„ Ø²ÙˆÙ†Ø§" class="splash-logo">
        <h1 class="splash-title">ØªØ±Ø­Ù€Ù€Ø§Ù„ Ø²ÙˆÙ†Ù€Ù€Ø§</h1>
        <p class="splash-subtitle">Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ø£ÙˆÙ„ ÙÙŠ Ø§Ù„Ø³ÙˆØ¯Ø§Ù†</p>
        <div class="splash-progress-container">
            <div class="splash-progress" id="splash-progress"></div>
        </div>
    </div>
    
    <!-- Notification Activation Modal (Dynamic) -->
    <div id="notification-activation-modal"></div>
    
    <!-- Sound Control Panel -->
    <div class="sound-control-panel">
        <button id="sound-toggle" onclick="toggleAppSound()" 
                style="width: 45px; height: 45px; border-radius: 50%; 
                       background: #4f46e5; border: none; color: white;
                       display: flex; align-items: center; justify-content: center;
                       cursor: pointer; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);">
            <ion-icon name="volume-high" id="sound-icon" style="font-size: 22px;"></ion-icon>
        </button>
        
        <div id="volume-slider">
            <input type="range" min="0" max="100" value="70" 
                   oninput="changeVolume(this.value)" style="width: 100%;">
        </div>
    </div>
    
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <h1 class="app-title">
                <img 
                    src="icons/icon-512x512.png" 
                    alt="ØªØ±Ø­Ø§Ù„ Ø²ÙˆÙ†Ø§ Ø§Ù„Ø³ÙˆØ¯Ø§Ù†" 
                    class="logo-img"
                >
                ØªØ±Ø­Ù€Ù€Ø§Ù„ Ø²ÙˆÙ†Ù€Ù€Ø§
            </h1>
        </header>
        
        <!-- Welcome Screen -->
        <section id="welcome-screen" class="screen">
            <div class="welcome-card card">
                <h1 class="welcome-title">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ØªØ±Ø­Ø§Ù„ Ø²ÙˆÙ†Ø§</h1>
                <p class="welcome-subtitle">
                    ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ø£ÙˆÙ„ ÙÙŠ Ø§Ù„Ø³ÙˆØ¯Ø§Ù†. Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„Ø¨Ø¯Ø¡
                </p>
                
                <div class="role-selection">
                    <!-- Ø·Ø§Ù„Ø¨ Ø±Ø­Ù„Ø© -->
                    <div class="role-card" onclick="showCustomerLogin()">
                        <div class="role-icon">
                            <i class="fa-solid fa-user"></i>
                        </div>
                        <div class="role-info">
                            <h3>Ø·Ø§Ù„Ø¨ Ø±Ø­Ù„Ø©</h3>
                            <p>Ø§Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆØ£Ù…Ø§Ù† Ù…Ù† Ø£Ù‚Ø±Ø¨ Ø³Ø§Ø¦Ù‚ Ù„Ùƒ</p>
                        </div>
                        <ion-icon name="chevron-forward-outline"></ion-icon>
                    </div>

                    <!-- Ø³Ø§Ø¦Ù‚ -->
                    <div class="role-card" onclick="showDriverLogin()">
                        <div class="role-icon">
                            <i class="fa-solid fa-car"></i>
                        </div>
                        <div class="role-info">
                            <h3>Ø³Ø§Ø¦Ù‚</h3>
                            <p>Ø§Ù†Ø¶Ù… ÙƒØ³Ø§Ø¦Ù‚ ÙˆØ§Ø¨Ø¯Ø£ ÙƒØ³Ø¨ Ø§Ù„Ù…Ø§Ù„ Ù…Ø¹ ØªØ±Ø­Ø§Ù„ Ø²ÙˆÙ†Ø§</p>
                        </div>
                        <ion-icon name="chevron-forward-outline"></ion-icon>
                    </div>

                    <div class="form-footer mt-3">
                        <a href="/admin-login.html">
                            <ion-icon name="shield-checkmark-outline"></ion-icon>
                            Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
                        </a>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Customer Login -->
        <section id="customer-login-screen" class="screen hidden">
            <div class="screen-content">
                <div class="card">
                    <h2 class="card-title">
                        <ion-icon name="person-circle-outline"></ion-icon>
                        Ø¯Ø®ÙˆÙ„ Ø·Ø§Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø©
                    </h2>
                    
                    <form class="login-form" id="customerLoginForm">
                        <div class="form-group">
                            <label class="form-label" for="customer-phone">Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</label>
                            <input type="tel" id="customer-phone" class="form-input" 
                                   placeholder="Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="customer-password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                            <input type="password" id="customer-password" class="form-input" 
                                   placeholder="Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="loginCustomer()">
                            <ion-icon name="log-in-outline"></ion-icon>
                            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                        </button>
                    </form>
                    
                    <div class="form-footer">
                        <p class="register-text">
                            Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ
                            <a href="#" onclick="showCustomerRegister()">Ø³Ø¬Ù„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¢Ù†</a>
                        </p>

                        <a href="#" class="back-link" onclick="showWelcomeScreen()">
                            <ion-icon name="arrow-back-outline"></ion-icon>
                            Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø®ÙŠØ§Ø±Ø§Øª
                        </a>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Customer Registration -->
        <section id="customer-register-screen" class="screen hidden">
            <div class="screen-content">
                <div class="card">
                    <h2 class="card-title">
                        <ion-icon name="person-add-outline"></ion-icon>
                        ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
                    </h2>
                    
                    <form class="login-form" id="customerRegisterForm">
                        <div class="form-group">
                            <label class="form-label" for="register-fullname">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ</label>
                            <input type="text" id="register-fullname" class="form-input" 
                                   placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="register-phone">Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</label>
                            <input type="tel" id="register-phone" class="form-input" 
                                   placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Ù„Ù„ØªØ³Ø¬ÙŠÙ„)" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="register-phone2">Ø±Ù‚Ù… Ø¥Ø¶Ø§ÙÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                            <input type="tel" id="register-phone2" class="form-input" 
                                   placeholder="Ø±Ù‚Ù… Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ØªÙˆØ§ØµÙ„">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="register-password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                            <input type="password" id="register-password" class="form-input" 
                                   placeholder="Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ©" required>
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="registerCustomer()">
                            <ion-icon name="create-outline"></ion-icon>
                            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨
                        </button>
                    </form>
                    
                    <div id="verification-section" class="hidden mt-3">
                        <div class="card" style="background: #f0f9ff; border: 2px dashed var(--secondary);">
                            <h3 class="mb-2" style="color: var(--secondary);">
                                <ion-icon name="checkmark-circle-outline"></ion-icon>
                                ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!
                            </h3>
                            <p class="mb-2">Ù„ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨ÙƒØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯:</p>
                            
                            <button type="button" class="btn btn-secondary" onclick="sendVerificationWhatsApp()">
                                <ion-icon name="logo-whatsapp"></ion-icon>
                                ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
                            </button>
                            
                            <p class="mt-2" style="font-size: 14px; color: var(--gray);">
                                Ø¨Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŒ Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø®Ù„Ø§Ù„ Ø¯Ù‚Ø§Ø¦Ù‚
                            </p>
                        </div>
                    </div>
                    
                    <div class="form-footer mt-3">
                        <a href="#" onclick="showCustomerLogin()">
                            <ion-icon name="arrow-back-outline"></ion-icon>
                            Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                        </a>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Driver Login -->
        <section id="driver-login-screen" class="screen hidden">
            <div class="screen-content">
                <div class="card">
                    <h2 class="card-title">
                        <ion-icon name="car-sport-outline"></ion-icon>
                        Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†
                    </h2>
                    
                    <form class="login-form" id="driverLoginForm">
                        <div class="form-group">
                            <label class="form-label" for="driver-phone">Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¦Ù‚</label>
                            <input type="tel" id="driver-phone" class="form-input" 
                                   placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="driver-password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                            <input type="password" id="driver-password" class="form-input" 
                                   placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø³Ø§Ø¦Ù‚" required>
                        </div>
                        
                        <button type="button" class="btn btn-driver" onclick="loginDriver()">
                            <ion-icon name="log-in-outline"></ion-icon>
                            Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚
                        </button>
                    </form>
                    
                    <div class="form-footer">
                        <p>Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø³Ø§Ø¦Ù‚ØŸ 
                            <a href="#" onclick="showDriverRegisterInfo()">Ø³Ø¬Ù„ ÙƒØ³Ø§Ø¦Ù‚ Ø§Ù„Ø¢Ù†</a>
                        </p>
                        <a href="#" onclick="showWelcomeScreen()">
                            <ion-icon name="arrow-back-outline"></ion-icon>
                            Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø®ÙŠØ§Ø±Ø§Øª
                        </a>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Driver Registration Info -->
        <section id="driver-register-info-screen" class="screen hidden">
            <div class="screen-content">
                <div class="card">
                    <h2 class="card-title">
                        <ion-icon name="information-circle-outline"></ion-icon>
                        Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙƒØ³Ø§Ø¦Ù‚
                    </h2>
                    
                    <div class="mb-3">
                        <p>Ù„Ù„ØªØ³Ø¬ÙŠÙ„ ÙƒØ³Ø§Ø¦Ù‚ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ ØªØ±Ø­Ø§Ù„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø¥Ø¯Ø§Ø±ØªÙ†Ø§ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</p>
                        
                        <div class="p-3" style="background: #f0f9ff; border-radius: var(--radius); margin: 20px 0;">
                            <h4 class="mb-2" style="color: var(--primary);">Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</h4>
                            <ul style="padding-right: 20px; line-height: 1.8;">
                                <li>Ø±Ø®ØµØ© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ø§Ø±ÙŠØ©</li>
                                <li>Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</li>
                                <li>ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ©</li>
                                <li>ØµÙˆØ±Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø±Ø¬</li>
                                <li>ØµÙˆØ±Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</li>
                            </ul>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-driver" onclick="contactAdminForDriverRegistration()">
                        <ion-icon name="logo-whatsapp"></ion-icon>
                        Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨
                    </button>
                    
                    <div class="form-footer mt-3">
                        <a href="#" onclick="showDriverLogin()">
                            <ion-icon name="arrow-back-outline"></ion-icon>
                            Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                        </a>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Home Screen (After Login) -->
        <section id="home-screen" class="screen hidden">
            <div class="screen-content">
                <div class="user-profile">
                    <div class="user-avatar" id="user-avatar">?</div>
                    <div class="user-info">
                        <h3 id="user-name">Ù…Ø±Ø­Ø¨Ø§Ù‹</h3>
                        <p id="user-phone-display"></p>
                        <div id="verification-status" class="hidden mt-1">
                            <span class="verified-badge">
                                <ion-icon name="checkmark-circle"></ion-icon>
                                Ø­Ø³Ø§Ø¨ Ù…ÙˆØ«Ù‚
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="home-actions">
                    <div class="action-card" onclick="requestRide()">
                        <div class="action-icon">ğŸš–</div>
                        <h4>Ø·Ù„Ø¨ Ø±Ø­Ù„Ø©</h4>
                    </div>
                    
                    <div class="action-card" onclick="showMyRides()">
                        <div class="action-icon">ğŸ“‹</div>
                        <h4>Ø±Ø­Ù„Ø§ØªÙŠ</h4>
                    </div>
                    
                    <div class="action-card" onclick="showWallet()">
                        <div class="action-icon">ğŸ’°</div>
                        <h4>Ø§Ù„Ù…Ø­ÙØ¸Ø©</h4>
                    </div>
                    
                    <div class="action-card" onclick="showSettings()">
                        <div class="action-icon">âš™ï¸</div>
                        <h4>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h4>
                    </div>
                </div>
                
                <!-- Ø²Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
                <button class="btn btn-primary" onclick="testAdvancedNotifications()" style="margin-top: 20px;">
                    <ion-icon name="notifications-outline"></ion-icon>
                    ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
                </button>
                
                <!-- Ø²Ø± ØªÙØ¹ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
                <button id="driver-notification-btn" class="btn btn-secondary mt-2 hidden" onclick="setupDriverNotifications()">
                    <ion-icon name="notifications"></ion-icon>
                    ğŸ”” ØªÙØ¹ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚
                </button>
                
                <button class="btn btn-outline mt-3" onclick="logout()">
                    <ion-icon name="log-out-outline"></ion-icon>
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </section>
        
        <!-- Ride Request Screen -->
<section id="ride-request-screen" class="screen hidden">
    <div class="screen-content">
        <div class="card">
            <h2 class="card-title">
                <ion-icon name="navigate-outline"></ion-icon>
                Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
            </h2>
            
            <!-- Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø·Ù„Ø¨ -->
            <div class="map-wrapper">
                <div class="map-container" id="ride-map">
                    <!-- Ø³ÙŠØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù‡Ù†Ø§ -->
                </div>
                <div class="map-controls">
                    <button class="map-control-btn" onclick="recenterMap()" title="ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ">
                        <ion-icon name="locate-outline"></ion-icon>
                    </button>
                    <button class="map-control-btn" onclick="refreshLocation()" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹">
                        <ion-icon name="refresh-outline"></ion-icon>
                    </button>
                </div>
            </div>
            
            <div class="mb-3">
                <h4 class="form-label">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©:</h4>
                <div class="vehicle-options">
                    <div class="vehicle-option" data-type="tuktuk" onclick="selectVehicle('tuktuk')">
                        <div class="vehicle-icon">ğŸ›º</div>
                        <div class="vehicle-name">ØªÙˆÙƒ ØªÙˆÙƒ</div>
                        <div class="vehicle-price">5,000 SDG</div>
                    </div>
                    
                    <div class="vehicle-option" data-type="economy" onclick="selectVehicle('economy')">
                        <div class="vehicle-icon">ğŸš—</div>
                        <div class="vehicle-name">Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©</div>
                        <div class="vehicle-price">6,000 SDG</div>
                    </div>
                    
                    <div class="vehicle-option" data-type="comfort" onclick="selectVehicle('comfort')">
                        <div class="vehicle-icon">ğŸš™</div>
                        <div class="vehicle-name">Ù…ØªÙˆØ³Ø·Ø©</div>
                        <div class="vehicle-price">7,000 SDG</div>
                    </div>
                    
                    <div class="vehicle-option" data-type="vip" onclick="selectVehicle('vip')">
                        <div class="vehicle-icon">â­</div>
                        <div class="vehicle-name">VIP</div>
                        <div class="vehicle-price">10,000 SDG</div>
                    </div>
                </div>
            </div>
            
            <div id="price-calculation" class="price-breakdown hidden">
                <div class="price-row">
                    <span>Ø§Ù„Ù…Ø³Ø§ÙØ©:</span>
                    <span id="distance-display">0 ÙƒÙ…</span>
                </div>
                <div class="price-row">
                    <span>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ:</span>
                    <span id="base-price-display">0 SDG</span>
                </div>
                <div class="price-row">
                    <span>Ø±Ø³ÙˆÙ… Ø¥Ø¶Ø§ÙÙŠØ©:</span>
                    <span id="extra-price-display">0 SDG</span>
                </div>
                <div class="price-row">
                    <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span>
                    <span id="total-price-display">0 SDG</span>
                </div>
            </div>
            
            <button id="confirm-ride-btn" class="btn btn-primary" onclick="confirmRide()" disabled>
                <ion-icon name="search-outline"></ion-icon>
                Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚
            </button>
            
            <button class="btn btn-outline mt-2" onclick="goHome()">
                <ion-icon name="arrow-back-outline"></ion-icon>
                Ø¥Ù„ØºØ§Ø¡ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø©
            </button>
        </div>
    </div>
</section>

<!-- Driver Dashboard -->
<section id="driver-dashboard-screen" class="screen hidden">
    <div class="screen-content">
        <div class="card">
            <div class="user-profile">
                <div class="user-avatar" id="driver-avatar">?</div>
                <div class="user-info">
                    <h3 id="driver-name">Ø³Ø§Ø¦Ù‚</h3>
                    <p id="driver-car-info">Ù…Ø±ÙƒØ¨Ø©</p>
                </div>
            </div>
            
            <div class="driver-status">
                <div id="driver-status-indicator" class="status-indicator status-offline">
                    <span class="status-dot"></span>
                    <span id="driver-status-text">ØºÙŠØ± Ù…ØªØµÙ„</span>
                </div>
                
                <button id="toggle-online-btn" class="btn btn-driver" onclick="toggleDriverStatus()">
                    <ion-icon name="power-outline"></ion-icon>
                    ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù…Ù„
                </button>
            </div>
            
            <div class="driver-stats">
                <div class="stat-card">
                    <div class="stat-value" id="driver-balance">0</div>
                    <div class="stat-label">Ø±ØµÙŠØ¯Ùƒ (SDG)</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="today-trips">0</div>
                    <div class="stat-label">Ø±Ø­Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="today-earnings">0</div>
                    <div class="stat-label">Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ÙŠÙˆÙ…</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="total-trips">0</div>
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø­Ù„Ø§Øª</div>
                </div>
            </div>
            
            <!-- Ø²Ø± ØªÙØ¹ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
            <button id="driver-notification-activation" class="btn btn-secondary" onclick="setupDriverNotifications()">
                <ion-icon name="notifications-outline"></ion-icon>
                ØªÙØ¹ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª
            </button>
            
            <button class="btn btn-outline mt-2" onclick="showDriverProfile()">
                <ion-icon name="person-outline"></ion-icon>
                Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
            </button>
            
            <button class="btn btn-outline mt-2" onclick="logoutDriver()">
                <ion-icon name="log-out-outline"></ion-icon>
                ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ø³Ø§Ø¦Ù‚
            </button>
        </div>
    </div>
</section>
</div>

<!-- PWA Install Prompt -->
<div id="pwa-install-prompt" style="display: none; position: fixed; bottom: 20px; left: 20px; right: 20px; background: white; padding: 16px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000;">
    <div style="text-align: center;">
        <h4 style="margin-bottom: 8px; color: var(--primary);">ØªØ«Ø¨ÙŠØª ØªØ·Ø¨ÙŠÙ‚ ØªØ±Ø­Ø§Ù„</h4>
        <p style="margin-bottom: 16px; color: var(--gray); font-size: 14px;">
            Ø«Ø¨Ù‘Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª ÙˆØ¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙˆØ±ÙŠØ©
        </p>
        <div style="display: flex; gap: 8px;">
            <button onclick="installPWA()" style="flex: 1; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-family: 'Tajawal'; font-weight: 700;">
                ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¢Ù†
            </button>
            <button onclick="hideInstallPrompt()" style="flex: 1; padding: 12px; background: transparent; color: var(--gray); border: 1px solid var(--gray-light); border-radius: 8px; font-family: 'Tajawal';">
                Ù„Ø§Ø­Ù‚Ø§Ù‹
            </button>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="notification-area"></div>

<!-- Ride Request Modal (For Driver) -->
<div id="incoming-ride-modal" class="overlay hidden">
    <div class="modal">
        <div class="modal-header">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸš¨</div>
            <h2 class="modal-title">Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯!</h2>
            <p class="modal-subtitle">Ù„Ø¯ÙŠÙƒ 40 Ø«Ø§Ù†ÙŠØ© Ù„Ù„Ø±Ø¯</p>
        </div>
        
        <div class="card" style="background: #fef2f2;">
            <div id="ride-details">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø© Ù‡Ù†Ø§ -->
            </div>
        </div>
        
        <div style="display: flex; gap: 12px; margin-top: 24px;">
            <button class="btn btn-driver" onclick="acceptRide()" style="flex: 1;">
                <ion-icon name="checkmark-outline"></ion-icon>
                Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©
            </button>
            <button class="btn btn-danger" onclick="declineRide()" style="flex: 1;">
                <ion-icon name="close-outline"></ion-icon>
                Ø±ÙØ¶
            </button>
        </div>
        
        <div class="countdown" style="text-align: center; font-size: 32px; font-weight: 800; color: var(--danger); margin-top: 20px;">
            40
        </div>
    </div>
</div>

<!-- Active Trip Modal -->
<div id="active-trip-modal" class="overlay hidden">
    <div class="modal">
        <div class="modal-header">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸš—</div>
            <h2 class="modal-title">Ø§Ù„Ø±Ø­Ù„Ø© Ø³Ø§Ø±ÙŠØ© Ø§Ù„Ø¢Ù†</h2>
        </div>
        
        <div id="trip-details">
            <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø© Ù‡Ù†Ø§ -->
        </div>
    </div>
</div>

<script>
    // --- Supabase Configuration ---
    const SB_URL = 'https://zsmlyiygjagmhnglrhoa.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzbWx5aXlnamFnbWhuZ2xyaG9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NDc3NjMsImV4cCI6MjA4MTUyMzc2M30.QviVinAng-ILq0umvI5UZCFEvNpP3nI0kW_hSaXxNps';
    
    const tarhalDB = supabase.createClient(SB_URL, SB_KEY);
    
    // --- Application State ---
    let currentUser = null;
    let currentDriver = null;
    let isDriverOnline = false;
    let selectedVehicleType = null;
    let rideMap = null;
    let userMarker = null;
    let destinationMarker = null;
    let userPosition = null;
    let destinationPosition = null;
    let currentRideId = null;
    let rideCountdownInterval = null;
    let rideTimeout = 40;
    let registeredPhone = null;
    let deferredPrompt = null;
    let locationUpdateInterval = null;
    let routingControl = null; // Ù…ØªØºÙŠØ± Ù„Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
    
    // Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    let notificationManager = null;
    let soundManager = null;
    
    // Vehicle prices
    const VEHICLE_PRICES = {
        tuktuk: { base: 5000, perKm: 2000, name: 'ØªÙˆÙƒ ØªÙˆÙƒ', icon: 'ğŸ›º' },
        economy: { base: 6000, perKm: 3000, name: 'Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©', icon: 'ğŸš—' },
        comfort: { base: 7000, perKm: 3500, name: 'Ù…ØªÙˆØ³Ø·Ø©', icon: 'ğŸš™' },
        vip: { base: 10000, perKm: 5000, name: 'VIP', icon: 'â­' }
    };
    
    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸš€ ØªØ±Ø­Ø§Ù„ Ø²ÙˆÙ†Ø§ - ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚');
        
        // ØªÙ‡ÙŠØ¦Ø© Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
        initSplashScreen();
        
        // ØªÙ‡ÙŠØ¦Ø© Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        initPWA();
        checkAuth();
        
        // ØªØ­Ù…ÙŠÙ„ Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ·
        setTimeout(() => {
            loadNotificationSystem();
        }, 1000);
    });
    
    // --- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ ---
    function initSplashScreen() {
        const splash = document.getElementById('splash-screen');
        const progress = document.getElementById('splash-progress');
        
        // Ù…Ø­Ø§ÙƒØ§Ø© Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­Ù…ÙŠÙ„
        let width = 0;
        const interval = setInterval(() => {
            width += 20;
            progress.style.width = width + '%';
            if (width >= 100) {
                clearInterval(interval);
                splash.style.opacity = '0';
                splash.style.transition = 'opacity 0.5s ease';
                setTimeout(() => {
                    splash.style.display = 'none';
                    console.log('âœ… ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨');
                }, 500);
            }
        }, 100);
    }
    
    // --- Ù†Ø¸Ø§Ù… PWA Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ---
    async function initPWA() {
        // ØªØ³Ø¬ÙŠÙ„ Service Worker
        if ('serviceWorker' in navigator) {
            try {
                await navigator.serviceWorker.register('service-worker.js');
                console.log('âœ… Service Worker Ù…Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­');
                
                // ØªØ­Ù…ÙŠÙ„ Firebase Messaging
                await loadFirebase();
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Service Worker:', error);
            }
        }
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ«Ø¨ÙŠØª PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            setTimeout(() => {
                if (deferredPrompt) {
                    showInstallPrompt();
                }
            }, 5000);
        });
        
        window.addEventListener('appinstalled', () => {
            console.log('âœ… PWA Ù…Ø«Ø¨Øª');
            localStorage.setItem('pwa_installed', 'true');
            showNotification('ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        });
    }
    
    async function loadFirebase() {
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyBxQLDLqr4W3lApfYLPjSV5It7925a9Rr0",
                authDomain: "double-carport-476915-j7.firebaseapp.com",
                projectId: "double-carport-476915-j7",
                storageBucket: "double-carport-476915-j7.firebasestorage.app",
                messagingSenderId: "122641462099",
                appId: "1:122641462099:web:345b777a88757d3ef7e7a6"
            };
            
            if (firebase.apps.length === 0) {
                firebase.initializeApp(firebaseConfig);
            }
            console.log('âœ… Firebase Ù…Ù‡ÙŠØ£');
        } catch (error) {
            console.log('âš ï¸ Firebase ØºÙŠØ± Ù…ØªØ§Ø­ØŒ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø¨Ø¯ÙˆÙ† Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Firebase');
        }
    }
    
    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ---
    async function loadNotificationSystem() {
        try {
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            notificationManager = new TarhalNotificationManager();
            await notificationManager.initialize();
            window.notificationManager = notificationManager;
            
            console.log('âœ… Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¬Ø§Ù‡Ø²');
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„ØµÙˆØª
            soundManager = new TarhalSoundManager();
            window.soundManager = soundManager;
            
            // Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
            if (!localStorage.getItem('tarhal_notifications_asked')) {
                setTimeout(() => {
                    notificationManager.showActivationPrompt();
                }, 3000);
            }
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:', error);
        }
    }
    
    // --- PWA Functions ---
    function showInstallPrompt() {
        const prompt = document.getElementById('pwa-install-prompt');
        if (prompt) {
            prompt.style.display = 'block';
        }
    }
    
    function hideInstallPrompt() {
        const prompt = document.getElementById('pwa-install-prompt');
        if (prompt) {
            prompt.style.display = 'none';
        }
    }
    
    async function installPWA() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                showNotification('ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            }
            
            deferredPrompt = null;
            hideInstallPrompt();
        }
    }
    
    // --- Screen Navigation ---
    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.add('hidden');
        });
        document.getElementById(screenId).classList.remove('hidden');
        
        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
        if (screenId === 'driver-dashboard-screen') {
            updateDriverUI();
        }
    }
    
    function showWelcomeScreen() {
        showScreen('welcome-screen');
    }
    
    function showCustomerLogin() {
        showScreen('customer-login-screen');
        document.getElementById('customer-phone').focus();
    }
    
    function showCustomerRegister() {
        showScreen('customer-register-screen');
        document.getElementById('verification-section').classList.add('hidden');
        document.getElementById('register-fullname').focus();
        document.getElementById('customerRegisterForm').style.opacity = '1';
        document.querySelector('#customerRegisterForm button').disabled = false;
    }
    
    function showDriverLogin() {
        showScreen('driver-login-screen');
        document.getElementById('driver-phone').focus();
    }
    
    function showDriverRegisterInfo() {
        showScreen('driver-register-info-screen');
    }
    
    // --- Ø¯Ø§Ù„Ø© goHome Ø§Ù„Ù…Ø­Ø³Ù†Ø© ---
    function goHome() {
        // ØªÙ†Ø¸ÙŠÙ Ø´Ø§Ù…Ù„
        if (locationUpdateInterval) {
            clearInterval(locationUpdateInterval);
            locationUpdateInterval = null;
        }
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        if (routingControl) {
            rideMap.removeControl(routingControl);
            routingControl = null;
        }
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        if (rideMap) {
            rideMap.remove();
            rideMap = null;
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        userMarker = null;
        destinationMarker = null;
        userPosition = null;
        destinationPosition = null;
        currentRoute = null;
        selectedVehicleType = null;
        
        // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø¹Ù†Ø§ØµØ± ØªØ­Ù…ÙŠÙ„ Ù…ØªØ¨Ù‚ÙŠØ©
        const loadingElements = document.querySelectorAll('.location-loading');
        loadingElements.forEach(el => el.remove());
        
        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
        if (currentUser) {
            showScreen('home-screen');
        } else if (currentDriver) {
            showScreen('driver-dashboard-screen');
        } else {
            showScreen('welcome-screen');
        }
        
        console.log('âœ… ØªÙ… Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©');
    }
    
    // --- ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ ---
    function updateDriverUI() {
        if (currentDriver) {
            // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙØ¹Ù„Ø§Ù‹
            const notificationBtn = document.getElementById('driver-notification-activation');
            if (notificationBtn && Notification.permission !== 'granted') {
                notificationBtn.classList.remove('hidden');
            }
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            const testBtn = document.getElementById('driver-notification-btn');
            if (testBtn) {
                testBtn.classList.remove('hidden');
            }
        }
    }
    
    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ---
    async function testAdvancedNotifications() {
        if (notificationManager) {
            await notificationManager.sendTestNotification();
        } else {
            showNotification('âš ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ø¨Ø¹Ø¯', 'warning');
        }
    }
    
    async function setupDriverNotifications() {
        if (!notificationManager) {
            showNotification('âš ï¸ Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª...', 'warning');
            await loadNotificationSystem();
        }
        
        if (notificationManager) {
            await notificationManager.enableAllFeatures();
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø³Ø§Ø¦Ù‚Ø§Ù‹ØŒ ØªØ³Ø¬ÙŠÙ„Ù‡ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
            if (currentDriver) {
                await registerDriverForNotifications();
            }
        }
    }
    
    async function registerDriverForNotifications() {
        try {
            if (currentDriver && notificationManager) {
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                    await tarhalDB
                        .from('driver_notifications')
                        .upsert({
                            driver_id: currentDriver.id,
                            notification_enabled: true,
                            last_active: new Date().toISOString()
                        }, { onConflict: 'driver_id' });
                    
                    showNotification('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    
                    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„
                    const btn = document.getElementById('driver-notification-activation');
                    if (btn) btn.classList.add('hidden');
                    
                    return true;
                }
            }
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚:', error);
            showNotification('âš ï¸ ØªØ¹Ø°Ø± ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 'error');
        }
        return false;
    }
    
    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØµÙˆØª ---
    function toggleAppSound() {
        if (soundManager) {
            const enabled = soundManager.toggle();
            updateSoundButton();
            
            const slider = document.getElementById('volume-slider');
            if (enabled) {
                slider.style.display = 'block';
                setTimeout(() => slider.style.display = 'none', 3000);
            } else {
                slider.style.display = 'none';
            }
        }
    }
    
    function updateSoundButton() {
        if (!soundManager) return;
        
        const icon = document.getElementById('sound-icon');
        const enabled = soundManager.enabled;
        
        icon.name = enabled ? 'volume-high' : 'volume-mute';
        document.getElementById('sound-toggle').style.background = 
            enabled ? '#4f46e5' : '#6b7280';
    }
    
    function changeVolume(value) {
        if (soundManager) {
            const volume = value / 100;
            soundManager.setVolume(volume);
            
            if (volume > 0 && soundManager.enabled) {
                soundManager.play('notification', { volume: volume * 0.5 });
            }
        }
    }
    
    // --- Customer Functions ---
    async function loginCustomer() {
        const phone = document.getElementById('customer-phone').value.trim();
        const password = document.getElementById('customer-password').value;
        
        if (!phone || !password) {
            showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'error');
            return;
        }
        
        if (!isValidSudanesePhone(phone)) {
            showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ø³ÙˆØ¯Ø§Ù†ÙŠ ØµØ­ÙŠØ­', 'error');
            return;
        }
        
        const loginBtn = document.querySelector('#customerLoginForm button');
        const originalText = loginBtn.innerHTML;
        loginBtn.innerHTML = '<span class="loading"></span> Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
        loginBtn.disabled = true;
        
        try {
            const { data: customer, error } = await tarhalDB
                .from('customers')
                .select('*')
                .eq('phone', phone)
                .single();
            
            if (error) {
                showNotification('Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ØºÙŠØ± Ù…Ø³Ø¬Ù„', 'error');
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
                return;
            }
            
            if (customer.password !== password) {
                showNotification('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
                return;
            }
            
            if (!customer.is_verified) {
                showNotification('Ø­Ø³Ø§Ø¨Ùƒ ØºÙŠØ± Ù…ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©', 'warning');
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
                
                setTimeout(() => {
                    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¥Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©ØŸ')) {
                        sendVerificationWhatsApp(customer.phone);
                    }
                }, 2000);
                return;
            }
            
            currentUser = customer;
            localStorage.setItem('tarhal_customer', JSON.stringify(customer));
            
            showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            showScreen('home-screen');
            updateUserProfile();
            
        } catch (error) {
            console.error('Login error:', error);
            showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error');
        } finally {
            loginBtn.innerHTML = originalText;
            loginBtn.disabled = false;
        }
    }
    
    async function registerCustomer() {
        const fullname = document.getElementById('register-fullname').value.trim();
        const phone = document.getElementById('register-phone').value.trim();
        const phone2 = document.getElementById('register-phone2').value.trim();
        const password = document.getElementById('register-password').value;
        
        if (!fullname || !phone || !password) {
            showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
            return;
        }
        
        if (!isValidSudanesePhone(phone)) {
            showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ø³ÙˆØ¯Ø§Ù†ÙŠ ØµØ­ÙŠØ­', 'error');
            return;
        }
        
        const registerBtn = document.querySelector('#customerRegisterForm button');
        const originalText = registerBtn.innerHTML;
        registerBtn.innerHTML = '<span class="loading"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';
        registerBtn.disabled = true;
        
        try {
            const { data: existingCustomer, error: checkError } = await tarhalDB
                .from('customers')
                .select('id')
                .eq('phone', phone)
                .single();
            
            if (existingCustomer) {
                showNotification('Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„', 'error');
                registerBtn.innerHTML = originalText;
                registerBtn.disabled = false;
                return;
            }
            
            const { data: newCustomer, error } = await tarhalDB
                .from('customers')
                .insert([{
                    full_name: fullname,
                    phone: phone,
                    phone2: phone2 || null,
                    password: password,
                    is_verified: false,
                    created_at: new Date().toISOString()
                }])
                .select()
                .single();
            
            if (error) throw error;
            
            registeredPhone = phone;
            
            document.getElementById('verification-section').classList.remove('hidden');
            document.getElementById('customerRegisterForm').style.opacity = '0.5';
            registerBtn.disabled = true;
            
            showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ù‚Ù… Ø¨ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨', 'success');
            
        } catch (error) {
            console.error('Registration error:', error);
            showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ' + error.message, 'error');
            registerBtn.innerHTML = originalText;
            registerBtn.disabled = false;
        }
    }
    
    function sendVerificationWhatsApp(phone = null) {
        const phoneToVerify = phone || registeredPhone;
        if (!phoneToVerify) return;
        
        const adminNumber = "249918183521";
        const message = "ØªÙØ¹ÙŠÙ„ ØªØ±Ø­Ø§Ù„ Ø²ÙˆÙ†Ø§";
        const whatsappUrl = `https://wa.me/${adminNumber}?text=${encodeURIComponent(message)}`;
        
        window.open(whatsappUrl, '_blank');
        showNotification('ØªÙ… ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨. Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„ØªØ£ÙƒÙŠØ¯ Ø­Ø³Ø§Ø¨Ùƒ', 'info');
    }
    
    function updateUserProfile() {
        if (!currentUser) return;
        
        document.getElementById('user-avatar').textContent = currentUser.full_name.charAt(0);
        document.getElementById('user-name').textContent = currentUser.full_name;
        document.getElementById('user-phone-display').textContent = currentUser.phone;
        
        if (currentUser.is_verified) {
            document.getElementById('verification-status').classList.remove('hidden');
        }
    }
    
    // --- Driver Functions ---
    async function loginDriver() {
        const phone = document.getElementById('driver-phone').value.trim();
        const password = document.getElementById('driver-password').value;
        
        if (!phone || !password) {
            showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'error');
            return;
        }
        
        const loginBtn = document.querySelector('#driverLoginForm button');
        const originalText = loginBtn.innerHTML;
        loginBtn.innerHTML = '<span class="loading"></span> Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
        loginBtn.disabled = true;
        
        try {
            const { data: driver, error } = await tarhalDB
                .from('drivers')
                .select('*')
                .eq('whatsapp_number', phone)
                .eq('is_active', true)
                .single();
            
            if (error) {
                showNotification('Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø£Ùˆ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙØ¹Ù„', 'error');
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
                return;
            }
            
            if (driver.password !== password) {
                showNotification('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
                return;
            }
            
            currentDriver = driver;
            localStorage.setItem('tarhal_driver', JSON.stringify(driver));
            
            showNotification('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ Ø£ÙŠÙ‡Ø§ Ø§Ù„Ø³Ø§Ø¦Ù‚!', 'success');
            showScreen('driver-dashboard-screen');
            updateDriverDashboard();
            updateDriverUI();
            
        } catch (error) {
            console.error('Driver login error:', error);
            showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error');
        } finally {
            loginBtn.innerHTML = originalText;
            loginBtn.disabled = false;
        }
    }
    
    function contactAdminForDriverRegistration() {
        const adminNumber = "249918183521";
        const message = "Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ø±ÙŠØ¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙƒØ³Ø§Ø¦Ù‚ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ ØªØ±Ø­Ø§Ù„ Ø§Ù„Ø³ÙˆØ¯Ø§Ù†";
        const whatsappUrl = `https://wa.me/${adminNumber}?text=${encodeURIComponent(message)}`;
        
        window.open(whatsappUrl, '_blank');
        showNotification('ØªÙ… ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©', 'info');
    }
    
    async function updateDriverDashboard() {
        if (!currentDriver) return;
        
        document.getElementById('driver-avatar').textContent = currentDriver.full_name.charAt(0);
        document.getElementById('driver-name').textContent = currentDriver.full_name;
        document.getElementById('driver-car-info').textContent = 
            `${currentDriver.car_model || 'Ø³ÙŠØ§Ø±Ø©'} - ${getVehicleTypeName(currentDriver.car_type)}`;
        
        document.getElementById('driver-balance').textContent = 
            (currentDriver.balance || 0).toLocaleString();
        
        try {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const { data: rides, error } = await tarhalDB
                .from('rides')
                .select('*')
                .eq('driver_id', currentDriver.id)
                .gte('created_at', today.toISOString())
                .eq('status', 'completed');
            
            if (!error && rides) {
                const todayEarnings = rides.reduce((sum, ride) => sum + (ride.driver_earnings || 0), 0);
                document.getElementById('today-trips').textContent = rides.length;
                document.getElementById('today-earnings').textContent = todayEarnings.toLocaleString();
            }
            
            const { data: totalRides, error: totalError } = await tarhalDB
                .from('rides')
                .select('id')
                .eq('driver_id', currentDriver.id)
                .eq('status', 'completed');
            
            if (!totalError && totalRides) {
                document.getElementById('total-trips').textContent = totalRides.length;
            }
            
        } catch (error) {
            console.error('Error fetching driver stats:', error);
        }
    }
    
    function toggleDriverStatus() {
        isDriverOnline = !isDriverOnline;
        const statusIndicator = document.getElementById('driver-status-indicator');
        const statusText = document.getElementById('driver-status-text');
        const toggleBtn = document.getElementById('toggle-online-btn');
        
        if (isDriverOnline) {
            statusIndicator.className = 'status-indicator status-online';
            statusText.textContent = 'Ù…ØªØµÙ„ ÙˆØ¬Ø§Ù‡Ø²';
            toggleBtn.innerHTML = '<ion-icon name="power-outline"></ion-icon> Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù…Ù„';
            toggleBtn.classList.add('btn-danger');
            toggleBtn.classList.remove('btn-driver');
            
            startDriverTracking();
            showNotification('Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ù…ØªØµÙ„ ÙˆØ¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±ÙƒÙˆØ¨', 'success');
            
            // ØªÙØ¹ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„
            if (Notification.permission === 'default') {
                setTimeout(() => {
                    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©ØŸ')) {
                        setupDriverNotifications();
                    }
                }, 1000);
            }
            
        } else {
            statusIndicator.className = 'status-indicator status-offline';
            statusText.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
            toggleBtn.innerHTML = '<ion-icon name="power-outline"></ion-icon> ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù…Ù„';
            toggleBtn.classList.remove('btn-danger');
            toggleBtn.classList.add('btn-driver');
            
            stopDriverTracking();
            showNotification('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù…Ù„', 'info');
        }
    }
    
    function startDriverTracking() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async (position) => {
                try {
                    await tarhalDB
                        .from('driver_locations')
                        .upsert({
                            driver_id: currentDriver.id,
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            car_type: currentDriver.car_type,
                            last_seen: new Date().toISOString()
                        }, { onConflict: 'driver_id' });
                    
                    showNotification('Ø¨Ø¯Ø£ ØªØªØ¨Ø¹ Ù…ÙˆÙ‚Ø¹Ùƒ...', 'success');
                } catch (error) {
                    console.error('Tracking error:', error);
                }
            }, (error) => {
                showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ', 'error');
            });
        }
    }
    
    function stopDriverTracking() {
        console.log('Driver tracking stopped');
    }
    
    // --- Ride Functions ---
    function requestRide() {
        if (!currentUser || !currentUser.is_verified) {
            showNotification('ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø·Ù„Ø¨ Ø±Ø­Ù„Ø©', 'error');
            return;
        }
        
        showScreen('ride-request-screen');
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        selectedVehicleType = null;
        destinationPosition = null;
        userPosition = null;
        
        document.querySelectorAll('.vehicle-option').forEach(option => {
            option.classList.remove('selected');
        });
        document.getElementById('price-calculation').classList.add('hidden');
        document.getElementById('confirm-ride-btn').disabled = true;
        
        // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù‚Ø¨Ù„ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        setTimeout(() => {
            initRideMap();
            showNotification("Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹...", "info");
        }, 300);
    }
    
    function initRideMap() {
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        if (rideMap) {
            rideMap.remove();
            rideMap = null;
            userMarker = null;
            destinationMarker = null;
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­Ø³Ù†Ø©
        rideMap = L.map('ride-map', {
            zoomControl: true,
            tap: true,
            zoomSnap: 0.5
        }).setView([15.5007, 32.5599], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap',
            maxZoom: 19
        }).addTo(rideMap);
        
        // ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        locateUserAutomatically();
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Ù‚Ø± Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø©
        rideMap.on('click', (e) => {
            if (destinationMarker) {
                rideMap.removeLayer(destinationMarker);
            }
            
            destinationMarker = L.marker(e.latlng, {
                icon: L.divIcon({
                    html: '<div style="background: #ef4444; width: 22px; height: 22px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-size: 11px;">ğŸ“</div>',
                    className: 'destination-marker',
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                })
            }).addTo(rideMap).bindPopup('Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„').openPopup();
            
            destinationPosition = { lat: e.latlng.lat, lng: e.latlng.lng };
            
            // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø·Ù„Ø¨
            document.getElementById('confirm-ride-btn').disabled = false;
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¯ Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹Ø§Ù‹ Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
            if (userPosition) {
                drawRealRoute(userPosition, destinationPosition);
                showNotification("âœ“ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„. Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ø±Ø³ÙˆÙ… Ø§Ù„Ø¢Ù†", "success");
            } else {
                showNotification("ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...", "info");
            }
        });
        
        // Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª
        setTimeout(() => {
            rideMap.invalidateSize();
        }, 400);
    }
    
    // --- Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ---
    function locateUserAutomatically() {
        const loadingIndicator = document.createElement('div');
        loadingIndicator.className = 'location-loading';
        loadingIndicator.innerHTML = `
            <div class="loading"></div>
            <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©...</div>
        `;
        document.getElementById('ride-map').appendChild(loadingIndicator);
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    userPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    rideMap.flyTo([userPosition.lat, userPosition.lng], 16, {
                        animate: true,
                        duration: 1.5
                    });
                    
                    userMarker = L.marker([userPosition.lat, userPosition.lng], {
                        icon: L.divIcon({
                            html: '<div style="background: #4f46e5; width: 18px; height: 18px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(79, 70, 229, 0.8);"></div>',
                            className: 'user-marker',
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        })
                    }).addTo(rideMap).bindPopup('Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ').openPopup();
                    
                    loadingIndicator.remove();
                    
                    showNotification(`âœ“ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ. Ø§Ù„Ø¢Ù† Ø­Ø¯Ø¯ Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©`, 'success');
                    
                    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ ÙˆØ¬Ù‡Ø© Ù…Ø­Ø¯Ø¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
                    if (destinationPosition) {
                        drawRealRoute(userPosition, destinationPosition);
                    }
                    
                    startLocationTracking();
                    
                },
                (error) => {
                    loadingIndicator.remove();
                    
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'location-loading';
                    errorDiv.style.background = '#fee2e2';
                    errorDiv.style.color = '#dc2626';
                    errorDiv.innerHTML = `
                        <ion-icon name="warning" style="font-size: 22px;"></ion-icon>
                        <div style="margin: 10px 0;">ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</div>
                        <div style="font-size: 13px; margin-bottom: 12px;">${getGeolocationError(error)}</div>
                        <div style="display: flex; gap: 8px; justify-content: center;">
                            <button onclick="retryUserLocation()" style="
                                background: var(--primary);
                                color: white;
                                border: none;
                                padding: 6px 14px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                            ">
                                Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                            </button>
                            <button onclick="useDefaultLocation()" style="
                                background: #e5e7eb;
                                color: var(--dark);
                                border: 1px solid var(--gray-light);
                                padding: 6px 14px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                            ">
                                Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                            </button>
                        </div>
                    `;
                    document.getElementById('ride-map').appendChild(errorDiv);
                    
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹:', error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        } else {
            loadingIndicator.remove();
            showNotification('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø®Ø¯Ù… Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ', 'warning');
            useDefaultLocation();
        }
    }
    
    // --- Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ---
    function drawRealRoute(start, end) {
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…
        if (routingControl) {
            rideMap.removeControl(routingControl);
            routingControl = null;
        }
        
        // Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… OSRM
        routingControl = L.Routing.control({
            waypoints: [
                L.latLng(start.lat, start.lng),
                L.latLng(end.lat, end.lng)
            ],
            routeWhileDragging: false,
            showAlternatives: false,
            fitSelectedRoutes: true,
            language: 'ar',
            lineOptions: {
                styles: [
                    {color: '#4f46e5', opacity: 0.8, weight: 5}
                ]
            },
            createMarker: function() { return null; } // Ø¹Ø¯Ù… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù„Ø§Ù…Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
        }).addTo(rideMap);
        
        // Ø¹Ù†Ø¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­
        routingControl.on('routesfound', function(e) {
            const routes = e.routes;
            if (routes && routes[0]) {
                const distanceKm = (routes[0].summary.totalDistance / 1000).toFixed(2);
                updateDistanceDisplay(distanceKm);
                if (selectedVehicleType) calculateRidePrice();
                showNotification("âœ“ ØªÙ… Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¹Ø¨Ø± Ø£Ù‚Ø±Ø¨ Ø·Ø±ÙŠÙ‚", "success");
            }
        });
        
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø· Ù…Ø³ØªÙ‚ÙŠÙ… ÙƒØ­Ù„ Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        routingControl.on('routingerror', function(e) {
            console.error('Routing error:', e);
            showNotification('âš ï¸ ØªØ¹Ø°Ø± Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø³Ø§Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠ', 'warning');
            drawStraightRoute(start, end);
        });
    }
    
    // --- Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø³ØªÙ‚ÙŠÙ… Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ---
    function drawStraightRoute(start, end) {
        if (routingControl) {
            rideMap.removeControl(routingControl);
            routingControl = null;
        }
        
        const straightLine = L.polyline([
            [start.lat, start.lng],
            [end.lat, end.lng]
        ], {
            color: '#4f46e5',
            weight: 4,
            opacity: 0.7,
            dashArray: '10, 10'
        }).addTo(rideMap);
        
        const distance = calculateDistance(start, end);
        updateDistanceDisplay(distance);
        
        if (selectedVehicleType) {
            calculateRidePrice();
        }
    }
    
    function retryUserLocation() {
        const errorDiv = document.querySelector('.location-loading');
        if (errorDiv) errorDiv.remove();
        
        locateUserAutomatically();
    }
    
    function useDefaultLocation() {
        userPosition = {
            lat: 15.5007,
            lng: 32.5599
        };
        
        rideMap.flyTo([userPosition.lat, userPosition.lng], 14);
        
        userMarker = L.marker([userPosition.lat, userPosition.lng], {
            icon: L.divIcon({
                html: '<div style="background: #6b7280; width: 18px; height: 18px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>',
                className: 'user-marker-default',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            })
        }).addTo(rideMap).bindPopup('Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ - Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ ÙŠØ¯ÙˆÙŠØ§Ù‹').openPopup();
        
        showNotification('ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙˆÙ‚Ø¹ Ø§ÙØªØ±Ø§Ø¶ÙŠ. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ ÙŠØ¯ÙˆÙŠØ§Ù‹', 'warning');
        showNotification('Ø§Ù„Ø¢Ù† Ø­Ø¯Ø¯ Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©', 'info');
    }
    
    function getGeolocationError(error) {
        switch(error.code) {
            case error.PERMISSION_DENIED:
                return "ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.";
            case error.POSITION_UNAVAILABLE:
                return "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ GPS.";
            case error.TIMEOUT:
                return "Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
            default:
                return "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
        }
    }
    
    function selectVehicle(type) {
        selectedVehicleType = type;
        
        document.querySelectorAll('.vehicle-option').forEach(option => {
            option.classList.remove('selected');
        });
        document.querySelector(`.vehicle-option[data-type="${type}"]`).classList.add('selected');
        
        if (destinationPosition && userPosition) {
            calculateRidePrice();
        }
    }
    
    function calculateRidePrice() {
        if (!userPosition || !destinationPosition || !selectedVehicleType) return;
        
        const distance = calculateDistance(userPosition, destinationPosition);
        
        const vehicle = VEHICLE_PRICES[selectedVehicleType];
        const additionalKm = Math.max(0, distance - 1);
        const basePrice = vehicle.base;
        const extraPrice = additionalKm * vehicle.perKm;
        const totalPrice = basePrice + extraPrice;
        
        document.getElementById('price-calculation').classList.remove('hidden');
        document.getElementById('distance-display').textContent = `${distance.toFixed(2)} ÙƒÙ…`;
        document.getElementById('base-price-display').textContent = `${basePrice.toLocaleString()} SDG`;
        document.getElementById('extra-price-display').textContent = `${Math.round(extraPrice).toLocaleString()} SDG`;
        document.getElementById('total-price-display').textContent = `${Math.round(totalPrice).toLocaleString()} SDG`;
        
        document.getElementById('confirm-ride-btn').disabled = false;
    }
    
    function calculateDistance(pos1, pos2) {
        const R = 6371;
        const dLat = (pos2.lat - pos1.lat) * Math.PI / 180;
        const dLon = (pos2.lng - pos1.lng) * Math.PI / 180;
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(pos1.lat * Math.PI / 180) * Math.cos(pos2.lat * Math.PI / 180) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const distance = R * c;
        
        return parseFloat(distance.toFixed(2));
    }
    
    function recenterMap() {
        if (userPosition && rideMap) {
            rideMap.setView([userPosition.lat, userPosition.lng], 16);
            
            if (routePolyline) {
                rideMap.fitBounds(routePolyline.getBounds());
            }
            
            showNotification('ØªÙ… Ø§Ù„ØªÙ…Ø±ÙƒØ² Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ', 'success');
        } else {
            showNotification('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ø¹Ø¯', 'warning');
        }
    }
    
    function refreshLocation() {
        if (navigator.geolocation) {
            showNotification('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹...', 'info');
            
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    userPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    if (userMarker) {
                        userMarker.setLatLng([userPosition.lat, userPosition.lng]);
                    }
                    
                    rideMap.setView([userPosition.lat, userPosition.lng], 16);
                    
                    if (destinationPosition) {
                        drawRealRoute(userPosition, destinationPosition);
                    }
                    
                    showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                },
                (error) => {
                    showNotification('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000
                }
            );
        }
    }
    
    function startLocationTracking() {
        if (locationUpdateInterval) {
            clearInterval(locationUpdateInterval);
        }
        
        locationUpdateInterval = setInterval(() => {
            if (navigator.geolocation && rideMap && userMarker) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const newPos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    if (calculateDistance(userPosition, newPos) > 0.01) {
                        userPosition = newPos;
                        userMarker.setLatLng([userPosition.lat, userPosition.lng]);
                        
                        if (destinationPosition) {
                            drawRealRoute(userPosition, destinationPosition);
                            if (selectedVehicleType) {
                                calculateRidePrice();
                            }
                        }
                    }
                });
            }
        }, 30000);
    }
    
    function updateDistanceDisplay(distance) {
        document.getElementById('distance-display').textContent = 
            `${distance} ÙƒÙ…`;
    }
    
    async function confirmRide() {
        if (!selectedVehicleType || !destinationPosition) {
            showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø© ÙˆØ§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©', 'warning');
            return;
        }
        
        if (!currentUser || !currentUser.is_verified) {
            showNotification('ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø·Ù„Ø¨ Ø±Ø­Ù„Ø©', 'error');
            return;
        }
        
        const confirmBtn = document.getElementById('confirm-ride-btn');
        const originalText = confirmBtn.innerHTML;
        confirmBtn.innerHTML = '<span class="loading"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚...';
        confirmBtn.disabled = true;
        
        showNotification('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚ Ù‚Ø±ÙŠØ¨...', 'info');
        
        try {
            const distance = calculateDistance(userPosition, destinationPosition);
            const vehicle = VEHICLE_PRICES[selectedVehicleType];
            const additionalKm = Math.max(0, distance - 1);
            const totalPrice = vehicle.base + (additionalKm * vehicle.perKm);
            
            const { data: ride, error } = await tarhalDB
                .from('rides')
                .insert([{
                    customer_id: currentUser.id,
                    customer_name: currentUser.full_name,
                    customer_phone: currentUser.phone,
                    customer_phone2: currentUser.phone2,
                    pickup_lat: userPosition.lat,
                    pickup_lng: userPosition.lng,
                    destination_lat: destinationPosition.lat,
                    destination_lng: destinationPosition.lng,
                    distance_km: parseFloat(distance.toFixed(2)),
                    vehicle_type: selectedVehicleType,
                    amount: totalPrice,
                    status: 'searching',
                    created_at: new Date().toISOString()
                }])
                .select()
                .single();
            
            if (error) throw error;
            
            currentRideId = ride.id;
            
            setTimeout(() => {
                showNotification('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø§Ø¦Ù‚! Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...', 'success');
                
                if (notificationManager && currentDriver) {
                    notificationManager.sendRideNotificationToDriver(currentDriver.id, {
                        id: ride.id,
                        customerName: currentUser.full_name,
                        customerPhone: currentUser.phone,
                        pickupLocation: 'Ø§Ù„Ø®Ø±Ø·ÙˆÙ… - Ø§Ù„Ø¹Ù…Ø§Ø±Ø§Øª',
                        destination: 'Ø£Ù… Ø¯Ø±Ù…Ø§Ù† - Ø§Ù„Ø³ÙˆÙ‚',
                        distance: `${distance.toFixed(2)} ÙƒÙ…`,
                        price: `${totalPrice.toLocaleString()} SDG`,
                        vehicleType: vehicle.name
                    });
                }
                
                setTimeout(() => {
                    showActiveRideModal(ride);
                }, 2000);
                
            }, 3000);
            
        } catch (error) {
            console.error('Ride request error:', error);
            showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø©', 'error');
            confirmBtn.innerHTML = originalText;
            confirmBtn.disabled = false;
        }
    }
    
    function showActiveRideModal(ride) {
        const modal = document.getElementById('active-trip-modal');
        modal.classList.remove('hidden');
        
        const tripDetails = document.getElementById('trip-details');
        tripDetails.innerHTML = `
            <div class="card mb-3">
                <div class="price-row">
                    <span>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©:</span>
                    <span>${VEHICLE_PRICES[ride.vehicle_type].name}</span>
                </div>
                <div class="price-row">
                    <span>Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚:</span>
                    <span>${getNeighborhoodName(ride.pickup_lat, ride.pickup_lng)}</span>
                </div>
                <div class="price-row">
                    <span>Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙˆØµÙˆÙ„:</span>
                    <span>${getNeighborhoodName(ride.destination_lat, ride.destination_lng)}</span>
                </div>
                <div class="price-row">
                    <span>Ø§Ù„Ù…Ø³Ø§ÙØ©:</span>
                    <span>${ride.distance_km} ÙƒÙ…</span>
                </div>
                <div class="price-row">
                    <span>Ø§Ù„Ø³Ø§Ø¦Ù‚:</span>
                    <span>Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯</span>
                </div>
                <div class="price-row">
                    <span>Ø±Ù‚Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚:</span>
                    <span>+249 90 123 4567</span>
                </div>
                <div class="price-row" style="font-weight: 800; color: var(--primary);">
                    <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span>
                    <span>${ride.amount.toLocaleString()} SDG</span>
                </div>
            </div>
            
            <div class="mb-3">
                <button class="btn btn-secondary" onclick="callDriver()">
                    <ion-icon name="call-outline"></ion-icon>
                    Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø§Ø¦Ù‚
                </button>
            </div>
            
            <div class="mb-3">
                <button class="btn btn-danger" onclick="cancelRide()">
                    <ion-icon name="close-outline"></ion-icon>
                    Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
                </button>
            </div>
            
            <p style="text-align: center; color: var(--gray); font-size: 14px;">
                Ø³ÙŠØªÙ… Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø®Ù„Ø§Ù„ Ø«ÙˆØ§Ù†Ù
            </p>
        `;
        
        document.getElementById('confirm-ride-btn').innerHTML = '<ion-icon name="search-outline"></ion-icon> Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚';
        document.getElementById('confirm-ride-btn').disabled = false;
    }
    
    // --- Helper Functions ---
    function checkAuth() {
        const savedUser = localStorage.getItem('tarhal_customer');
        const savedDriver = localStorage.getItem('tarhal_driver');
        
        if (savedDriver) {
            try {
                currentDriver = JSON.parse(savedDriver);
                showScreen('driver-dashboard-screen');
                updateDriverDashboard();
                updateDriverUI();
            } catch (e) {
                localStorage.removeItem('tarhal_driver');
                showScreen('welcome-screen');
            }
        } else if (savedUser) {
            try {
                currentUser = JSON.parse(savedUser);
                showScreen('home-screen');
                updateUserProfile();
            } catch (e) {
                localStorage.removeItem('tarhal_customer');
                showScreen('welcome-screen');
            }
        } else {
            showScreen('welcome-screen');
        }
    }
    
    function getVehicleTypeName(type) {
        const names = {
            tuktuk: 'ØªÙˆÙƒ ØªÙˆÙƒ',
            economy: 'Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©',
            comfort: 'Ù…ØªÙˆØ³Ø·Ø©',
            vip: 'VIP'
        };
        return names[type] || type;
    }
    
    function getNeighborhoodName(lat, lng) {
        return "Ø§Ù„Ø®Ø±Ø·ÙˆÙ…";
    }
    
    function isValidSudanesePhone(phone) {
        const sudanesePhoneRegex = /^(?:\+249|0)?(?:9[0123456789]|1[012])\d{7}$/;
        return sudanesePhoneRegex.test(phone);
    }
    
    function showNotification(message, type = 'info') {
        const notificationArea = document.getElementById('notification-area');
        
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        
        let icon = 'â„¹ï¸';
        if (type === 'success') icon = 'âœ…';
        else if (type === 'error') icon = 'âŒ';
        else if (type === 'warning') icon = 'âš ï¸';
        
        notification.innerHTML = `
            <div class="notification-icon">${icon}</div>
            <div style="flex: 1; font-size: 14px;">${message}</div>
        `;
        
        notificationArea.appendChild(notification);
        
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateY(-20px)';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
    
    function logout() {
        localStorage.removeItem('tarhal_customer');
        currentUser = null;
        showScreen('welcome-screen');
        showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
    }
    
    function logoutDriver() {
        if (isDriverOnline) {
            toggleDriverStatus();
        }
        localStorage.removeItem('tarhal_driver');
        currentDriver = null;
        showScreen('welcome-screen');
        showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ø³Ø§Ø¦Ù‚', 'success');
    }
    
    // Placeholder functions
    function showMyRides() {
        showNotification('Ù‚Ø±ÙŠØ¨Ø§Ù‹: Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©', 'info');
    }
    
    function showWallet() {
        showNotification('Ù‚Ø±ÙŠØ¨Ø§Ù‹: Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©', 'info');
    }
    
    function showSettings() {
        showNotification('Ù‚Ø±ÙŠØ¨Ø§Ù‹: Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨', 'info');
    }
    
    function showDriverProfile() {
        showNotification('Ù‚Ø±ÙŠØ¨Ø§Ù‹: Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù„Ù„Ø³Ø§Ø¦Ù‚', 'info');
    }
    
    function callDriver() {
        showNotification('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø§Ø¦Ù‚...', 'info');
    }
    
    function cancelRide() {
        document.getElementById('active-trip-modal').classList.add('hidden');
        showNotification('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©', 'info');
        goHome();
    }
    
    function acceptRide() {
        document.getElementById('incoming-ride-modal').classList.add('hidden');
        showNotification('ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
        showActiveRideModal({
            vehicle_type: 'economy',
            amount: 10000,
            distance_km: 5.2
        });
    }
    
    function declineRide() {
        document.getElementById('incoming-ride-modal').classList.add('hidden');
        showNotification('ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©', 'info');
    }
    
    // ØªØ­Ù…ÙŠÙ„ Leaflet Ùˆ Leaflet Routing Machine Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
    window.addEventListener('load', function() {
        if (typeof L === 'undefined') {
            const leafletScript = document.createElement('script');
            leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
            leafletScript.onload = function() {
                console.log('âœ… Leaflet loaded successfully');
                // ØªØ­Ù…ÙŠÙ„ Leaflet Routing Machine Ø¨Ø¹Ø¯ Leaflet
                const routingScript = document.createElement('script');
                routingScript.src = 'https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js';
                routingScript.onload = function() {
                    console.log('âœ… Leaflet Routing Machine loaded successfully');
                };
                document.head.appendChild(routingScript);
            };
            document.head.appendChild(leafletScript);
        }
        
        if ('Notification' in window && Notification.permission === 'default') {
            // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„
        }
    });
    
    console.log('ğŸ¯ ØªØ·Ø¨ÙŠÙ‚ ØªØ±Ø­Ø§Ù„ Ø²ÙˆÙ†Ø§ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„!');
</script>

<!-- Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
<script src="notification-manager.js"></script>
<script src="sound-manager.js"></script>

</body>
</html>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ترحال زونا السودان - Tarhal</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <link rel="icon" href="icons/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- Tajawal Font -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Ionicons Icons -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

    <!-- Firebase for Notifications -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --primary-light: #e0e7ff;
            --secondary: #10b981;
            --secondary-dark: #059669;
            --warning: #f59e0b;
            --danger: #ef4444;
            --danger-dark: #dc2626;
            --light: #f9fafb;
            --dark: #111827;
            --gray: #6b7280;
            --gray-light: #e5e7eb;
            
            --driver: #16a34a;
            --tuk-tuk: #059669;
            --economy: #2563eb;
            --comfort: #7c3aed;
            --vip: #d97706;
            --staff: #7c3aed;
            
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --radius: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .app-container {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--light);
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        /* Header */
        .app-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px 24px;
            text-align: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 9999 !important;
            border-bottom: 4px solid var(--primary-dark);
        }
        
        .app-header h1 {
            font-size: 24px;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .app-header .logo {
            font-size: 28px;
        }
        
        /* Screens */
        .screen {
            padding: 24px;
            min-height: calc(100vh - 76px);
            display: flex;
            flex-direction: column;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-light);
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 16px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        /* Buttons */
        .btn {
            padding: 16px 24px;
            border-radius: var(--radius);
            border: none;
            font-family: 'Tajawal', sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-bottom: 12px;
        }
        
        .btn:active {
            transform: translateY(2px);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.3);
        }
        
        .btn-secondary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-secondary:hover {
            background: var(--secondary-dark);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }
        
        .btn-driver {
            background: var(--driver);
            color: white;
        }
        
        .btn-driver:hover {
            background: #15803d;
            box-shadow: 0 6px 20px rgba(22, 163, 74, 0.3);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary-light);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: var(--danger-dark);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark);
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--gray-light);
            border-radius: var(--radius);
            font-family: 'Tajawal', sans-serif;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .form-input::placeholder {
            color: var(--gray);
        }
        
        /* Welcome Screen */
        .welcome-card {
            text-align: center;
            padding: 40px 24px;
            background: linear-gradient(135deg, #e0e7ff 0%, #ede9fe 100%);
            border: none;
            margin-top: 40px;
        }
        
        .welcome-icon {
            font-size: 64px;
            margin-bottom: 24px;
            color: var(--primary);
        }
        
        .welcome-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 12px;
        }
        
        .welcome-subtitle {
            color: var(--gray);
            font-size: 16px;
            margin-bottom: 40px;
            line-height: 1.6;
        }
        
        .role-selection {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .role-card {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            text-align: right;
        }
        
        .role-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
        }
        
        .role-icon {
            font-size: 32px;
            color: var(--primary);
        }
        
        .role-info h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--dark);
        }
        
        .role-info p {
            font-size: 14px;
            color: var(--gray);
            line-height: 1.5;
        }
        
        /* Login Screens */
        .login-form {
            max-width: 400px;
            margin: 0 auto;
            width: 100%;
        }
        
        .form-footer {
            text-align: center;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-light);
        }
        
        .form-footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .form-footer .register-text {
            margin-bottom: 20px;
        }
        
        .form-footer .register-text a {
            display: inline;
        }
        
        .form-footer .back-link {
            display: inline-flex;
            justify-content: center;
            margin-top: 8px;
            padding: 10px 16px;
            border-radius: 12px;
            background: #f1f2ff;
            font-size: 14px;
        }
        
        .form-footer a:hover {
            text-decoration: underline;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: white;
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            border-right: 4px solid var(--primary);
            animation: slideIn 0.3s ease;
            max-width: 500px;
            margin: 0 auto;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .notification-icon {
            font-size: 24px;
        }
        
        .notification-success {
            border-right-color: var(--secondary);
        }
        
        .notification-error {
            border-right-color: var(--danger);
        }
        
        .notification-warning {
            border-right-color: var(--warning);
        }
        
        /* Overlay Modals */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal {
            background: white;
            border-radius: var(--radius-xl);
            padding: 32px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.4s ease;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(40px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .modal-subtitle {
            color: var(--gray);
            font-size: 16px;
        }
        
        /* Home Screen */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 32px;
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: 700;
        }
        
        .user-info h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--dark);
        }
        
        .user-info p {
            color: var(--gray);
            font-size: 14px;
        }
        
        .verified-badge {
            background: var(--secondary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .home-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 20px;
        }
        
        .action-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid var(--gray-light);
        }
        
        .action-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
            border-color: var(--primary-light);
        }
        
        .action-icon {
            font-size: 32px;
            margin-bottom: 12px;
            color: var(--primary);
        }
        
        .action-card h4 {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark);
        }
        
        /* Ride Request */
        .map-container {
            width: 100%;
            height: 250px;
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: 24px;
            border: 2px solid var(--gray-light);
        }
        
        .vehicle-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .vehicle-option {
            border: 2px solid var(--gray-light);
            border-radius: var(--radius);
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .vehicle-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .vehicle-option.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }
        
        .vehicle-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .vehicle-name {
            font-weight: 700;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .vehicle-price {
            color: var(--primary);
            font-weight: 800;
            font-size: 18px;
        }
        
        .price-breakdown {
            background: var(--light);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .price-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .price-row:last-child {
            border-bottom: none;
            font-weight: 800;
            font-size: 20px;
            color: var(--primary);
        }
        
        /* Driver Dashboard */
        .driver-status {
            background: var(--light);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .status-offline {
            background: #fee2e2;
            color: var(--danger);
        }
        
        .status-online {
            background: #dcfce7;
            color: var(--secondary-dark);
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .status-offline .status-dot {
            background: var(--danger);
        }
        
        .status-online .status-dot {
            background: var(--secondary);
        }
        
        .driver-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 16px;
            text-align: center;
            border: 1px solid var(--gray-light);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--gray);
        }
        
        /* Responsive */
        @media (max-width: 480px) {
            .screen {
                padding: 16px;
            }
            
            .card {
                padding: 20px;
            }
            
            .vehicle-options {
                grid-template-columns: 1fr;
            }
            
            .home-actions {
                grid-template-columns: 1fr;
            }
        }
        
        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Utility Classes */
        .text-center { text-align: center; }
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .mb-3 { margin-bottom: 24px; }
        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }
        .mt-3 { margin-top: 24px; }
        .p-1 { padding: 8px; }
        .p-2 { padding: 16px; }
        .p-3 { padding: 24px; }
        
        /* PWA Install Prompt */
        #pwa-install-prompt {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideUp 0.3s ease;
        }
        
        .pwa-mode .app-header {
            padding-top: env(safe-area-inset-top, 20px);
        }
        
        .app-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-img {
            width: 70px;
            height: 70px;
            object-fit: contain;
        }
        
        /* In-app Notification */
        .in-app-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            left: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 9999;
            animation: slideDown 0.3s ease;
            border-right: 4px solid #4f46e5;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 400px;
            margin: 0 auto;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Notification Activation Modal */
        #notification-activation-prompt {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 99999;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        
        /* Sound Control */
        .sound-control-panel {
            position: fixed;
            bottom: 80px;
            left: 20px;
            z-index: 1000;
        }
        
        #volume-slider {
            display: none;
            margin-top: 10px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- Notification Activation Modal (Dynamic) -->
    <div id="notification-activation-modal"></div>
    
    <!-- Sound Control Panel -->
    <div class="sound-control-panel">
        <button id="sound-toggle" onclick="toggleAppSound()" 
                style="width: 50px; height: 50px; border-radius: 50%; 
                       background: #4f46e5; border: none; color: white;
                       display: flex; align-items: center; justify-content: center;
                       cursor: pointer; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);">
            <ion-icon name="volume-high" id="sound-icon" style="font-size: 24px;"></ion-icon>
        </button>
        
        <div id="volume-slider">
            <input type="range" min="0" max="100" value="70" 
                   oninput="changeVolume(this.value)" style="width: 100%;">
        </div>
    </div>
    
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <h1 class="app-title">
                <img 
                    src="icons/icon-512x512.png" 
                    alt="ترحال زونا السودان" 
                    class="logo-img"
                >
                ترحــال زونــا
            </h1>
        </header>
        
        <!-- Welcome Screen -->
        <section id="welcome-screen" class="screen">
            <div class="welcome-card card">
                <h1 class="welcome-title">مرحباً بك في ترحال زونا</h1>
                <p class="welcome-subtitle">
                    تطبيق النقل الأول في السودان. اختر طريقة دخولك للبدء
                </p>
                
                <div class="role-selection">
                    <!-- طالب رحلة -->
                    <div class="role-card" onclick="showCustomerLogin()">
                        <div class="role-icon">
                            <i class="fa-solid fa-user"></i>
                        </div>
                        <div class="role-info">
                            <h3>طالب رحلة</h3>
                            <p>اطلب رحلة بسهولة وأمان من أقرب سائق لك</p>
                        </div>
                        <ion-icon name="chevron-forward-outline"></ion-icon>
                    </div>

                    <!-- سائق -->
                    <div class="role-card" onclick="showDriverLogin()">
                        <div class="role-icon">
                            <i class="fa-solid fa-car"></i>
                        </div>
                        <div class="role-info">
                            <h3>سائق</h3>
                            <p>انضم كسائق وابدأ كسب المال مع ترحال زونا</p>
                        </div>
                        <ion-icon name="chevron-forward-outline"></ion-icon>
                    </div>

                    <div class="form-footer mt-3">
                        <a href="/admin-login.html">
                            <ion-icon name="shield-checkmark-outline"></ion-icon>
                            دخول الموظفين
                        </a>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Customer Login -->
        <section id="customer-login-screen" class="screen hidden">
            <div class="card">
                <h2 class="card-title">
                    <ion-icon name="person-circle-outline"></ion-icon>
                    دخول طالب الرحلة
                </h2>
                
                <form class="login-form" id="customerLoginForm">
                    <div class="form-group">
                        <label class="form-label" for="customer-phone">رقم الواتساب</label>
                        <input type="tel" id="customer-phone" class="form-input" 
                               placeholder="ادخل رقم الواتساب" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="customer-password">كلمة المرور</label>
                        <input type="password" id="customer-password" class="form-input" 
                               placeholder="ادخل كلمة المرور" required>
                    </div>
                    
                    <button type="button" class="btn btn-primary" onclick="loginCustomer()">
                        <ion-icon name="log-in-outline"></ion-icon>
                        تسجيل الدخول
                    </button>
                </form>
                
                <div class="form-footer">
                    <p class="register-text">
                        ليس لديك حساب؟
                        <a href="#" onclick="showCustomerRegister()">سجل حساب الآن</a>
                    </p>

                    <a href="#" class="back-link" onclick="showWelcomeScreen()">
                        <ion-icon name="arrow-back-outline"></ion-icon>
                        العودة للخيارات
                    </a>
                </div>
            </div>
        </section>
        
        <!-- Customer Registration -->
        <section id="customer-register-screen" class="screen hidden">
            <div class="card">
                <h2 class="card-title">
                    <ion-icon name="person-add-outline"></ion-icon>
                    تسجيل حساب جديد
                </h2>
                
                <form class="login-form" id="customerRegisterForm">
                    <div class="form-group">
                        <label class="form-label" for="register-fullname">الاسم الرباعي</label>
                        <input type="text" id="register-fullname" class="form-input" 
                               placeholder="الاسم الرباعي" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="register-phone">رقم الواتساب</label>
                        <input type="tel" id="register-phone" class="form-input" 
                               placeholder="رقم الواتساب (للتسجيل)" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="register-phone2">رقم إضافي (اختياري)</label>
                        <input type="tel" id="register-phone2" class="form-input" 
                               placeholder="رقم إضافي للتواصل">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="register-password">كلمة المرور</label>
                        <input type="password" id="register-password" class="form-input" 
                               placeholder="اختر كلمة مرور قوية" required>
                    </div>
                    
                    <button type="button" class="btn btn-primary" onclick="registerCustomer()">
                        <ion-icon name="create-outline"></ion-icon>
                        تسجيل الحساب
                    </button>
                </form>
                
                <div id="verification-section" class="hidden mt-3">
                    <div class="card" style="background: #f0f9ff; border: 2px dashed var(--secondary);">
                        <h3 class="mb-2" style="color: var(--secondary);">
                            <ion-icon name="checkmark-circle-outline"></ion-icon>
                            تم التسجيل بنجاح!
                        </h3>
                        <p class="mb-2">لتفعيل حسابك، يرجى الضغط على الزر أدناه لإرسال رسالة تأكيد:</p>
                        
                        <button type="button" class="btn btn-secondary" onclick="sendVerificationWhatsApp()">
                            <ion-icon name="logo-whatsapp"></ion-icon>
                            تأكيد الحساب عبر واتساب
                        </button>
                        
                        <p class="mt-2" style="font-size: 14px; color: var(--gray);">
                            بعد إرسال الرسالة، سيتم تفعيل حسابك تلقائياً خلال دقائق
                        </p>
                    </div>
                </div>
                
                <div class="form-footer mt-3">
                    <a href="#" onclick="showCustomerLogin()">
                        <ion-icon name="arrow-back-outline"></ion-icon>
                        العودة لتسجيل الدخول
                    </a>
                </div>
            </div>
        </section>
        
        <!-- Driver Login -->
        <section id="driver-login-screen" class="screen hidden">
            <div class="card">
                <h2 class="card-title">
                    <ion-icon name="car-sport-outline"></ion-icon>
                    دخول السائقين
                </h2>
                
                <form class="login-form" id="driverLoginForm">
                    <div class="form-group">
                        <label class="form-label" for="driver-phone">رقم واتساب السائق</label>
                        <input type="tel" id="driver-phone" class="form-input" 
                               placeholder="رقم الواتساب المسجل" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="driver-password">كلمة المرور</label>
                        <input type="password" id="driver-password" class="form-input" 
                               placeholder="كلمة مرور السائق" required>
                    </div>
                    
                    <button type="button" class="btn btn-driver" onclick="loginDriver()">
                        <ion-icon name="log-in-outline"></ion-icon>
                        دخول السائق
                    </button>
                </form>
                
                <div class="form-footer">
                    <p>ليس لديك حساب سائق؟ 
                        <a href="#" onclick="showDriverRegisterInfo()">سجل كسائق الآن</a>
                    </p>
                    <a href="#" onclick="showWelcomeScreen()">
                        <ion-icon name="arrow-back-outline"></ion-icon>
                        العودة للخيارات
                    </a>
                </div>
            </div>
        </section>
        
        <!-- Driver Registration Info -->
        <section id="driver-register-info-screen" class="screen hidden">
            <div class="card">
                <h2 class="card-title">
                    <ion-icon name="information-circle-outline"></ion-icon>
                    التسجيل كسائق
                </h2>
                
                <div class="mb-3">
                    <p>للتسجيل كسائق في تطبيق ترحال، يرجى التواصل مع إدارتنا على واتساب لإكمال عملية التسجيل:</p>
                    
                    <div class="p-3" style="background: #f0f9ff; border-radius: var(--radius); margin: 20px 0;">
                        <h4 class="mb-2" style="color: var(--primary);">المستندات المطلوبة:</h4>
                        <ul style="padding-right: 20px; line-height: 1.8;">
                            <li>رخصة القيادة السارية</li>
                            <li>استمارة السيارة</li>
                            <li>صورة شخصية</li>
                            <li>صورة السيارة من الخارج</li>
                            <li>صورة لوحة السيارة</li>
                        </ul>
                    </div>
                </div>
                
                <button type="button" class="btn btn-driver" onclick="contactAdminForDriverRegistration()">
                    <ion-icon name="logo-whatsapp"></ion-icon>
                    التواصل مع الإدارة على واتساب
                </button>
                
                <div class="form-footer mt-3">
                    <a href="#" onclick="showDriverLogin()">
                        <ion-icon name="arrow-back-outline"></ion-icon>
                        العودة لتسجيل الدخول
                    </a>
                </div>
            </div>
        </section>
        
        <!-- Home Screen (After Login) -->
        <section id="home-screen" class="screen hidden">
            <div class="user-profile">
                <div class="user-avatar" id="user-avatar">?</div>
                <div class="user-info">
                    <h3 id="user-name">مرحباً</h3>
                    <p id="user-phone-display"></p>
                    <div id="verification-status" class="hidden mt-1">
                        <span class="verified-badge">
                            <ion-icon name="checkmark-circle"></ion-icon>
                            حساب موثق
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="home-actions">
                <div class="action-card" onclick="requestRide()">
                    <div class="action-icon"></div>
                    <h4>طلب رحلة</h4>
                </div>
                
                <div class="action-card" onclick="showMyRides()">
                    <div class="action-icon"></div>
                    <h4>رحلاتي</h4>
                </div>
                
                <div class="action-card" onclick="showWallet()">
                    <div class="action-icon"></div>
                    <h4>المحفظة</h4>
                </div>
                
                <div class="action-card" onclick="showSettings()">
                    <div class="action-icon">⚙️</div>
                    <h4>الإعدادات</h4>
                </div>
            </div>
            
            <!-- زر اختبار الإشعارات المتقدمة -->
            <button class="btn btn-primary" onclick="testAdvancedNotifications()" style="margin-top: 20px;">
                <ion-icon name="notifications-outline"></ion-icon>
                 اختبار الإشعارات المتقدمة
            </button>
            
            <!-- زر تفعيل إشعارات السائق -->
            <button id="driver-notification-btn" class="btn btn-secondary mt-2 hidden" onclick="setupDriverNotifications()">
                <ion-icon name="notifications"></ion-icon>
                 تفعيل إشعارات السائق
            </button>
            
            <button class="btn btn-outline mt-3" onclick="logout()">
                <ion-icon name="log-out-outline"></ion-icon>
                تسجيل الخروج
            </button>
        </section>
        
        <!-- Ride Request Screen -->
<section id="ride-request-screen" class="screen hidden">
    <div class="card">
        <h2 class="card-title">
            <ion-icon name="navigate-outline"></ion-icon>
            طلب رحلة جديدة
        </h2>
        
        <!-- إضافة عنصر تحكم للخريطة -->
        <div class="map-wrapper">
            <div class="map-container" id="ride-map">
                <!-- سيتم تهيئة الخريطة هنا -->
            </div>
            <div class="map-controls">
                <button class="map-control-btn" onclick="recenterMap()" title="تحديد موقعك الحالي">
                    <ion-icon name="locate-outline"></ion-icon>
                </button>
                <button class="map-control-btn" onclick="refreshLocation()" title="تحديث الموقع">
                    <ion-icon name="refresh-outline"></ion-icon>
                </button>
            </div>
        </div>
        
        <div class="mb-3">
            <h4 class="form-label">اختر نوع المركبة:</h4>
            <div class="vehicle-options">
                <div class="vehicle-option" data-type="tuktuk" onclick="selectVehicle('tuktuk')">
                    <div class="vehicle-icon"></div>
                    <div class="vehicle-name">توك توك</div>
                    <div class="vehicle-price">5,000 SDG</div>
                </div>
                
                <div class="vehicle-option" data-type="economy" onclick="selectVehicle('economy')">
                    <div class="vehicle-icon"></div>
                    <div class="vehicle-name">اقتصادية</div>
                    <div class="vehicle-price">6,000 SDG</div>
                </div>
                
                <div class="vehicle-option" data-type="comfort" onclick="selectVehicle('comfort')">
                    <div class="vehicle-icon"></div>
                    <div class="vehicle-name">متوسطة</div>
                    <div class="vehicle-price">7,000 SDG</div>
                </div>
                
                <div class="vehicle-option" data-type="vip" onclick="selectVehicle('vip')">
                    <div class="vehicle-icon">⭐</div>
                    <div class="vehicle-name">VIP</div>
                    <div class="vehicle-price">10,000 SDG</div>
                </div>
            </div>
        </div>
        
        <div id="price-calculation" class="price-breakdown hidden">
            <div class="price-row">
                <span>المسافة:</span>
                <span id="distance-display">0 كم</span>
            </div>
            <div class="price-row">
                <span>السعر الأساسي:</span>
                <span id="base-price-display">0 SDG</span>
            </div>
            <div class="price-row">
                <span>رسوم إضافية:</span>
                        <span id="extra-price-display">0 SDG</span>
                    </div>
                    <div class="price-row">
                        <span>المجموع:</span>
                        <span id="total-price-display">0 SDG</span>
                    </div>
                </div>
                
                <button id="confirm-ride-btn" class="btn btn-primary" onclick="confirmRide()" disabled>
                    <ion-icon name="search-outline"></ion-icon>
                    بحث عن سائق
                </button>
                
                <button class="btn btn-outline mt-2" onclick="goHome()">
                    <ion-icon name="arrow-back-outline"></ion-icon>
                    إلغاء والعودة
                </button>
            </div>
        </section>

        <style>
            /* إضافة أنماط CSS جديدة */
            .map-wrapper {
                position: relative;
                margin-bottom: 24px;
                border-radius: var(--radius);
                overflow: hidden;
                border: 2px solid var(--gray-light);
            }
            
            .map-controls {
                position: absolute;
                bottom: 15px;
                right: 15px;
                display: flex;
                flex-direction: column;
                gap: 10px;
                z-index: 1000;
            }
            
            .map-control-btn {
                width: 45px;
                height: 45px;
                background: white;
                border: 2px solid var(--gray-light);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                box-shadow: var(--shadow);
                transition: all 0.3s ease;
                color: var(--primary);
                font-size: 20px;
            }
            
            .map-control-btn:hover {
                background: var(--primary-light);
                border-color: var(--primary);
                transform: scale(1.05);
            }
            
            .map-control-btn:active {
                transform: scale(0.95);
            }
            
            /* تحسين عرض الخريطة */
            .map-container {
                width: 100%;
                height: 280px;
                border-radius: var(--radius);
                overflow: hidden;
                position: relative;
            }
            
            /* إضافة أنماط للخط المحسّن */
            .route-line {
                stroke-dasharray: 10, 10;
                animation: dash 1s linear infinite;
            }
            
            @keyframes dash {
                from {
                    stroke-dashoffset: 20;
                }
                to {
                    stroke-dashoffset: 0;
                }
            }
            
            .route-info {
                background: white;
                padding: 10px 15px;
                border-radius: 8px;
                margin-top: 10px;
                border-right: 3px solid var(--primary);
                box-shadow: var(--shadow);
                font-size: 14px;
            }
            
            /* تحسين عرض الأسعار */
            .vehicle-price {
                color: var(--primary);
                font-weight: 800;
                font-size: 16px;
                direction: ltr;
                text-align: center;
            }
            
            .price-breakdown .price-row:last-child {
                border-bottom: none;
                font-weight: 800;
                font-size: 20px;
                color: var(--primary);
                direction: ltr;
                text-align: left;
            }
            
            .price-breakdown .price-row span:last-child {
                font-family: 'Tajawal', 'Segoe UI', Arial, sans-serif;
                letter-spacing: 0.5px;
            }
            
            /* تحسين التجاوب */
            @media (max-width: 480px) {
                .map-container {
                    height: 240px;
                }
                
                .map-control-btn {
                    width: 40px;
                    height: 40px;
                    font-size: 18px;
                }
            }
            
            /* مؤشر التحميل */
            .location-loading {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(255, 255, 255, 0.9);
                padding: 20px;
                border-radius: var(--radius);
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 10px;
                z-index: 1000;
                box-shadow: var(--shadow);
            }
            
            .location-loading .loading {
                width: 30px;
                height: 30px;
                border: 3px solid var(--primary-light);
                border-top-color: var(--primary);
            }
        </style>
        
        <script>
            // إضافة متغيرات جديدة
            let mapInitialized = false;
            let locationUpdateInterval = null;
            let currentRoute = null;
            let routePolyline = null;
            
            // --- تعديل دالة requestRide ---
            function requestRide() {
                if (!currentUser || !currentUser.is_verified) {
                    showNotification('يجب تفعيل حسابك أولاً لطلب رحلة', 'error');
                    return;
                }
                
                showScreen('ride-request-screen');
                
                // إعادة تعيين المتغيرات
                selectedVehicleType = null;
                destinationPosition = null;
                currentRoute = null;
                document.querySelectorAll('.vehicle-option').forEach(option => {
                    option.classList.remove('selected');
                });
                document.getElementById('price-calculation').classList.add('hidden');
                document.getElementById('confirm-ride-btn').disabled = true;
                
                // إزالة معلومات المسار القديمة
                const oldRouteInfo = document.querySelector('.route-info');
                if (oldRouteInfo) {
                    oldRouteInfo.remove();
                }
                
                // تهيئة الخريطة بعد تأخير بسيط
                setTimeout(() => {
                    initRideMap();
                }, 100);
            }
            
            // --- تعديل دالة initRideMap ---
            function initRideMap() {
    // 1. تنظيف الخريطة السابقة لمنع التداخل أو تعليق التطبيق
    if (rideMap) {
        rideMap.remove();
        rideMap = null;
        userMarker = null;
        destinationMarker = null;
    }
    
    // 2. إنشاء الخريطة وتعديل إعدادات العرض
    rideMap = L.map('ride-map', {
        zoomControl: false, // سنعتمد على أزرارنا الخاصة للتحكم
        tap: true
    }).setView([15.5007, 32.5599], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
    }).addTo(rideMap);
    
    // 3. تحديد الموقع بدقة عالية فوراً
    if (navigator.geolocation) {
        showNotification("جاري تحديد موقعك بدقة...", "info");
        
        navigator.geolocation.getCurrentPosition((position) => {
            userPos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            
            // تحريك الكاميرا لموقع المستخدم بنعومة
            rideMap.flyTo([userPos.lat, userPos.lng], 16);
            
            // إضافة مؤشر موقع المستخدم (النقطة الزرقاء)
            userMarker = L.marker([userPos.lat, userPos.lng], {
                icon: L.divIcon({
                    html: '<div style="background:#4f46e5; width:15px; height:15px; border-radius:50%; border:3px solid white; box-shadow:0 0 10px rgba(0,0,0,0.3);"></div>',
                    className: 'user-dot'
                })
            }).addTo(rideMap).bindPopup("أنت هنا").openPopup();
            
        }, (err) => {
            showNotification("يرجى تفعيل الـ GPS لتحديد موقعك", "danger");
        }, {
            enableHighAccuracy: true, // أهم خاصية للدقة
            timeout: 10000,
            maximumAge: 0
        });
    }
    
    // 4. معالجة النقر لتحديد الوجهة
    rideMap.on('click', (e) => {
        if (destinationMarker) rideMap.removeLayer(destinationMarker);
        
        destinationMarker = L.marker(e.latlng).addTo(rideMap);
        
        // تفعيل زر الطلب وحساب التكلفة التقديرية
        document.getElementById('confirm-ride-btn').disabled = false;
        showNotification("تم تحديد وجهة الوصول بنجاح", "success");
    });

    // 5. حل مشكلة ظهور المربعات الرمادية عند فتح الشاشة
    setTimeout(() => {
        rideMap.invalidateSize();
    }, 400);
}
            
            // --- دالة جديدة: جلب الموقع الحالي ---
            function getCurrentLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            userPosition = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            
                            // تحديث عرض الخريطة
                            rideMap.setView([userPosition.lat, userPosition.lng], 15);
                            
                            // إضافة علامة للمستخدم
                            addUserMarker();
                            
                            // إزالة مؤشر التحميل
                            const loadingIndicator = document.querySelector('.location-loading');
                            if (loadingIndicator) {
                                loadingIndicator.remove();
                            }
                            
                            // بدء تحديث الموقع تلقائياً
                            startLocationTracking();
                            
                        },
                        (error) => {
                            // إزالة مؤشر التحميل
                            const loadingIndicator = document.querySelector('.location-loading');
                            if (loadingIndicator) {
                                loadingIndicator.remove();
                            }
                            
                            // عرض رسالة خطأ
                            const errorMsg = document.createElement('div');
                            errorMsg.className = 'location-loading';
                            errorMsg.style.background = '#fee2e2';
                            errorMsg.style.color = '#dc2626';
                            errorMsg.innerHTML = `
                                <ion-icon name="warning" style="font-size: 24px;"></ion-icon>
                                <div>تعذر تحديد الموقع</div>
                                <button onclick="retryLocation()" style="
                                    background: var(--primary);
                                    color: white;
                                    border: none;
                                    padding: 8px 16px;
                                    border-radius: 8px;
                                    margin-top: 10px;
                                    cursor: pointer;
                                ">
                                    إعادة المحاولة
                                </button>
                            `;
                            document.getElementById('ride-map').appendChild(errorMsg);
                            
                            console.error('خطأ في الوصول للموقع:', error);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                } else {
                    showNotification('المتصفح لا يدعم خدمة الموقع الجغرافي', 'warning');
                }
            }
            
            // --- دالة جديدة: إعادة المحاولة ---
            function retryLocation() {
                const errorMsg = document.querySelector('.location-loading');
                if (errorMsg) {
                    errorMsg.remove();
                }
                
                const loadingIndicator = document.createElement('div');
                loadingIndicator.className = 'location-loading';
                loadingIndicator.innerHTML = `
                    <div class="loading"></div>
                    <div>جاري تحديد موقعك...</div>
                `;
                document.getElementById('ride-map').appendChild(loadingIndicator);
                
                getCurrentLocation();
            }
            
            // --- دالة جديدة: إضافة علامة المستخدم ---
            function addUserMarker() {
                if (userMarker) {
                    userMarker.setLatLng([userPosition.lat, userPosition.lng]);
                } else {
                    userMarker = L.marker([userPosition.lat, userPosition.lng], {
                        icon: L.divIcon({
                            html: '<div style="background: #4f46e5; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;"></div>',
                            className: 'user-marker',
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        })
                    }).addTo(rideMap).bindPopup('موقعك الحالي').openPopup();
                }
            }
            
            // --- دالة جديدة: تتبع الموقع ---
            function startLocationTracking() {
                if (locationUpdateInterval) {
                    clearInterval(locationUpdateInterval);
                }
                
                // تحديث الموقع كل 30 ثانية
                locationUpdateInterval = setInterval(async () => {
                    if (navigator.geolocation && rideMap && userMarker) {
                        navigator.geolocation.getCurrentPosition(async (position) => {
                            const newPos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            
                            // تحديث موقع المستخدم إذا تغير بشكل ملحوظ
                            if (calculateDistance(userPosition, newPos) > 0.01) { // أكثر من 10 أمتار
                                userPosition = newPos;
                                addUserMarker();
                                
                                // إذا كانت هناك وجهة محددة، إعادة حساب المسار
                                if (destinationPosition) {
                                    await calculateRealRoute(userPosition, destinationPosition);
                                    if (selectedVehicleType) {
                                        calculateRidePrice();
                                    }
                                }
                            }
                        });
                    }
                }, 30000);
            }
            
            // --- تعديل دالة setDestination ---
            async function setDestination(lat, lng) {
                destinationPosition = { lat, lng };
                
                if (destinationMarker) {
                    destinationMarker.setLatLng([lat, lng]);
                } else {
                    destinationMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            html: '<div style="background: #ef4444; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;"></div>',
                            className: 'destination-marker',
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        })
                    }).addTo(rideMap).bindPopup('نقطة الوصول').openPopup();
                }
                
                // إذا كان هناك موقع مستخدم، حساب المسار الحقيقي
                if (userPosition) {
                    await calculateRealRoute(userPosition, destinationPosition);
                }
                
                if (selectedVehicleType) {
                    calculateRidePrice();
                }
            }
            
            // --- دالة جديدة: حساب المسار الحقيقي ---
            async function calculateRealRoute(start, end) {
                try {
                    // إضافة مؤشر تحميل
                    const loadingIndicator = document.createElement('div');
                    loadingIndicator.className = 'location-loading';
                    loadingIndicator.innerHTML = `
                        <div class="loading"></div>
                        <div>جاري حساب المسار...</div>
                    `;
                    document.getElementById('ride-map').appendChild(loadingIndicator);
                    
                    // استخدام OSRM للحصول على المسار الحقيقي
                    const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`;
                    
                    const response = await fetch(osrmUrl);
                    const data = await response.json();
                    
                    // إزالة مؤشر التحميل
                    loadingIndicator.remove();
                    
                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        
                        // حفظ بيانات المسار
                        currentRoute = {
                            distance: route.distance / 1000, // تحويل إلى كم
                            duration: route.duration / 60, // تحويل إلى دقائق
                            geometry: route.geometry
                        };
                        
                        // رسم المسار على الخريطة
                        drawRouteOnMap(route.geometry);
                        
                        // تحديث عرض المسافة
                        updateDistanceDisplay(currentRoute.distance);
                        
                        showNotification(`✓ المسار المحسوب: ${currentRoute.distance.toFixed(1)} كم`, 'success');
                        
                        return currentRoute;
                    } else {
                        throw new Error('لم يتم العثور على مسار');
                    }
                    
                } catch (error) {
                    console.error('خطأ في حساب المسار:', error);
                    
                    // استخدام المسافة المستقيمة كبديل
                    const straightDistance = calculateDistance(start, end);
                    drawStraightLine(start, end);
                    updateDistanceDisplay(straightDistance);
                    
                    showNotification('⚠️ استخدام المسافة التقريبية', 'warning');
                    
                    return {
                        distance: straightDistance,
                        duration: (straightDistance / 40) * 60, // تقدير الوقت (سرعة 40 كم/س)
                        geometry: null
                    };
                }
            }
            
            // --- دالة جديدة: رسم المسار على الخريطة ---
            function drawRouteOnMap(geometry) {
                // إزالة المسار القديم إذا كان موجوداً
                if (routePolyline) {
                    rideMap.removeLayer(routePolyline);
                }
                
                if (window.routeLine) {
                    rideMap.removeLayer(window.routeLine);
                }
                
                // تحويل إحداثيات GeoJSON إلى تنسيق Leaflet
                const coordinates = geometry.coordinates.map(coord => [coord[1], coord[0]]);
                
                // رسم المسار بخط متقطع أجمل
                routePolyline = L.polyline(coordinates, {
                    color: '#4f46e5',
                    weight: 4,
                    opacity: 0.8,
                    dashArray: '10, 10',
                    lineCap: 'round',
                    lineJoin: 'round',
                    className: 'route-line'
                }).addTo(rideMap);
                
                // إضافة معلومات المسار
                if (currentRoute) {
                    addRouteInfo();
                }
            }
            
            // --- دالة جديدة: رسم خط مستقيم (بديل) ---
            function drawStraightLine(start, end) {
                if (routePolyline) {
                    rideMap.removeLayer(routePolyline);
                }
                
                routePolyline = L.polyline([
                    [start.lat, start.lng],
                    [end.lat, end.lng]
                ], {
                    color: '#4f46e5',
                    weight: 3,
                    opacity: 0.7,
                    dashArray: '10, 10',
                    lineCap: 'round'
                }).addTo(rideMap);
            }
            
            // --- دالة جديدة: تحديث عرض المسافة ---
            function updateDistanceDisplay(distance) {
                document.getElementById('distance-display').textContent = 
                    `${Math.round(distance * 10) / 10} كم`;
                
                // إذا كان هناك مسار حقيقي، إضافة معلومات إضافية
                if (currentRoute) {
                    const duration = Math.round(currentRoute.duration);
                    const distanceElement = document.getElementById('distance-display');
                    distanceElement.title = `الوقت المقدر: ${duration} دقيقة`;
                    
                    // إضافة وقت الرحلة بجانب المسافة
                    const parentElement = distanceElement.parentElement;
                    const existingDuration = parentElement.querySelector('.duration-info');
                    
                    if (!existingDuration) {
                        const durationSpan = document.createElement('span');
                        durationSpan.className = 'duration-info';
                        durationSpan.style.cssText = `
                            font-size: 12px;
                            color: var(--gray);
                            margin-right: 5px;
                        `;
                        durationSpan.textContent = `(${duration} دقيقة)`;
                        parentElement.insertBefore(durationSpan, distanceElement);
                    } else {
                        existingDuration.textContent = `(${duration} دقيقة)`;
                    }
                }
            }
            
            // --- دالة جديدة: إضافة معلومات المسار ---
            function addRouteInfo() {
                // إزالة معلومات المسار القديمة إذا كانت موجودة
                const oldInfo = document.querySelector('.route-info');
                if (oldInfo) {
                    oldInfo.remove();
                }
                
                if (!currentRoute) return;
                
                // إنشاء عنصر معلومات المسار
                const routeInfo = document.createElement('div');
                routeInfo.className = 'route-info';
                routeInfo.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--primary);"> المسار المحسوب</strong>
                            <div style="font-size: 12px; color: var(--gray); margin-top: 4px;">
                                ${currentRoute.distance.toFixed(1)} كم • ${Math.round(currentRoute.duration)} دقيقة
                            </div>
                        </div>
                        <button onclick="toggleRouteDetails()" style="
                            background: var(--primary-light);
                            border: none;
                            border-radius: 6px;
                            padding: 5px 10px;
                            font-size: 12px;
                            cursor: pointer;
                            color: var(--primary);
                        ">
                            تفاصيل
                        </button>
                    </div>
                `;
                
                // إضافة المعلومات تحت الخريطة
                const mapContainer = document.querySelector('.map-wrapper');
                if (mapContainer) {
                    mapContainer.appendChild(routeInfo);
                }
            }
            
            // --- دالة جديدة: عرض تفاصيل المسار ---
            function toggleRouteDetails() {
                if (currentRoute) {
                    const routeInfo = document.querySelector('.route-info');
                    const existingDetails = routeInfo.querySelector('.route-details');
                    
                    if (existingDetails) {
                        existingDetails.remove();
                    } else {
                        const details = `
                            <div style="margin-top: 10px; padding: 10px; background: #f8fafc; border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>المسافة:</span>
                                    <strong>${currentRoute.distance.toFixed(1)} كم</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>الوقت المقدر:</span>
                                    <strong>${Math.round(currentRoute.duration)} دقيقة</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>متوسط السرعة:</span>
                                    <strong>${Math.round((currentRoute.distance / currentRoute.duration) * 60)} كم/س</strong>
                                </div>
                            </div>
                        `;
                        
                        const detailsDiv = document.createElement('div');
                        detailsDiv.className = 'route-details';
                        detailsDiv.innerHTML = details;
                        routeInfo.appendChild(detailsDiv);
                    }
                }
            }
            
            // --- تعديل دالة calculateRidePrice ---
            function calculateRidePrice() {
                if (!userPosition || !destinationPosition || !selectedVehicleType) return;
                
                // استخدام المسافة الحقيقية إذا كانت متاحة، وإلا استخدام المسافة المستقيمة
                let distance;
                if (currentRoute && currentRoute.distance) {
                    distance = currentRoute.distance;
                } else {
                    distance = calculateDistance(userPosition, destinationPosition);
                }
                
                const vehicle = VEHICLE_PRICES[selectedVehicleType];
                const additionalKm = Math.max(0, distance - 1);
                const basePrice = vehicle.base;
                const extraPrice = additionalKm * vehicle.perKm;
                const totalPrice = basePrice + extraPrice;
                
                // عرض تفاصيل السعر مع تقريب الأرقام
                document.getElementById('price-calculation').classList.remove('hidden');
                document.getElementById('distance-display').textContent = `${Math.round(distance * 10) / 10} كم`;
                document.getElementById('base-price-display').textContent = formatPrice(basePrice);
                document.getElementById('extra-price-display').textContent = formatPrice(Math.round(extraPrice));
                document.getElementById('total-price-display').textContent = formatPrice(Math.round(totalPrice));
                
                document.getElementById('confirm-ride-btn').disabled = false;
            }
            
            // --- دالة جديدة: حساب المسافة ---
            function calculateDistance(pos1, pos2) {
                // حساب المسافة باستخدام صيغة Haversine
                const R = 6371; // نصف قطر الأرض بالكيلومترات
                const dLat = toRad(pos2.lat - pos1.lat);
                const dLon = toRad(pos2.lng - pos1.lng);
                const a = 
                    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(toRad(pos1.lat)) * Math.cos(toRad(pos2.lat)) * 
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                const distance = R * c;
                
                return distance;
            }
            
            function toRad(degrees) {
                return degrees * Math.PI / 180;
            }
            
            // --- دالة جديدة: تنسيق السعر ---
            function formatPrice(amount) {
                // تقريب السعر وإزالة الكسور
                const roundedAmount = Math.round(amount);
                
                // تنسيق الرقم بفواصل الآلاف
                return `${roundedAmount.toLocaleString('ar-EG')} SDG`;
            }
            
            // --- دالة جديدة: إعادة التمركز ---
            function recenterMap() {
                if (userPosition && rideMap) {
                    rideMap.setView([userPosition.lat, userPosition.lng], 15);
                    
                    // إذا كان هناك مسار، تضمينه في العرض
                    if (routePolyline && currentRoute) {
                        rideMap.fitBounds(routePolyline.getBounds());
                    }
                    
                    showNotification('تم التمركز على موقعك', 'success');
                } else {
                    showNotification('لم يتم تحديد موقعك بعد', 'warning');
                }
            }
            
            // --- دالة جديدة: تحديث الموقع ---
            async function refreshLocation() {
                if (navigator.geolocation) {
                    showNotification('جاري تحديث الموقع...', 'info');
                    
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            userPosition = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            
                            addUserMarker();
                            rideMap.setView([userPosition.lat, userPosition.lng], 15);
                            
                            // إذا كان هناك وجهة محددة، إعادة حساب المسار
                            if (destinationPosition) {
                                await calculateRealRoute(userPosition, destinationPosition);
                            }
                            
                            showNotification('تم تحديث موقعك بنجاح', 'success');
                        },
                        (error) => {
                            showNotification('تعذر تحديث الموقع', 'error');
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 5000
                        }
                    );
                }
            }
            
            // --- دالة جديدة: تغيير نوع المركبة ---
            function selectVehicle(type) {
                selectedVehicleType = type;
                
                document.querySelectorAll('.vehicle-option').forEach(option => {
                    option.classList.remove('selected');
                });
                document.querySelector(`.vehicle-option[data-type="${type}"]`).classList.add('selected');
                
                if (destinationPosition) {
                    calculateRidePrice();
                }
            }
            
            // --- تعديل دالة goHome ---
            function goHome() {
                // إيقاف تحديث الموقع
                if (locationUpdateInterval) {
                    clearInterval(locationUpdateInterval);
                    locationUpdateInterval = null;
                }
                
                // إزالة المسار إذا كان موجوداً
                if (routePolyline) {
                    rideMap.removeLayer(routePolyline);
                    routePolyline = null;
                }
                
                if (window.routeLine) {
                    rideMap.removeLayer(window.routeLine);
                    window.routeLine = null;
                }
                
                // إزالة معلومات المسار
                const routeInfo = document.querySelector('.route-info');
                if (routeInfo) {
                    routeInfo.remove();
                }
                
                // إعادة تعيين المتغيرات
                currentRoute = null;
                
                if (currentUser) {
                    showScreen('home-screen');
                } else if (currentDriver) {
                    showScreen('driver-dashboard-screen');
                } else {
                    showScreen('welcome-screen');
                }
            }
        </script>
        
        <!-- Driver Dashboard -->
        <section id="driver-dashboard-screen" class="screen hidden">
            <div class="card">
                <div class="user-profile">
                    <div class="user-avatar" id="driver-avatar">?</div>
                    <div class="user-info">
                        <h3 id="driver-name">سائق</h3>
                        <p id="driver-car-info">مركبة</p>
                    </div>
                </div>
                
                <div class="driver-status">
                    <div id="driver-status-indicator" class="status-indicator status-offline">
                        <span class="status-dot"></span>
                        <span id="driver-status-text">غير متصل</span>
                    </div>
                    
                    <button id="toggle-online-btn" class="btn btn-driver" onclick="toggleDriverStatus()">
                        <ion-icon name="power-outline"></ion-icon>
                        تفعيل وضع العمل
                    </button>
                </div>
                
                <div class="driver-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="driver-balance">0</div>
                        <div class="stat-label">رصيدك (SDG)</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-value" id="today-trips">0</div>
                        <div class="stat-label">رحلات اليوم</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-value" id="today-earnings">0</div>
                        <div class="stat-label">أرباح اليوم</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-value" id="total-trips">0</div>
                        <div class="stat-label">إجمالي الرحلات</div>
                    </div>
                </div>
                
                <!-- زر تفعيل إشعارات السائق في لوحة التحكم -->
                <button id="driver-notification-activation" class="btn btn-secondary" onclick="setupDriverNotifications()">
                    <ion-icon name="notifications-outline"></ion-icon>
                    تفعيل إشعارات الرحلات
                </button>
                
                <button class="btn btn-outline mt-2" onclick="showDriverProfile()">
                    <ion-icon name="person-outline"></ion-icon>
                    الملف الشخصي
                </button>
                
                <button class="btn btn-outline mt-2" onclick="logoutDriver()">
                    <ion-icon name="log-out-outline"></ion-icon>
                    تسجيل خروج السائق
                </button>
            </div>
        </section>
    </div>
    
    <!-- PWA Install Prompt -->
    <div id="pwa-install-prompt" style="display: none; position: fixed; bottom: 20px; left: 20px; right: 20px; background: white; padding: 16px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000;">
        <div style="text-align: center;">
            <h4 style="margin-bottom: 8px; color: var(--primary);">تثبيت تطبيق ترحال</h4>
            <p style="margin-bottom: 16px; color: var(--gray); font-size: 14px;">
                ثبّت التطبيق لاستخدامه بدون إنترنت وإشعارات فورية
            </p>
            <div style="display: flex; gap: 8px;">
                <button onclick="installPWA()" style="flex: 1; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-family: 'Tajawal'; font-weight: 700;">
                    تثبيت الآن
                </button>
                <button onclick="hideInstallPrompt()" style="flex: 1; padding: 12px; background: transparent; color: var(--gray); border: 1px solid var(--gray-light); border-radius: 8px; font-family: 'Tajawal';">
                    لاحقاً
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="notification-area"></div>
    
    <!-- Ride Request Modal (For Driver) -->
    <div id="incoming-ride-modal" class="overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <div style="font-size: 48px; margin-bottom: 16px;"></div>
                <h2 class="modal-title">طلب رحلة جديد!</h2>
                <p class="modal-subtitle">لديك 40 ثانية للرد</p>
            </div>
            
            <div class="card" style="background: #fef2f2;">
                <div id="ride-details">
                    <!-- سيتم تعبئة تفاصيل الرحلة هنا -->
                </div>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button class="btn btn-driver" onclick="acceptRide()" style="flex: 1;">
                    <ion-icon name="checkmark-outline"></ion-icon>
                    قبول الرحلة
                </button>
                <button class="btn btn-danger" onclick="declineRide()" style="flex: 1;">
                    <ion-icon name="close-outline"></ion-icon>
                    رفض
                </button>
            </div>
            
            <div class="countdown" style="text-align: center; font-size: 32px; font-weight: 800; color: var(--danger); margin-top: 20px;">
                40
            </div>
        </div>
    </div>
    
    <!-- Active Trip Modal -->
    <div id="active-trip-modal" class="overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <div style="font-size: 48px; margin-bottom: 16px;"></div>
                <h2 class="modal-title">الرحلة سارية الآن</h2>
            </div>
            
            <div id="trip-details">
                <!-- سيتم تعبئة تفاصيل الرحلة هنا -->
            </div>
        </div>
    </div>

    <script>
        // --- Supabase Configuration ---
        const SB_URL = 'https://zsmlyiygjagmhnglrhoa.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzbWx5aXlnamFnbWhuZ2xyaG9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NDc3NjMsImV4cCI6MjA4MTUyMzc2M30.QviVinAng-ILq0umvI5UZCFEvNpP3nI0kW_hSaXxNps';
        
        const tarhalDB = supabase.createClient(SB_URL, SB_KEY);
        
        // --- Application State ---
        let currentUser = null;
        let currentDriver = null;
        let isDriverOnline = false;
        let selectedVehicleType = null;
        let rideMap = null;
        let userMarker = null;
        let destinationMarker = null;
        let userPosition = null;
        let destinationPosition = null;
        let currentRideId = null;
        let rideCountdownInterval = null;
        let rideTimeout = 40;
        let registeredPhone = null;
        let deferredPrompt = null;
        
        // نظام الإشعارات
        let notificationManager = null;
        let soundManager = null;
        
        // Vehicle prices
        const VEHICLE_PRICES = {
            tuktuk: { base: 5000, perKm: 2000, name: 'توك توك', icon: '' },
            economy: { base: 6000, perKm: 3000, name: 'اقتصادية', icon: '' },
            comfort: { base: 7000, perKm: 3500, name: 'متوسطة', icon: '' },
            vip: { base: 10000, perKm: 5000, name: 'VIP', icon: '⭐' }
        };
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log(' ترحال زونا - تهيئة التطبيق');
            
            // تهيئة أنظمة الأساسية
            initPWA();
            checkAuth();
            
            // تحميل أنظمة الإشعارات بعد تأخير بسيط
            setTimeout(() => {
                loadNotificationSystem();
            }, 1000);
        });
        
      // --- نظام PWA الأساسي ---
async function initPWA() {
    if (!('serviceWorker' in navigator)) return;

    try {
        const registration = await navigator.serviceWorker.register(
            '/service-worker.js',
            { scope: '/' }
        );

        console.log('✅ Service Worker مسجل بنجاح');

        // 🔄 إجبار التحديث عند كل فتح
        registration.update();

        // تحميل Firebase Messaging
        await loadFirebase();

    } catch (error) {
        console.error('❌ خطأ في تسجيل Service Worker:', error);
    }
            
            // معالجة تثبيت PWA
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                setTimeout(() => {
                    if (deferredPrompt) {
                        showInstallPrompt();
                    }
                }, 5000);
            });
            
            window.addEventListener('appinstalled', () => {
                console.log('✅ PWA مثبت');
                localStorage.setItem('pwa_installed', 'true');
                showNotification('تم تثبيت التطبيق بنجاح!', 'success');
            });
        }
        
        async function loadFirebase() {
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyBxQLDLqr4W3lApfYLPjSV5It7925a9Rr0",
                    authDomain: "double-carport-476915-j7.firebaseapp.com",
                    projectId: "double-carport-476915-j7",
                    storageBucket: "double-carport-476915-j7.firebasestorage.app",
                    messagingSenderId: "122641462099",
                    appId: "1:122641462099:web:345b777a88757d3ef7e7a6"
                };
                
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig);
                }
                console.log('✅ Firebase مهيأ');
            } catch (error) {
                console.log('⚠️ Firebase غير متاح، الاستمرار بدون إشعارات Firebase');
            }
        }
        
        // --- نظام الإشعارات المتقدم ---
        async function loadNotificationSystem() {
            try {
                // إنشاء مدير الإشعارات
                notificationManager = new TarhalNotificationManager();
                await notificationManager.initialize();
                window.notificationManager = notificationManager;
                
                console.log('✅ نظام الإشعارات جاهز');
                
                // إنشاء مدير الصوت
                soundManager = new TarhalSoundManager();
                window.soundManager = soundManager;
                
                // عرض نموذج التفعيل إذا لزم الأمر
                if (!localStorage.getItem('tarhal_notifications_asked')) {
                    setTimeout(() => {
                        notificationManager.showActivationPrompt();
                    }, 3000);
                }
                
            } catch (error) {
                console.error('❌ خطأ في تحميل نظام الإشعارات:', error);
            }
        }
        
        // --- PWA Functions ---
        function showInstallPrompt() {
            const prompt = document.getElementById('pwa-install-prompt');
            if (prompt) {
                prompt.style.display = 'block';
            }
        }
        
        function hideInstallPrompt() {
            const prompt = document.getElementById('pwa-install-prompt');
            if (prompt) {
                prompt.style.display = 'none';
            }
        }
        
        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    showNotification('تم تثبيت التطبيق بنجاح!', 'success');
                }
                
                deferredPrompt = null;
                hideInstallPrompt();
            }
        }
        
        // --- Screen Navigation ---
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
            
            // تحديث واجهة السائق عند التبديل
            if (screenId === 'driver-dashboard-screen') {
                updateDriverUI();
            }
        }
        
        function showWelcomeScreen() {
            showScreen('welcome-screen');
        }
        
        function showCustomerLogin() {
            showScreen('customer-login-screen');
            document.getElementById('customer-phone').focus();
        }
        
        function showCustomerRegister() {
            showScreen('customer-register-screen');
            document.getElementById('verification-section').classList.add('hidden');
            document.getElementById('register-fullname').focus();
            document.getElementById('customerRegisterForm').style.opacity = '1';
            document.querySelector('#customerRegisterForm button').disabled = false;
        }
        
        function showDriverLogin() {
            showScreen('driver-login-screen');
            document.getElementById('driver-phone').focus();
        }
        
        function showDriverRegisterInfo() {
            showScreen('driver-register-info-screen');
        }
        
        function goHome() {
            if (currentUser) {
                showScreen('home-screen');
            } else if (currentDriver) {
                showScreen('driver-dashboard-screen');
            } else {
                showScreen('welcome-screen');
            }
        }
        
        // --- تحديث واجهة السائق ---
        function updateDriverUI() {
            if (currentDriver) {
                // إظهار زر تفعيل الإشعارات إذا لم يكن مفعلاً
                const notificationBtn = document.getElementById('driver-notification-activation');
                if (notificationBtn && Notification.permission !== 'granted') {
                    notificationBtn.classList.remove('hidden');
                }
                
                // إظهار زر اختبار الإشعارات
                const testBtn = document.getElementById('driver-notification-btn');
                if (testBtn) {
                    testBtn.classList.remove('hidden');
                }
            }
        }
        
        // --- دوال الإشعارات المتقدمة ---
        async function testAdvancedNotifications() {
            if (notificationManager) {
                await notificationManager.sendTestNotification();
            } else {
                showNotification('⚠️ نظام الإشعارات غير جاهز بعد', 'warning');
            }
        }
        
        async function setupDriverNotifications() {
            if (!notificationManager) {
                showNotification('⚠️ جاري تهيئة نظام الإشعارات...', 'warning');
                await loadNotificationSystem();
            }
            
            if (notificationManager) {
                await notificationManager.enableAllFeatures();
                
                // إذا كان سائقاً، تسجيله في النظام
                if (currentDriver) {
                    await registerDriverForNotifications();
                }
            }
        }
        
        async function registerDriverForNotifications() {
            try {
                if (currentDriver && notificationManager) {
                    // الحصول على إذن الإشعارات
                    const permission = await Notification.requestPermission();
                    
                    if (permission === 'granted') {
                        // تسجيل السائق في قاعدة البيانات للإشعارات
                        await tarhalDB
                            .from('driver_notifications')
                            .upsert({
                                driver_id: currentDriver.id,
                                notification_enabled: true,
                                last_active: new Date().toISOString()
                            }, { onConflict: 'driver_id' });
                        
                        showNotification('✅ تم تفعيل إشعارات السائق بنجاح', 'success');
                        
                        // إخفاء زر التفعيل
                        const btn = document.getElementById('driver-notification-activation');
                        if (btn) btn.classList.add('hidden');
                        
                        return true;
                    }
                }
            } catch (error) {
                console.error('❌ خطأ في تسجيل السائق:', error);
                showNotification('⚠️ تعذر تفعيل الإشعارات', 'error');
            }
            return false;
        }
        
        // --- دوال الصوت ---
        function toggleAppSound() {
            if (soundManager) {
                const enabled = soundManager.toggle();
                updateSoundButton();
                
                const slider = document.getElementById('volume-slider');
                if (enabled) {
                    slider.style.display = 'block';
                    setTimeout(() => slider.style.display = 'none', 3000);
                } else {
                    slider.style.display = 'none';
                }
            }
        }
        
        function updateSoundButton() {
            if (!soundManager) return;
            
            const icon = document.getElementById('sound-icon');
            const enabled = soundManager.enabled;
            
            icon.name = enabled ? 'volume-high' : 'volume-mute';
            document.getElementById('sound-toggle').style.background = 
                enabled ? '#4f46e5' : '#6b7280';
        }
        
        function changeVolume(value) {
            if (soundManager) {
                const volume = value / 100;
                soundManager.setVolume(volume);
                
                if (volume > 0 && soundManager.enabled) {
                    soundManager.play('notification', { volume: volume * 0.5 });
                }
            }
        }
        
        // --- Customer Functions ---
        async function loginCustomer() {
            const phone = document.getElementById('customer-phone').value.trim();
            const password = document.getElementById('customer-password').value;
            
            if (!phone || !password) {
                showNotification('الرجاء إدخال رقم الواتساب وكلمة المرور', 'error');
                return;
            }
            
            if (!isValidSudanesePhone(phone)) {
                showNotification('الرجاء إدخال رقم واتساب سوداني صحيح', 'error');
                return;
            }
            
            const loginBtn = document.querySelector('#customerLoginForm button');
            const originalText = loginBtn.innerHTML;
            loginBtn.innerHTML = '<span class="loading"></span> جاري تسجيل الدخول...';
            loginBtn.disabled = true;
            
            try {
                const { data: customer, error } = await tarhalDB
                    .from('customers')
                    .select('*')
                    .eq('phone', phone)
                    .single();
                
                if (error) {
                    showNotification('رقم الواتساب غير مسجل', 'error');
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                    return;
                }
                
                if (customer.password !== password) {
                    showNotification('كلمة المرور غير صحيحة', 'error');
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                    return;
                }
                
                if (!customer.is_verified) {
                    showNotification('حسابك غير مفعل. يرجى تفعيل الحساب عبر واتساب الإدارة', 'warning');
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                    
                    setTimeout(() => {
                        if (confirm('هل تريد إعادة إرسال رسالة التفعيل إلى واتساب الإدارة؟')) {
                            sendVerificationWhatsApp(customer.phone);
                        }
                    }, 2000);
                    return;
                }
                
                currentUser = customer;
                localStorage.setItem('tarhal_customer', JSON.stringify(customer));
                
                showNotification('تم تسجيل الدخول بنجاح!', 'success');
                showScreen('home-screen');
                updateUserProfile();
                
            } catch (error) {
                console.error('Login error:', error);
                showNotification('حدث خطأ أثناء تسجيل الدخول', 'error');
            } finally {
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
            }
        }
        
        async function registerCustomer() {
            const fullname = document.getElementById('register-fullname').value.trim();
            const phone = document.getElementById('register-phone').value.trim();
            const phone2 = document.getElementById('register-phone2').value.trim();
            const password = document.getElementById('register-password').value;
            
            if (!fullname || !phone || !password) {
                showNotification('الرجاء ملء جميع الحقول المطلوبة', 'error');
                return;
            }
            
            if (!isValidSudanesePhone(phone)) {
                showNotification('الرجاء إدخال رقم واتساب سوداني صحيح', 'error');
                return;
            }
            
            const registerBtn = document.querySelector('#customerRegisterForm button');
            const originalText = registerBtn.innerHTML;
            registerBtn.innerHTML = '<span class="loading"></span> جاري التسجيل...';
            registerBtn.disabled = true;
            
            try {
                const { data: existingCustomer, error: checkError } = await tarhalDB
                    .from('customers')
                    .select('id')
                    .eq('phone', phone)
                    .single();
                
                if (existingCustomer) {
                    showNotification('رقم الواتساب مسجل بالفعل', 'error');
                    registerBtn.innerHTML = originalText;
                    registerBtn.disabled = false;
                    return;
                }
                
                const { data: newCustomer, error } = await tarhalDB
                    .from('customers')
                    .insert([{
                        full_name: fullname,
                        phone: phone,
                        phone2: phone2 || null,
                        password: password,
                        is_verified: false,
                        created_at: new Date().toISOString()
                    }])
                    .select()
                    .single();
                
                if (error) throw error;
                
                registeredPhone = phone;
                
                document.getElementById('verification-section').classList.remove('hidden');
                document.getElementById('customerRegisterForm').style.opacity = '0.5';
                registerBtn.disabled = true;
                
                showNotification('تم تسجيل الحساب بنجاح! قم بتأكيد الحساب عبر واتساب', 'success');
                
            } catch (error) {
                console.error('Registration error:', error);
                showNotification('حدث خطأ أثناء التسجيل: ' + error.message, 'error');
                registerBtn.innerHTML = originalText;
                registerBtn.disabled = false;
            }
        }
        
        function sendVerificationWhatsApp(phone = null) {
            const phoneToVerify = phone || registeredPhone;
            if (!phoneToVerify) return;
            
            const adminNumber = "249918183521";
            const message = "تفعيل ترحال زونا";
            const whatsappUrl = `https://wa.me/${adminNumber}?text=${encodeURIComponent(message)}`;
            
            window.open(whatsappUrl, '_blank');
            showNotification('تم فتح واتساب. أرسل الرسالة لتأكيد حسابك', 'info');
        }
        
        function updateUserProfile() {
            if (!currentUser) return;
            
            document.getElementById('user-avatar').textContent = currentUser.full_name.charAt(0);
            document.getElementById('user-name').textContent = currentUser.full_name;
            document.getElementById('user-phone-display').textContent = currentUser.phone;
            
            if (currentUser.is_verified) {
                document.getElementById('verification-status').classList.remove('hidden');
            }
        }
        
        // --- Driver Functions ---
        async function loginDriver() {
            const phone = document.getElementById('driver-phone').value.trim();
            const password = document.getElementById('driver-password').value;
            
            if (!phone || !password) {
                showNotification('الرجاء إدخال رقم الواتساب وكلمة المرور', 'error');
                return;
            }
            
            const loginBtn = document.querySelector('#driverLoginForm button');
            const originalText = loginBtn.innerHTML;
            loginBtn.innerHTML = '<span class="loading"></span> جاري تسجيل الدخول...';
            loginBtn.disabled = true;
            
            try {
                const { data: driver, error } = await tarhalDB
                    .from('drivers')
                    .select('*')
                    .eq('whatsapp_number', phone)
                    .eq('is_active', true)
                    .single();
                
                if (error) {
                    showNotification('رقم الواتساب غير مسجل أو الحساب غير مفعل', 'error');
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                    return;
                }
                
                if (driver.password !== password) {
                    showNotification('كلمة المرور غير صحيحة', 'error');
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                    return;
                }
                
                currentDriver = driver;
                localStorage.setItem('tarhal_driver', JSON.stringify(driver));
                
                showNotification('مرحباً بعودتك أيها السائق!', 'success');
                showScreen('driver-dashboard-screen');
                updateDriverDashboard();
                updateDriverUI();
                
            } catch (error) {
                console.error('Driver login error:', error);
                showNotification('حدث خطأ أثناء تسجيل الدخول', 'error');
            } finally {
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
            }
        }
        
        function contactAdminForDriverRegistration() {
            const adminNumber = "249918183521";
            const message = "مرحباً، أريد التسجيل كسائق في تطبيق ترحال السودان";
            const whatsappUrl = `https://wa.me/${adminNumber}?text=${encodeURIComponent(message)}`;
            
            window.open(whatsappUrl, '_blank');
            showNotification('تم فتح واتساب الإدارة', 'info');
        }
        
        async function updateDriverDashboard() {
            if (!currentDriver) return;
            
            document.getElementById('driver-avatar').textContent = currentDriver.full_name.charAt(0);
            document.getElementById('driver-name').textContent = currentDriver.full_name;
            document.getElementById('driver-car-info').textContent = 
                `${currentDriver.car_model || 'سيارة'} - ${getVehicleTypeName(currentDriver.car_type)}`;
            
            document.getElementById('driver-balance').textContent = 
                (currentDriver.balance || 0).toLocaleString();
            
            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const { data: rides, error } = await tarhalDB
                    .from('rides')
                    .select('*')
                    .eq('driver_id', currentDriver.id)
                    .gte('created_at', today.toISOString())
                    .eq('status', 'completed');
                
                if (!error && rides) {
                    const todayEarnings = rides.reduce((sum, ride) => sum + (ride.driver_earnings || 0), 0);
                    document.getElementById('today-trips').textContent = rides.length;
                    document.getElementById('today-earnings').textContent = todayEarnings.toLocaleString();
                }
                
                const { data: totalRides, error: totalError } = await tarhalDB
                    .from('rides')
                    .select('id')
                    .eq('driver_id', currentDriver.id)
                    .eq('status', 'completed');
                
                if (!totalError && totalRides) {
                    document.getElementById('total-trips').textContent = totalRides.length;
                }
                
            } catch (error) {
                console.error('Error fetching driver stats:', error);
            }
        }
        
        function toggleDriverStatus() {
            isDriverOnline = !isDriverOnline;
            const statusIndicator = document.getElementById('driver-status-indicator');
            const statusText = document.getElementById('driver-status-text');
            const toggleBtn = document.getElementById('toggle-online-btn');
            
            if (isDriverOnline) {
                statusIndicator.className = 'status-indicator status-online';
                statusText.textContent = 'متصل وجاهز';
                toggleBtn.innerHTML = '<ion-icon name="power-outline"></ion-icon> إيقاف وضع العمل';
                toggleBtn.classList.add('btn-danger');
                toggleBtn.classList.remove('btn-driver');
                
                startDriverTracking();
                showNotification('أنت الآن متصل وجاهز لاستقبال طلبات الركوب', 'success');
                
                // تفعيل إشعارات السائق تلقائياً عند الاتصال
                if (Notification.permission === 'default') {
                    setTimeout(() => {
                        if (confirm('هل تريد تفعيل الإشعارات لاستقبال طلبات الرحلات الجديدة؟')) {
                            setupDriverNotifications();
                        }
                    }, 1000);
                }
                
            } else {
                statusIndicator.className = 'status-indicator status-offline';
                statusText.textContent = 'غير متصل';
                toggleBtn.innerHTML = '<ion-icon name="power-outline"></ion-icon> تفعيل وضع العمل';
                toggleBtn.classList.remove('btn-danger');
                toggleBtn.classList.add('btn-driver');
                
                stopDriverTracking();
                showNotification('تم إيقاف وضع العمل', 'info');
            }
        }
        
        function startDriverTracking() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    try {
                        await tarhalDB
                            .from('driver_locations')
                            .upsert({
                                driver_id: currentDriver.id,
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                car_type: currentDriver.car_type,
                                last_seen: new Date().toISOString()
                            }, { onConflict: 'driver_id' });
                        
                        showNotification('بدأ تتبع موقعك...', 'success');
                    } catch (error) {
                        console.error('Tracking error:', error);
                    }
                }, (error) => {
                    showNotification('خطأ في الوصول للموقع الجغرافي', 'error');
                });
            }
        }
        
        function stopDriverTracking() {
            console.log('Driver tracking stopped');
        }
        
        // --- Ride Functions ---
        function requestRide() {
            if (!currentUser || !currentUser.is_verified) {
                showNotification('يجب تفعيل حسابك أولاً لطلب رحلة', 'error');
                return;
            }
            
            showScreen('ride-request-screen');
            initRideMap();
        }
        
        function initRideMap() {
            if (rideMap) {
                rideMap.remove();
                rideMap = null;
            }
            
            rideMap = L.map('ride-map').setView([15.5007, 32.5599], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(rideMap);
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    userPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    rideMap.setView([userPosition.lat, userPosition.lng], 15);
                    
                    userMarker = L.marker([userPosition.lat, userPosition.lng], {
                        icon: L.divIcon({
                            html: '<div style="background: #4f46e5; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>'
                        })
                    }).addTo(rideMap).bindPopup('موقعك الحالي').openPopup();
                    
                    rideMap.on('click', (e) => {
                        setDestination(e.latlng.lat, e.latlng.lng);
                    });
                    
                }, (error) => {
                    showNotification('الرجاء السماح بالوصول للموقع الجغرافي', 'warning');
                }, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            }
        }
        
        function setDestination(lat, lng) {
            destinationPosition = { lat, lng };
            
            if (destinationMarker) {
                destinationMarker.setLatLng([lat, lng]);
            } else {
                destinationMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        html: '<div style="background: #ef4444; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>'
                    })
                }).addTo(rideMap).bindPopup('نقطة الوصول').openPopup();
                
                if (userMarker) {
                    L.polyline([
                        [userPosition.lat, userPosition.lng],
                        [lat, lng]
                    ], {
                        color: '#4f46e5',
                        weight: 3,
                        opacity: 0.7,
                        dashArray: '10, 10'
                    }).addTo(rideMap);
                }
            }
            
            if (selectedVehicleType) {
                calculateRidePrice();
            }
        }
        
        function selectVehicle(type) {
            selectedVehicleType = type;
            
            document.querySelectorAll('.vehicle-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`.vehicle-option[data-type="${type}"]`).classList.add('selected');
            
            if (destinationPosition) {
                calculateRidePrice();
            }
        }
        
        function calculateRidePrice() {
            if (!userPosition || !destinationPosition || !selectedVehicleType) return;
            
            const latDiff = destinationPosition.lat - userPosition.lat;
            const lngDiff = destinationPosition.lng - userPosition.lng;
            const distance = Math.sqrt(latDiff * latDiff + lngDiff * lngDiff) * 111;
            
            const vehicle = VEHICLE_PRICES[selectedVehicleType];
            const additionalKm = Math.max(0, distance - 1);
            const basePrice = vehicle.base;
            const extraPrice = additionalKm * vehicle.perKm;
            const totalPrice = basePrice + extraPrice;
            
            document.getElementById('price-calculation').classList.remove('hidden');
            document.getElementById('distance-display').textContent = `${distance.toFixed(1)} كم`;
            document.getElementById('base-price-display').textContent = `${basePrice.toLocaleString()} SDG`;
            document.getElementById('extra-price-display').textContent = `${extraPrice.toLocaleString()} SDG`;
            document.getElementById('total-price-display').textContent = `${totalPrice.toLocaleString()} SDG`;
            
            document.getElementById('confirm-ride-btn').disabled = false;
        }
        
        async function confirmRide() {
            if (!selectedVehicleType || !destinationPosition) {
                showNotification('الرجاء تحديد الوجهة واختيار نوع المركبة', 'warning');
                return;
            }
            
            if (!currentUser || !currentUser.is_verified) {
                showNotification('يجب تفعيل حسابك أولاً لطلب رحلة', 'error');
                return;
            }
            
            const confirmBtn = document.getElementById('confirm-ride-btn');
            const originalText = confirmBtn.innerHTML;
            confirmBtn.innerHTML = '<span class="loading"></span> جاري البحث عن سائق...';
            confirmBtn.disabled = true;
            
            showNotification('جاري البحث عن سائق قريب...', 'info');
            
            try {
                const latDiff = destinationPosition.lat - userPosition.lat;
                const lngDiff = destinationPosition.lng - userPosition.lng;
                const distance = Math.sqrt(latDiff * latDiff + lngDiff * lngDiff) * 111;
                const vehicle = VEHICLE_PRICES[selectedVehicleType];
                const additionalKm = Math.max(0, distance - 1);
                const totalPrice = vehicle.base + (additionalKm * vehicle.perKm);
                
                const { data: ride, error } = await tarhalDB
                    .from('rides')
                    .insert([{
                        customer_id: currentUser.id,
                        customer_name: currentUser.full_name,
                        customer_phone: currentUser.phone,
                        customer_phone2: currentUser.phone2,
                        pickup_lat: userPosition.lat,
                        pickup_lng: userPosition.lng,
                        destination_lat: destinationPosition.lat,
                        destination_lng: destinationPosition.lng,
                        distance_km: parseFloat(distance.toFixed(1)),
                        vehicle_type: selectedVehicleType,
                        amount: totalPrice,
                        status: 'searching',
                        created_at: new Date().toISOString()
                    }])
                    .select()
                    .single();
                
                if (error) throw error;
                
                currentRideId = ride.id;
                
                // إرسال إشعارات للسائقين (محاكاة)
                setTimeout(() => {
                    showNotification('تم العثور على سائق! جاري الاتصال...', 'success');
                    
                    // إرسال إشعار للسائقين المتصلين
                    if (notificationManager && currentDriver) {
                        notificationManager.sendRideNotificationToDriver(currentDriver.id, {
                            id: ride.id,
                            customerName: currentUser.full_name,
                            customerPhone: currentUser.phone,
                            pickupLocation: 'الخرطوم - العمارات',
                            destination: 'أم درمان - السوق',
                            distance: `${distance.toFixed(1)} كم`,
                            price: `${totalPrice.toLocaleString()} SDG`,
                            vehicleType: vehicle.name
                        });
                    }
                    
                    setTimeout(() => {
                        showActiveRideModal(ride);
                    }, 2000);
                    
                }, 3000);
                
            } catch (error) {
                console.error('Ride request error:', error);
                showNotification('حدث خطأ في طلب الرحلة', 'error');
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
            }
        }
        
        function showActiveRideModal(ride) {
            const modal = document.getElementById('active-trip-modal');
            modal.classList.remove('hidden');
            
            const tripDetails = document.getElementById('trip-details');
            tripDetails.innerHTML = `
                <div class="card mb-3">
                    <div class="price-row">
                        <span>نوع المركبة:</span>
                        <span>${VEHICLE_PRICES[ride.vehicle_type].name}</span>
                    </div>
                    <div class="price-row">
                        <span>منطقة الانطلاق:</span>
                        <span>${getNeighborhoodName(ride.pickup_lat, ride.pickup_lng)}</span>
                    </div>
                    <div class="price-row">
                        <span>منطقة الوصول:</span>
                        <span>${getNeighborhoodName(ride.destination_lat, ride.destination_lng)}</span>
                    </div>
                    <div class="price-row">
                        <span>المسافة:</span>
                        <span>${ride.distance_km} كم</span>
                    </div>
                    <div class="price-row">
                        <span>السائق:</span>
                        <span>محمد أحمد</span>
                    </div>
                    <div class="price-row">
                        <span>رقم السائق:</span>
                        <span>+249 90 123 4567</span>
                    </div>
                    <div class="price-row" style="font-weight: 800; color: var(--primary);">
                        <span>المجموع:</span>
                        <span>${ride.amount.toLocaleString()} SDG</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <button class="btn btn-secondary" onclick="callDriver()">
                        <ion-icon name="call-outline"></ion-icon>
                        الاتصال بالسائق
                    </button>
                </div>
                
                <div class="mb-3">
                    <button class="btn btn-danger" onclick="cancelRide()">
                        <ion-icon name="close-outline"></ion-icon>
                        إلغاء الرحلة
                    </button>
                </div>
                
                <p style="text-align: center; color: var(--gray); font-size: 14px;">
                    سيتم اتصالك بالسائق خلال ثوانٍ
                </p>
            `;
            
            document.getElementById('confirm-ride-btn').innerHTML = '<ion-icon name="search-outline"></ion-icon> بحث عن سائق';
            document.getElementById('confirm-ride-btn').disabled = false;
        }
        
        // --- Helper Functions ---
        function checkAuth() {
            const savedUser = localStorage.getItem('tarhal_customer');
            const savedDriver = localStorage.getItem('tarhal_driver');
            
            if (savedDriver) {
                try {
                    currentDriver = JSON.parse(savedDriver);
                    showScreen('driver-dashboard-screen');
                    updateDriverDashboard();
                    updateDriverUI();
                } catch (e) {
                    localStorage.removeItem('tarhal_driver');
                    showScreen('welcome-screen');
                }
            } else if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showScreen('home-screen');
                    updateUserProfile();
                } catch (e) {
                    localStorage.removeItem('tarhal_customer');
                    showScreen('welcome-screen');
                }
            } else {
                showScreen('welcome-screen');
            }
        }
        
        function getVehicleTypeName(type) {
            const names = {
                tuktuk: 'توك توك',
                economy: 'اقتصادية',
                comfort: 'متوسطة',
                vip: 'VIP'
            };
            return names[type] || type;
        }
        
        function getNeighborhoodName(lat, lng) {
            return "الخرطوم";
        }
        
        function isValidSudanesePhone(phone) {
            const sudanesePhoneRegex = /^(?:\+249|0)?(?:9[0123456789]|1[012])\d{7}$/;
            return sudanesePhoneRegex.test(phone);
        }
        
        function showNotification(message, type = 'info') {
            const notificationArea = document.getElementById('notification-area');
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            let icon = 'ℹ️';
            if (type === 'success') icon = '✅';
            else if (type === 'error') icon = '❌';
            else if (type === 'warning') icon = '⚠️';
            
            notification.innerHTML = `
                <div class="notification-icon">${icon}</div>
                <div style="flex: 1;">${message}</div>
            `;
            
            notificationArea.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-20px)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        function logout() {
            localStorage.removeItem('tarhal_customer');
            currentUser = null;
            showScreen('welcome-screen');
            showNotification('تم تسجيل الخروج بنجاح', 'success');
        }
        
        function logoutDriver() {
            if (isDriverOnline) {
                toggleDriverStatus();
            }
            localStorage.removeItem('tarhal_driver');
            currentDriver = null;
            showScreen('welcome-screen');
            showNotification('تم تسجيل خروج السائق', 'success');
        }
        
        // Placeholder functions
        function showMyRides() {
            showNotification('قريباً: عرض الرحلات السابقة', 'info');
        }
        
        function showWallet() {
            showNotification('قريباً: المحفظة الإلكترونية', 'info');
        }
        
        function showSettings() {
            showNotification('قريباً: إعدادات الحساب', 'info');
        }
        
        function showDriverProfile() {
            showNotification('قريباً: الملف الشخصي للسائق', 'info');
        }
        
        function callDriver() {
            showNotification('جاري الاتصال بالسائق...', 'info');
        }
        
        function cancelRide() {
            document.getElementById('active-trip-modal').classList.add('hidden');
            showNotification('تم إلغاء الرحلة', 'info');
            goHome();
        }
        
        function acceptRide() {
            document.getElementById('incoming-ride-modal').classList.add('hidden');
            showNotification('تم قبول الرحلة بنجاح', 'success');
            showActiveRideModal({
                vehicle_type: 'economy',
                amount: 10000,
                distance_km: 5.2
            });
        }
        
        function declineRide() {
            document.getElementById('incoming-ride-modal').classList.add('hidden');
            showNotification('تم رفض الرحلة', 'info');
        }
        
        // تحميل Leaflet ديناميكياً
        window.addEventListener('load', function() {
            if (typeof L === 'undefined') {
                const leafletScript = document.createElement('script');
                leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                leafletScript.onload = function() {
                    console.log('✅ Leaflet loaded successfully');
                };
                document.head.appendChild(leafletScript);
            }
            
            // طلب إذن الإشعارات عند تحميل الصفحة
            if ('Notification' in window && Notification.permission === 'default') {
                // ننتظر حتى يكون هناك تفاعل من المستخدم
            }
        });
        
        // أنماط CSS إضافية
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideDown {
                from {
                    transform: translateY(-100%);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideUp {
                from {
                    transform: translateY(100%);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
        
        console.log(' تطبيق ترحال زونا جاهز للعمل!');
    </script>
    
    <!-- ملفات النظام الجديد -->
    <script src="notification-manager.js"></script>
    <script src="sound-manager.js"></script>
    
</body>
</html>
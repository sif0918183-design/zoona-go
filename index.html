<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ±Ø­Ø§Ù„ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† - Tarhal</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <link rel="icon" href="data:,"> 

    <script src="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Leaflet CSS & JS Ù„Ù„Ø®Ø±Ø§Ø¦Ø· -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { 
            --primary: #4f46e5; 
            --driver-bg: #16a34a; 
            --staff-bg: #7c3aed;
            --tuk-tuk: #059669;
            --economy: #2563eb;
            --comfort: #7c3aed;
            --vip: #d97706;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            transition: 0.3s;
            overflow-x: hidden;
        }
        
        .header { 
            background: white; 
            color: var(--primary); 
            padding: 20px; 
            text-align: center; 
            font-size: 24px; 
            cursor: pointer; 
            font-weight: bold; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-bottom: 3px solid var(--primary);
            position: relative;
            z-index: 1000;
        }
        
        .header::after {
            content: "ğŸ‡¸ğŸ‡©";
            margin-right: 10px;
            font-size: 28px;
        }
        
        .container { 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            max-width: 500px; 
            margin: auto;
        }
        
        .hidden { display: none !important; }
        
        button { 
            padding: 15px; 
            border-radius: 12px; 
            border: none; 
            font-weight: bold; 
            cursor: pointer; 
            color: white; 
            transition: all 0.3s ease; 
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        button:active { transform: translateY(0); }
        
        input, select { 
            padding: 15px; 
            border-radius: 10px; 
            border: 2px solid #e5e7eb; 
            width: 100%; 
            box-sizing: border-box; 
            font-size: 16px;
            background: #f9fafb;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
        }
        
        .btn-cust { background: var(--primary); }
        .btn-drive { background: var(--driver-bg); }
        .btn-tuktuk { background: var(--tuk-tuk); }
        .btn-economy { background: var(--economy); }
        .btn-comfort { background: var(--comfort); }
        .btn-vip { background: var(--vip); }
        
        .overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.9); 
            z-index: 9999; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
            box-sizing: border-box;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .card { 
            background: white; 
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.12); 
            border: 1px solid #e5e7eb;
            animation: slideUp 0.4s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .vehicle-option {
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .vehicle-option:hover {
            transform: scale(1.02);
            border-color: var(--primary);
        }
        
        .vehicle-option.selected {
            border-color: var(--primary);
            background: #e0e7ff;
            font-weight: bold;
        }
        
        .price-badge {
            background: var(--primary);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: inline-block;
            margin: 5px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 99999;
            animation: slideInRight 0.5s ease;
            border-right: 5px solid var(--primary);
            max-width: 300px;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .countdown {
            font-size: 32px;
            font-weight: bold;
            color: #ef4444;
            text-align: center;
            margin: 20px 0;
        }
        
        .map-container {
            width: 100%;
            height: 400px;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .profile-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .profile-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), #6366f1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            color: white;
            font-size: 32px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="header" onclick="checkStaffAccess()">ØªØ±Ø­Ø§Ù„ Ø§Ù„Ø³ÙˆØ¯Ø§Ù†</div>

    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø²Ø¨ÙˆÙ† -->
    <div id="login-screen" class="container">
        <div class="card" style="text-align: center;">
            <div class="profile-icon">ğŸ‘¤</div>
            <h2 style="color: var(--primary); margin: 0 0 10px 0;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ØªØ±Ø­Ø§Ù„</h2>
            <p style="color: #666; margin-bottom: 25px;">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ù„Ø¨Ø¯Ø¡</p>
            
            <div style="display:flex; flex-direction:column; gap:15px;">
                <input type="text" id="login-fullname" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ">
                <input type="tel" id="login-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ">
                <input type="tel" id="login-phone2" placeholder="Ø±Ù‚Ù… Ø§Ø­ØªÙŠØ§Ø·ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                <input type="password" id="login-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                
                <button class="btn-cust" onclick="loginCustomer()" style="width:100%; margin-top: 10px;">
                    <span>ğŸš€ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</span>
                </button>
                
                <p style="color: #666; font-size: 14px; margin-top: 15px;">
                    Ø¨ØªØ³Ø¬ÙŠÙ„Ùƒ ÙØ¥Ù†Ùƒ ØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ <a href="#" style="color: var(--primary);">Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø³Ø§Ø¦Ù‚ -->
    <div id="driver-login-screen" class="container hidden">
        <div class="card" style="text-align: center;">
            <div class="profile-icon">ğŸš—</div>
            <h2 style="color: var(--driver-bg); margin: 0 0 10px 0;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø£ÙŠÙ‡Ø§ Ø§Ù„Ø³Ø§Ø¦Ù‚</h2>
            <p style="color: #666; margin-bottom: 25px;">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</p>
            
            <div style="display:flex; flex-direction:column; gap:15px;">
                <input type="tel" id="driver-login-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨">
                <input type="password" id="driver-login-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                
                <button class="btn-drive" onclick="loginDriver()" style="width:100%; margin-top: 10px;">
                    <span>ğŸš— Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚</span>
                </button>
                
                <button onclick="showSection('login-screen')" style="color: #666; background: #f3f4f6;">
                    <span>â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²Ø¨ÙˆÙ†</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="home-screen" class="container hidden">
        <div class="card" style="text-align: center;">
            <div class="profile-icon" id="user-initial">?</div>
            <h3 id="user-greeting" style="color: var(--primary);">Ù…Ø±Ø­Ø¨Ø§Ù‹!</h3>
            <p id="user-phone" style="color: #666; font-size: 14px;"></p>
        </div>
        
        <button class="btn-cust" onclick="showSection('ride-request')">
            <span>ğŸš– Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
        </button>
        
        <button class="btn-drive" onclick="showDriverLogin()">
            <span>ğŸš— Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</span>
        </button>
        
        <div style="margin-top: 20px; text-align: center;">
            <button onclick="logout()" style="color: #666; background: #f3f4f6; width: 100%;">
                <span>ğŸ‘‹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
            </button>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø© -->
    <div id="ride-request" class="container hidden">
        <div class="card">
            <h3 style="color: var(--primary); text-align: center;">ğŸš– Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            
            <div class="map-container" id="ride-map"></div>
            
            <div style="margin: 20px 0;">
                <h4 style="margin-bottom: 10px;">ğŸ”§ Ø§Ø®ØªØ± ÙØ¦Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</h4>
                <div class="vehicle-option" onclick="selectVehicle('tuktuk')" data-price="5000">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--tuk-tuk);">Ø±ÙƒØ´Ø© (ØªÙˆÙƒ ØªÙˆÙƒ)</strong>
                            <div style="font-size: 12px; color: #666;">Ù„Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ù‚ØµÙŠØ±Ø©</div>
                        </div>
                        <div class="price-badge">5,000 SDG</div>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">+ 2,000 Ù„ÙƒÙ„ ÙƒÙŠÙ„ÙˆÙ…ØªØ± Ø¥Ø¶Ø§ÙÙŠ</div>
                </div>
                
                <div class="vehicle-option" onclick="selectVehicle('economy')" data-price="6000">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--economy);">Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©</strong>
                            <div style="font-size: 12px; color: #666;">Ø³ÙŠØ¯Ø§Ù† Ø§Ù‚ØªØµØ§Ø¯ÙŠ</div>
                        </div>
                        <div class="price-badge">6,000 SDG</div>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">+ 3,000 Ù„ÙƒÙ„ ÙƒÙŠÙ„ÙˆÙ…ØªØ± Ø¥Ø¶Ø§ÙÙŠ</div>
                </div>
                
                <div class="vehicle-option" onclick="selectVehicle('comfort')" data-price="7000">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--comfort);">Ù…ØªÙˆØ³Ø·Ø© (ÙƒÙ…ÙÙˆØ±Øª)</strong>
                            <div style="font-size: 12px; color: #666;">Ø³ÙŠØ§Ø±Ø§Øª Ù…Ø±ÙŠØ­Ø©</div>
                        </div>
                        <div class="price-badge">7,000 SDG</div>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">+ 3,500 Ù„ÙƒÙ„ ÙƒÙŠÙ„ÙˆÙ…ØªØ± Ø¥Ø¶Ø§ÙÙŠ</div>
                </div>
                
                <div class="vehicle-option" onclick="selectVehicle('vip')" data-price="10000">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--vip);">VIP</strong>
                            <div style="font-size: 12px; color: #666;">Ø³ÙŠØ§Ø±Ø§Øª ÙØ§Ø®Ø±Ø©</div>
                        </div>
                        <div class="price-badge">10,000 SDG</div>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">+ 5,000 Ù„ÙƒÙ„ ÙƒÙŠÙ„ÙˆÙ…ØªØ± Ø¥Ø¶Ø§ÙÙŠ</div>
                </div>
            </div>
            
            <div id="price-calculation" class="card" style="background: #f0f9ff; border: 2px dashed var(--primary); display: none;">
                <h4 style="margin: 0 0 10px 0; color: var(--primary);">ğŸ’° Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ©</h4>
                <div id="distance-display" style="font-size: 14px; color: #666;">Ø§Ù„Ù…Ø³Ø§ÙØ©: Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...</div>
                <div id="price-display" style="font-size: 24px; font-weight: bold; color: var(--primary); margin: 10px 0;"></div>
            </div>
            
            <button id="confirm-ride-btn" class="btn-cust" style="width:100%; margin-top: 15px;" onclick="confirmRideRequest()" disabled>
                <span>ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚</span>
            </button>
            
            <button onclick="showSection('home-screen')" style="color: #666; background: #f3f4f6; width:100%; margin-top: 10px;">
                <span>â†©ï¸ Ø±Ø¬ÙˆØ¹</span>
            </button>
        </div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
    <div id="driver-dashboard" class="container hidden">
        <div class="card">
            <div class="profile-header">
                <div class="profile-icon" id="driver-initial">?</div>
                <h3 id="driver-name-display"></h3>
                <p style="color: #666; font-size: 14px;" id="driver-vehicle-info"></p>
                <div class="price-badge" id="driver-balance-display">0 SDG</div>
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <p id="driver-status-text" style="font-size: 18px;">
                    Ø­Ø§Ù„ØªÙƒ Ø§Ù„Ø¢Ù†: <span style="color:#ef4444; font-weight: bold;">ØºÙŠØ± Ù…ØªØµÙ„</span>
                </p>
                
                <button id="toggle-online-btn" class="btn-drive" style="width:100%; padding: 18px; font-size: 18px;" onclick="toggleDriverOnline()">
                    <span>âš¡ ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù…Ù„</span>
                </button>
            </div>
            
            <div id="driver-earnings" style="text-align: center; margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 12px;">
                <h4 style="margin: 0 0 5px 0; color: var(--economy);">ğŸ’° Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ÙŠÙˆÙ…</h4>
                <div style="font-size: 24px; font-weight: bold; color: var(--primary);" id="today-earnings">0 SDG</div>
            </div>
        </div>
        
        <button onclick="logoutDriver()" style="color: #666; background: #f3f4f6; width:100%; margin-top: 20px;">
            <span>ğŸ‘‹ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ø³Ø§Ø¦Ù‚</span>
        </button>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø±Ø­Ù„Ø© Ù„Ù„Ø³Ø§Ø¦Ù‚ -->
    <div id="incoming-ride-overlay" class="overlay hidden">
        <div class="card" style="width: 90%; max-width: 400px; text-align: center;">
            <div class="countdown" id="ride-countdown">40</div>
            
            <h2 style="color: var(--primary); margin: 0 0 10px 0;">ğŸš¨ Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯!</h2>
            
            <div style="background: #fef2f2; padding: 15px; border-radius: 12px; margin: 15px 0;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>ÙØ¦Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</span>
                    <strong id="ride-vehicle-type"></strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>Ø§Ù„Ù…Ø³Ø§ÙØ©:</span>
                    <strong id="ride-distance"></strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>Ø§Ù„Ø­ÙŠ:</span>
                    <strong id="ride-neighborhood"></strong>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 20px; color: var(--primary); font-weight: bold;">
                    <span>Ø§Ù„Ù‚ÙŠÙ…Ø©:</span>
                    <strong id="ride-price"></strong>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-drive" onclick="acceptRide()" style="flex: 1; padding: 18px;">
                    <span>âœ… Ù‚Ø¨ÙˆÙ„</span>
                </button>
                <button onclick="declineRide()" style="flex: 1; background: #ef4444; padding: 18px;">
                    <span>âŒ Ø±ÙØ¶</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© -->
    <div id="active-trip-overlay" class="overlay hidden">
        <div class="card" style="width: 90%; max-width: 400px; text-align: center;">
            <h2 style="color: var(--primary); margin: 0 0 20px 0;">ğŸš— Ø§Ù„Ø±Ø­Ù„Ø© Ø³Ø§Ø±ÙŠØ© Ø§Ù„Ø¢Ù†</h2>
            
            <div style="background: #e0e7ff; padding: 20px; border-radius: 15px; margin: 20px 0;">
                <div style="font-size: 18px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Ø§Ù„Ø²Ø¨ÙˆÙ†:</span>
                        <strong id="trip-customer-name"></strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„:</span>
                        <strong id="trip-customer-phone"></strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>ÙØ¦Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</span>
                        <strong id="trip-vehicle-type"></strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 22px; color: var(--primary);">
                        <span>Ø§Ù„Ù‚ÙŠÙ…Ø©:</span>
                        <strong id="trip-amount"></strong>
                    </div>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 10px; margin-top: 15px;">
                    <div style="font-size: 14px; color: #666;">
                        Ø³ÙŠØªÙ… Ø®ØµÙ… <strong>6%</strong> Ø±Ø³ÙˆÙ… Ø®Ø¯Ù…Ø©
                    </div>
                    <div style="font-size: 16px; color: #ef4444; margin-top: 5px;">
                        ØµØ§ÙÙŠ Ø¯Ø®Ù„ Ø§Ù„Ø³Ø§Ø¦Ù‚: <strong id="driver-net-amount"></strong>
                    </div>
                </div>
            </div>
            
            <div id="customer-controls">
                <button onclick="markDriverArrived()" style="background: #059669; width: 100%; padding: 18px; font-size: 18px; margin-bottom: 10px;">
                    <span>âœ… ÙˆØµÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚</span>
                </button>
                <button onclick="cancelRide('customer')" style="background: #6b7280; width: 100%; padding: 15px; margin-bottom: 10px;">
                    <span>âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</span>
                </button>
            </div>
            
            <div id="driver-controls" class="hidden">
                <button onclick="markArrivedAtDestination()" style="background: #059669; width: 100%; padding: 18px; font-size: 18px; margin-bottom: 10px;">
                    <span>ğŸ“ ÙˆØµÙ„Øª Ù„Ù„ÙˆØ¬Ù‡Ø©</span>
                </button>
                <button onclick="cancelRide('driver')" style="background: #6b7280; width: 100%; padding: 15px;">
                    <span>âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</span>
                </button>
            </div>
            
            <div id="end-trip-controls" class="hidden">
                <button onclick="endTrip()" style="background: #dc2626; width: 100%; padding: 20px; font-size: 18px;">
                    <span>ğŸ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© ÙˆØªØ­ØµÙŠÙ„ Ø§Ù„Ø±Ø³ÙˆÙ…</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
    <div id="staff-section" class="container hidden">
        <div class="card">
            <h3 style="color: var(--staff-bg); text-align: center;">ğŸ‘¨â€ğŸ’¼ ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯</h3>
            
            <div style="display:flex; flex-direction:column; gap:12px; margin-top: 20px;">
                <input type="text" id="st-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø±Ø¨Ø§Ø¹ÙŠ">
                <input type="tel" id="st-phone" placeholder="Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¦Ù‚">
                <input type="password" id="st-password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø³Ø§Ø¦Ù‚">
                <input type="text" id="st-car-model" placeholder="Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø©">
                
                <select id="st-car-type">
                    <option value="">Ø§Ø®ØªØ± ÙØ¦Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</option>
                    <option value="tuktuk">Ø±ÙƒØ´Ø© (ØªÙˆÙƒ ØªÙˆÙƒ)</option>
                    <option value="economy">Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©</option>
                    <option value="comfort">Ù…ØªÙˆØ³Ø·Ø© (ÙƒÙ…ÙÙˆØ±Øª)</option>
                    <option value="vip">VIP</option>
                </select>
                
                <input type="text" id="st-car-plate" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©">
                <input type="text" id="st-car-color" placeholder="Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø©">
                
                <button onclick="registerDriverByStaff()" style="background: var(--staff-bg); padding: 18px; font-size: 16px;">
                    <span>ğŸ’¾ Ø­ÙØ¸ ÙˆÙ…Ù†Ø­ Ø±ØµÙŠØ¯ 15,000 SDG</span>
                </button>
                
                <button onclick="showSection('home-screen')" style="color: #666; background: #f3f4f6;">
                    <span>â†©ï¸ Ø¥Ù„ØºØ§Ø¡ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø©</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
    <div id="passcode-modal" class="overlay" style="background: rgba(0,0,0,0.9)">
        <div class="card" style="width: 85%; max-width: 350px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 20px;">ğŸ”’</div>
            <h3 style="color: var(--staff-bg);">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©</h3>
            <p style="color: #666; margin-bottom: 20px;">Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠ:</p>
            
            <input type="password" id="staff-input-pass" placeholder="****" 
                   style="text-align: center; font-size: 32px; letter-spacing: 12px; padding: 20px;">
            
            <button onclick="verifyStaffPasscode()" style="background: var(--staff-bg); width: 100%; padding: 18px; margin-top: 20px; font-size: 18px;">
                <span>âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
            </button>
            
            <button onclick="closePasscodeModal()" style="background: none; color: #666; width: 100%; margin-top: 10px;">
                <span>â†©ï¸ Ø¥Ù„ØºØ§Ø¡</span>
            </button>
        </div>
    </div>

    <!-- Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
    <div id="notification-area"></div>

    <script>
        // --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø© ---
        const SB_URL = 'https://zsmlyiygjagmhnglrhoa.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzbWx5aXlnamFnbWhuZ2xyaG9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NDc3NjMsImV4cCI6MjA4MTUyMzc2M30.QviVinAng-ILq0umvI5UZCFEvNpP3nI0kW_hSaXxNps';
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        let currentUser = null;
        let currentDriver = null;
        let isDriverOnline = false;
        let watchId = null;
        let selectedVehicleType = null;
        let selectedVehiclePrice = null;
        let rideMap = null;
        let userMarker = null;
        let destinationMarker = null;
        let userPosition = null;
        let destinationPosition = null;
        let rideDistance = 0;
        let calculatedPrice = 0;
        let currentRideId = null;
        let rideCountdownTimer = null;
        let rideTimeout = 40;
        let searchingDrivers = [];
        let currentDriverSearchIndex = 0;

        // Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ÙØ¦Ø§Øª (SDG)
        const VEHICLE_PRICES = {
            tuktuk: { base: 5000, perKm: 2000 },
            economy: { base: 6000, perKm: 3000 },
            comfort: { base: 7000, perKm: 3500 },
            vip: { base: 10000, perKm: 5000 }
        };

        // --- ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
        document.addEventListener('DOMContentLoaded', async () => {
            checkAuth();
            initServiceWorker();
        });

        function initServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js');
            }
        }

        function checkAuth() {
            const savedUser = localStorage.getItem('tarhal_customer');
            const savedDriver = localStorage.getItem('tarhal_driver');
            
            if (savedDriver) {
                currentDriver = JSON.parse(savedDriver);
                showDriverDashboard();
            } else if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showHomeScreen();
            } else {
                document.getElementById('passcode-modal').classList.add('hidden');
                showSection('login-screen');
            }
        }

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØµÙØ­ ÙˆØ§Ù„Ø¹Ø±Ø¶ ---
        function showSection(sectionId) {
            document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            
            if (sectionId === 'ride-request') {
                setTimeout(initRideMap, 300);
            }
        }

        function showDriverLogin() {
            showSection('driver-login-screen');
        }

        function showHomeScreen() {
            showSection('home-screen');
            document.getElementById('user-initial').textContent = currentUser.full_name.charAt(0);
            document.getElementById('user-greeting').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.full_name}`;
            document.getElementById('user-phone').textContent = currentUser.phone;
        }

        function showDriverDashboard() {
            showSection('driver-dashboard');
            document.getElementById('driver-initial').textContent = currentDriver.full_name.charAt(0);
            document.getElementById('driver-name-display').textContent = currentDriver.full_name;
            document.getElementById('driver-vehicle-info').textContent = `${currentDriver.car_model} - ${getVehicleTypeName(currentDriver.car_type)}`;
            document.getElementById('driver-balance-display').textContent = `${currentDriver.balance.toLocaleString()} SDG`;
            updateTodayEarnings();
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† ---
        async function loginCustomer() {
            const fullname = document.getElementById('login-fullname').value.trim();
            const phone = document.getElementById('login-phone').value.trim();
            const phone2 = document.getElementById('login-phone2').value.trim();
            const password = document.getElementById('login-password').value;

            if (!fullname || !phone || !password) {
                showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
                return;
            }

            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                const { data: existingUser, error: fetchError } = await supabaseClient
                    .from('customers')
                    .select('*')
                    .eq('phone', phone)
                    .single();

                if (fetchError && fetchError.code !== 'PGRST116') {
                    throw fetchError;
                }

                if (existingUser) {
                    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                    if (existingUser.password !== password) {
                        showNotification('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
                        return;
                    }
                    currentUser = existingUser;
                } else {
                    // ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
                    const { data: newUser, error: insertError } = await supabaseClient
                        .from('customers')
                        .insert([{
                            full_name: fullname,
                            phone: phone,
                            phone2: phone2 || null,
                            password: password,
                            created_at: new Date()
                        }])
                        .select()
                        .single();

                    if (insertError) throw insertError;
                    currentUser = newUser;
                }

                localStorage.setItem('tarhal_customer', JSON.stringify(currentUser));
                showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                showHomeScreen();

            } catch (error) {
                console.error('Login error:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹', 'error');
            }
        }

        function logout() {
            localStorage.removeItem('tarhal_customer');
            currentUser = null;
            showSection('login-screen');
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ---
        async function loginDriver() {
            const phone = document.getElementById('driver-login-phone').value.trim();
            const password = document.getElementById('driver-login-password').value;

            if (!phone || !password) {
                showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'error');
                return;
            }

            try {
                const { data: driver, error } = await supabaseClient
                    .from('drivers')
                    .select('*')
                    .eq('whatsapp_number', phone)
                    .eq('is_active', true)
                    .single();

                if (error || !driver) {
                    showNotification('Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø£Ùˆ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙØ¹Ù„', 'error');
                    return;
                }

                if (driver.password !== password) {
                    showNotification('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
                    return;
                }

                currentDriver = driver;
                localStorage.setItem('tarhal_driver', JSON.stringify(driver));
                showNotification('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!', 'success');
                showDriverDashboard();

            } catch (error) {
                console.error('Driver login error:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error');
            }
        }

        function logoutDriver() {
            if (isDriverOnline) {
                toggleDriverOnline();
            }
            localStorage.removeItem('tarhal_driver');
            currentDriver = null;
            showSection('login-screen');
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ---
        async function registerDriverByStaff() {
            const name = document.getElementById('st-name').value.trim();
            const phone = document.getElementById('st-phone').value.trim();
            const password = document.getElementById('st-password').value;
            const carModel = document.getElementById('st-car-model').value.trim();
            const carType = document.getElementById('st-car-type').value;
            const carPlate = document.getElementById('st-car-plate').value.trim();
            const carColor = document.getElementById('st-car-color').value.trim();

            if (!name || !phone || !password || !carModel || !carType || !carPlate) {
                showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
                return;
            }

            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
                const { data: existingDriver, error: checkError } = await supabaseClient
                    .from('drivers')
                    .select('id')
                    .eq('whatsapp_number', phone)
                    .single();

                if (existingDriver) {
                    showNotification('Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„!', 'error');
                    return;
                }

                const { data, error } = await supabaseClient
                    .from('drivers')
                    .insert([{
                        full_name: name,
                        whatsapp_number: phone,
                        password: password,
                        car_model: carModel,
                        car_type: carType,
                        car_plate: carPlate,
                        car_color: carColor,
                        balance: 15000,
                        status: 'OFFLINE',
                        is_active: true,
                        created_at: new Date()
                    }])
                    .select();

                if (error) throw error;

                showNotification(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ù†Ø¬Ø§Ø­! ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: ${password}`, 'success');
                
                // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
                document.getElementById('st-name').value = '';
                document.getElementById('st-phone').value = '';
                document.getElementById('st-password').value = '';
                document.getElementById('st-car-model').value = '';
                document.getElementById('st-car-type').value = '';
                document.getElementById('st-car-plate').value = '';
                document.getElementById('st-car-color').value = '';

                showSection('home-screen');

            } catch (error) {
                console.error('Register driver error:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ' + (error.message || 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©'), 'error');
            }
        }

        // --- Ù†Ø¸Ø§Ù… Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø© ---
        function initRideMap() {
            if (rideMap) {
                rideMap.remove();
                rideMap = null;
            }

            rideMap = L.map('ride-map').setView([15.5007, 32.5599], 12);
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(rideMap);

            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    userPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    rideMap.setView([userPosition.lat, userPosition.lng], 15);
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
                    userMarker = L.marker([userPosition.lat, userPosition.lng], {
                        icon: L.divIcon({
                            html: '<div style="background: #2563eb; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                            className: 'user-marker'
                        })
                    })
                    .addTo(rideMap)
                    .bindPopup('Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ')
                    .openPopup();

                    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø©
                    rideMap.on('click', (e) => {
                        setDestination(e.latlng.lat, e.latlng.lng);
                    });

                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
                    setInterval(updateUserLocation, 30000);

                }, (error) => {
                    console.error('Geolocation error:', error);
                    showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹', 'warning');
                });
            }
        }

        function updateUserLocation() {
            if (navigator.geolocation && userMarker) {
                navigator.geolocation.getCurrentPosition((position) => {
                    userPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    userMarker.setLatLng([userPosition.lat, userPosition.lng]);
                    
                    if (destinationMarker) {
                        calculateDistanceAndPrice();
                    }
                });
            }
        }

        function setDestination(lat, lng) {
            destinationPosition = { lat, lng };
            
            if (destinationMarker) {
                destinationMarker.setLatLng([lat, lng]);
            } else {
                destinationMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        html: '<div style="background: #dc2626; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                        className: 'destination-marker'
                    })
                })
                .addTo(rideMap)
                .bindPopup('Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„')
                .openPopup();
                
                // Ø±Ø³Ù… Ø®Ø· Ø¨ÙŠÙ† Ø§Ù„Ù†Ù‚Ø·ØªÙŠÙ†
                if (userMarker) {
                    L.polyline([
                        [userPosition.lat, userPosition.lng],
                        [lat, lng]
                    ], {
                        color: '#4f46e5',
                        weight: 3,
                        opacity: 0.7,
                        dashArray: '10, 10'
                    }).addTo(rideMap);
                }
            }
            
            calculateDistanceAndPrice();
        }

        function calculateDistanceAndPrice() {
            if (!userPosition || !destinationPosition || !selectedVehicleType) return;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© (ØªÙ‚Ø±ÙŠØ¨ÙŠ)
            const latDiff = destinationPosition.lat - userPosition.lat;
            const lngDiff = destinationPosition.lng - userPosition.lng;
            rideDistance = Math.sqrt(latDiff * latDiff + lngDiff * lngDiff) * 111; // ØªÙ‚Ø±ÙŠØ¨ Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª
            
            const vehiclePrice = VEHICLE_PRICES[selectedVehicleType];
            const additionalKm = Math.max(0, rideDistance - 1);
            calculatedPrice = vehiclePrice.base + (additionalKm * vehiclePrice.perKm);
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø³Ø§Ø¨
            document.getElementById('price-calculation').style.display = 'block';
            document.getElementById('distance-display').textContent = `Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©: ${rideDistance.toFixed(1)} ÙƒÙ…`;
            document.getElementById('price-display').textContent = `${calculatedPrice.toLocaleString()} SDG`;
            document.getElementById('confirm-ride-btn').disabled = false;
        }

        function selectVehicle(type) {
            selectedVehicleType = type;
            selectedVehiclePrice = VEHICLE_PRICES[type];
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
            document.querySelectorAll('.vehicle-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù„Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±
            event.currentTarget.classList.add('selected');
            
            if (destinationPosition) {
                calculateDistanceAndPrice();
            }
        }

        function getVehicleTypeName(type) {
            const names = {
                tuktuk: 'Ø±ÙƒØ´Ø©',
                economy: 'Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©',
                comfort: 'Ù…ØªÙˆØ³Ø·Ø©',
                vip: 'VIP'
            };
            return names[type] || type;
        }

        async function confirmRideRequest() {
            if (!selectedVehicleType || !destinationPosition || !userPosition) {
                showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø© ÙˆØ§Ø®ØªÙŠØ§Ø± ÙØ¦Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©', 'warning');
                return;
            }

            try {
                showNotification('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚ Ù‚Ø±ÙŠØ¨...', 'info');
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙÙŠ Ù†Ø·Ø§Ù‚ 20 ÙƒÙ…
                const { data: nearbyDrivers, error } = await supabaseClient.rpc('search_nearby_drivers_by_type', {
                    user_lat: userPosition.lat,
                    user_lng: userPosition.lng,
                    radius_meters: 20000,
                    car_type: selectedVehicleType
                });

                if (error || !nearbyDrivers || nearbyDrivers.length === 0) {
                    showNotification('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…ØªØ§Ø­ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹', 'warning');
                    return;
                }

                searchingDrivers = nearbyDrivers;
                currentDriverSearchIndex = 0;
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const { data: ride, error: rideError } = await supabaseClient
                    .from('rides')
                    .insert([{
                        customer_id: currentUser.id,
                        customer_name: currentUser.full_name,
                        customer_phone: currentUser.phone,
                        customer_phone2: currentUser.phone2,
                        pickup_lat: userPosition.lat,
                        pickup_lng: userPosition.lng,
                        destination_lat: destinationPosition.lat,
                        destination_lng: destinationPosition.lng,
                        distance_km: rideDistance,
                        vehicle_type: selectedVehicleType,
                        amount: calculatedPrice,
                        status: 'searching',
                        created_at: new Date()
                    }])
                    .select()
                    .single();

                if (rideError) throw rideError;
                
                currentRideId = ride.id;
                
                // Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø£ÙˆÙ„
                searchForNextDriver();

            } catch (error) {
                console.error('Ride request error:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø©', 'error');
            }
        }

        function searchForNextDriver() {
            if (currentDriverSearchIndex >= searchingDrivers.length) {
                // Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø§Ø¦Ù‚
                updateRideStatus('no_driver_found');
                showNotification('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø§Ø¦Ù‚ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹', 'warning');
                return;
            }

            const driver = searchingDrivers[currentDriverSearchIndex];
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ù„Ù„Ø³Ø§Ø¦Ù‚
            sendRideRequestToDriver(driver);
            
            // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
            startRideCountdown();
        }

        function sendRideRequestToDriver(driver) {
            // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¯ÙØ¹ (Push Notifications) Ø£Ùˆ Ø±Ø³Ø§Ø¦Ù„ Ø£Ø®Ø±Ù‰
            
            // ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ
            currentSearchingDriver = driver;
            
            // ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¨Ø³Ø·Ø©ØŒ Ù†Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„Ø²Ø¨ÙˆÙ†
            showNotification(`Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø§Ø¦Ù‚ ${driver.full_name}...`, 'info');
        }

        function startRideCountdown() {
            let timeLeft = rideTimeout;
            
            rideCountdownTimer = setInterval(() => {
                timeLeft--;
                
                if (timeLeft <= 0) {
                    clearInterval(rideCountdownTimer);
                    // Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù„Ù… ÙŠÙ‚Ø¨Ù„ØŒ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„ØªØ§Ù„ÙŠ
                    currentDriverSearchIndex++;
                    searchForNextDriver();
                }
            }, 1000);
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ù…ØªØµÙ„ ---
        function toggleDriverOnline() {
            isDriverOnline = !isDriverOnline;
            const btn = document.getElementById('toggle-online-btn');
            const statusText = document.getElementById('driver-status-text');

            if (isDriverOnline) {
                btn.innerHTML = '<span>ğŸ”´ Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù…Ù„</span>';
                btn.style.background = '#ef4444';
                statusText.innerHTML = 'Ø­Ø§Ù„ØªÙƒ Ø§Ù„Ø¢Ù†: <span style="color:#16a34a; font-weight: bold;">Ù…ØªØµÙ„ ÙˆØ¬Ø§Ù‡Ø²</span>';
                startDriverTracking();
                subscribeToRideRequests();
            } else {
                btn.innerHTML = '<span>âš¡ ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù…Ù„</span>';
                btn.style.background = 'var(--driver-bg)';
                statusText.innerHTML = 'Ø­Ø§Ù„ØªÙƒ Ø§Ù„Ø¢Ù†: <span style="color:#ef4444; font-weight: bold;">ØºÙŠØ± Ù…ØªØµÙ„</span>';
                stopDriverTracking();
            }
        }

        function startDriverTracking() {
            if (!navigator.geolocation) {
                showNotification('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'warning');
                return;
            }

            watchId = navigator.geolocation.watchPosition(
                async (position) => {
                    try {
                        await supabaseClient
                            .from('driver_locations')
                            .upsert({
                                driver_id: currentDriver.id,
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                car_type: currentDriver.car_type,
                                last_seen: new Date()
                            }, { onConflict: 'driver_id' });
                    } catch (error) {
                        console.error('Tracking error:', error);
                    }
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'error');
                },
                { enableHighAccuracy: true, maximumAge: 10000, timeout: 15000 }
            );
        }

        function stopDriverTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
        }

        function subscribeToRideRequests() {
            // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù†ÙˆØ¹ Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
            const channel = supabaseClient.channel(`driver-requests-${currentDriver.car_type}`)
                .on('broadcast', { event: 'new-ride' }, (payload) => {
                    // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø© Ù„Ù„Ø³Ø§Ø¦Ù‚
                    showRideRequestToDriver(payload.payload);
                })
                .subscribe();

            return channel;
        }

        function showRideRequestToDriver(rideData) {
            // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
            playNotificationSound();
            
            // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ù„Ø¨
            document.getElementById('incoming-ride-overlay').classList.remove('hidden');
            document.getElementById('ride-vehicle-type').textContent = getVehicleTypeName(rideData.vehicle_type);
            document.getElementById('ride-distance').textContent = `${rideData.distance_km.toFixed(1)} ÙƒÙ…`;
            document.getElementById('ride-price').textContent = `${rideData.amount.toLocaleString()} SDG`;
            
            // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
            startDriverCountdown(rideData);
        }

        function startDriverCountdown(rideData) {
            let timeLeft = rideTimeout;
            const countdownElement = document.getElementById('ride-countdown');
            
            const timer = setInterval(() => {
                timeLeft--;
                countdownElement.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    declineRide();
                }
            }, 1000);
            
            // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø©
            currentRideId = rideData.id;
        }

        async function acceptRide() {
            try {
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø©
                await supabaseClient
                    .from('rides')
                    .update({
                        driver_id: currentDriver.id,
                        driver_name: currentDriver.full_name,
                        driver_phone: currentDriver.whatsapp_number,
                        status: 'driver_accepted',
                        accepted_at: new Date()
                    })
                    .eq('id', currentRideId);

                // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ù„Ø¨
                document.getElementById('incoming-ride-overlay').classList.add('hidden');
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©
                showActiveTrip('driver');

            } catch (error) {
                console.error('Accept ride error:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©', 'error');
            }
        }

        function declineRide() {
            document.getElementById('incoming-ride-overlay').classList.add('hidden');
            showNotification('ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚ Ø¢Ø®Ø±', 'info');
        }

        // --- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© ---
        async function showActiveTrip(userType) {
            try {
                // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø©
                const { data: ride, error } = await supabaseClient
                    .from('rides')
                    .select('*')
                    .eq('id', currentRideId)
                    .single();

                if (error) throw error;

                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                document.getElementById('trip-customer-name').textContent = ride.customer_name;
                document.getElementById('trip-customer-phone').textContent = ride.customer_phone;
                document.getElementById('trip-vehicle-type').textContent = getVehicleTypeName(ride.vehicle_type);
                document.getElementById('trip-amount').textContent = `${ride.amount.toLocaleString()} SDG`;
                
                // Ø­Ø³Ø§Ø¨ ØµØ§ÙÙŠ Ø¯Ø®Ù„ Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ø®ØµÙ… 6%)
                const driverNet = ride.amount * 0.94;
                document.getElementById('driver-net-amount').textContent = `${driverNet.toLocaleString()} SDG`;

                // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                if (userType === 'customer') {
                    document.getElementById('customer-controls').classList.remove('hidden');
                    document.getElementById('driver-controls').classList.add('hidden');
                } else {
                    document.getElementById('customer-controls').classList.add('hidden');
                    document.getElementById('driver-controls').classList.remove('hidden');
                }
                
                document.getElementById('end-trip-controls').classList.add('hidden');

                // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø­Ù„Ø©
                document.getElementById('active-trip-overlay').classList.remove('hidden');

            } catch (error) {
                console.error('Show active trip error:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø©', 'error');
            }
        }

        function markDriverArrived() {
            document.getElementById('customer-controls').classList.add('hidden');
            document.getElementById('driver-controls').classList.remove('hidden');
            showNotification('ØªÙ… Ø¥Ø¹Ù„Ø§Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ø§Ù„ÙˆØµÙˆÙ„', 'success');
        }

        function markArrivedAtDestination() {
            document.getElementById('driver-controls').classList.add('hidden');
            document.getElementById('end-trip-controls').classList.remove('hidden');
            showNotification('Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÙƒÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ù† Ø§Ù„Ø²Ø¨ÙˆÙ†', 'info');
        }

        async function endTrip() {
            try {
                // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
                const { data: ride, error } = await supabaseClient
                    .from('rides')
                    .select('*')
                    .eq('id', currentRideId)
                    .single();

                if (error) throw error;

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø³ÙˆÙ…
                const serviceFee = ride.amount * 0.06;
                const driverEarnings = ride.amount - serviceFee;

                // ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ø³Ø§Ø¦Ù‚
                await supabaseClient
                    .from('drivers')
                    .update({ 
                        balance: currentDriver.balance + driverEarnings 
                    })
                    .eq('id', currentDriver.id);

                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø©
                await supabaseClient
                    .from('rides')
                    .update({
                        status: 'completed',
                        completed_at: new Date(),
                        service_fee: serviceFee,
                        driver_earnings: driverEarnings
                    })
                    .eq('id', currentRideId);

                // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
                document.getElementById('active-trip-overlay').classList.add('hidden');
                showNotification('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                
                setTimeout(() => {
                    location.reload();
                }, 2000);

            } catch (error) {
                console.error('End trip error:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©', 'error');
            }
        }

        async function cancelRide(cancelledBy) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©ØŸ')) return;

            try {
                await supabaseClient
                    .from('rides')
                    .update({
                        status: 'cancelled',
                        cancelled_by: cancelledBy,
                        cancelled_at: new Date()
                    })
                    .eq('id', currentRideId);

                document.getElementById('active-trip-overlay').classList.add('hidden');
                showNotification('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©', 'info');
                
                setTimeout(() => {
                    location.reload();
                }, 1500);

            } catch (error) {
                console.error('Cancel ride error:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©', 'error');
            }
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ---
        let staffClickCount = 0;

        function checkStaffAccess() {
            staffClickCount++;
            if (staffClickCount === 5) {
                document.getElementById('passcode-modal').classList.remove('hidden');
                staffClickCount = 0;
            }
        }

        function closePasscodeModal() {
            document.getElementById('passcode-modal').classList.add('hidden');
            document.getElementById('staff-input-pass').value = '';
        }

        async function verifyStaffPasscode() {
            const enteredPass = document.getElementById('staff-input-pass').value;
            
            // ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† (ÙŠØ¬Ø¨ ØªØºÙŠÙŠØ±Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬)
            const STAFF_PASSCODE = '123456';
            
            if (enteredPass === STAFF_PASSCODE) {
                closePasscodeModal();
                showSection('staff-section');
            } else {
                showNotification('Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­!', 'error');
            }
        }

        // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log("Sound playback not supported");
            }
        }

        function showNotification(message, type = 'info') {
            const notificationArea = document.getElementById('notification-area');
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.borderRightColor = colors[type] || colors.info;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 24px;">
                        ${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸'}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; margin-bottom: 5px; color: #1f2937;">
                            ${type === 'success' ? 'Ù†Ø¬Ø§Ø­' : type === 'error' ? 'Ø®Ø·Ø£' : type === 'warning' ? 'ØªØ­Ø°ÙŠØ±' : 'Ù…Ø¹Ù„ÙˆÙ…Ø©'}
                        </div>
                        <div style="color: #4b5563; font-size: 14px;">${message}</div>
                    </div>
                </div>
            `;
            
            notificationArea.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.5s ease reverse';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        async function updateTodayEarnings() {
            if (!currentDriver) return;
            
            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const { data: rides, error } = await supabaseClient
                    .from('rides')
                    .select('driver_earnings')
                    .eq('driver_id', currentDriver.id)
                    .gte('completed_at', today.toISOString())
                    .eq('status', 'completed');
                
                if (error) throw error;
                
                const totalEarnings = rides.reduce((sum, ride) => sum + (ride.driver_earnings || 0), 0);
                document.getElementById('today-earnings').textContent = `${totalEarnings.toLocaleString()} SDG`;
                
            } catch (error) {
                console.error('Update earnings error:', error);
            }
        }

        async function updateRideStatus(status) {
            if (!currentRideId) return;
            
            try {
                await supabaseClient
                    .from('rides')
                    .update({ status: status })
                    .eq('id', currentRideId);
            } catch (error) {
                console.error('Update ride status error:', error);
            }
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ©
        setTimeout(() => {
            if (document.getElementById('login-screen').classList.contains('hidden') && 
                document.getElementById('driver-login-screen').classList.contains('hidden') &&
                document.getElementById('home-screen').classList.contains('hidden')) {
                showSection('login-screen');
            }
        }, 100);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ±Ø­Ø§Ù„ Ø§Ù„Ø³ÙˆØ¯Ø§Ù†</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">

    <script src="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: sans-serif; margin: 0; background: #f4f4f9; text-align: center; }
        .header { background: #4f46e5; color: white; padding: 20px; font-size: 22px; }
        .main-container { padding: 20px; display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }
        button { padding: 15px; border-radius: 10px; border: none; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn-cust { background: #2563eb; color: white; }
        .btn-drive { background: #16a34a; color: white; }
        #map { width: 100%; height: 300px; display: none; margin-top: 20px; border-radius: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="header">ØªØ±Ø­Ø§Ù„ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† ğŸ‡¸ğŸ‡©</div>

    <div id="welcome-screen" class="main-container">
        <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h2>
        <button class="btn-cust" onclick="showForm('customer')">ØªØ³Ø¬ÙŠÙ„ ÙƒØ²Ø¨ÙˆÙ†</button>
        <button class="btn-drive" onclick="showForm('driver')">ØªØ³Ø¬ÙŠÙ„ ÙƒØ³Ø§Ø¦Ù‚</button>
    </div>

    <div id="reg-form" class="main-container hidden">
        <h3 id="form-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h3>
        <input type="text" id="name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø±Ø¨Ø§Ø¹ÙŠ" style="padding:12px; border-radius:8px; border:1px solid #ccc;">
        <input type="tel" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„" style="padding:12px; border-radius:8px; border:1px solid #ccc;">
        <button id="action-btn" class="btn-cust">Ù…ØªØ§Ø¨Ø¹Ø©</button>
        <button onclick="location.reload()" style="background:none; color:blue;">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div id="map"></div>

    <script>
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù€ Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js');
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Supabase (Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ)
        const SB_URL = 'YOUR_SUPABASE_URL';
        const SB_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const supabase = supabase.createClient(SB_URL, SB_KEY);

        function showForm(type) {
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('reg-form').classList.remove('hidden');
            const btn = document.getElementById('action-btn');
            
            if(type === 'driver') {
                document.getElementById('form-title').innerText = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†';
                btn.innerText = 'ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨';
                btn.className = 'btn-drive';
                btn.onclick = () => window.open('https://wa.me/249XXXXXXXXX', '_blank');
            } else {
                btn.onclick = () => alert('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ù…...');
            }
        }
    </script>
<div id="active-trip-overlay" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; justify-content: center;">
    <h2 style="color: #4f46e5;">Ø§Ù„Ø±Ø­Ù„Ø© Ø³Ø§Ø±ÙŠØ© Ø§Ù„Ø¢Ù†... ğŸš—</h2>
    <div id="trip-map-mini" style="width: 100%; height: 300px; border-radius: 15px; margin: 20px 0;"></div>
    <div style="background: #f3f4f6; padding: 15px; border-radius: 10px; width: 100%; text-align: center; margin-bottom: 20px;">
        <p><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø±ØµÙŠØ¯:</strong> Ø³ÙŠØªÙ… Ø®ØµÙ… 3,000 SDG Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</p>
    </div>
    <button onclick="confirmEndTrip()" style="background: #ef4444; color: white; padding: 15px 40px; border-radius: 10px; font-weight: bold; width: 100%;">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
</div>

<script>
    // Ø¯Ø§Ù„Ø© Ù„ØªÙØ¹ÙŠÙ„ Ù‚ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
    function startActiveTripUI() {
        document.getElementById('active-trip-overlay').classList.remove('hidden');
        // Ù…Ù†Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ (Back Button) ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
        window.history.pushState(null, null, window.location.href);
        window.onpopstate = function() {
            window.history.go(1);
        };
    }

    async function confirmEndTrip() {
        if (confirm("Ù‡Ù„ ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ¬Ù‡Ø©ØŸ Ø³ÙŠØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© ÙˆØ®ØµÙ… Ø§Ù„Ø±Ø³ÙˆÙ….")) {
            // ØªÙ†ÙÙŠØ° ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… ÙÙŠ Supabase Ø§Ù„Ø°ÙŠ ÙƒØªØ¨Ù†Ø§Ù‡ Ø³Ø§Ø¨Ù‚Ø§Ù‹
            await completeTrip(currentTripId, currentDriverId);
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚ÙÙ„ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙ†Ù‚Ù„
            document.getElementById('active-trip-overlay').classList.add('hidden');
            window.onpopstate = null; 
        }
    }
</script>
</body>
</html>

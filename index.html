<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ترحال زونا السودان - Tarhal</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <link rel="icon" href="icons/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- Tajawal Font -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Ionicons Icons -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

    <!-- Firebase for Notifications -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* جميع الأنماط الأصلية هنا - بدون تغيير */
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --primary-light: #e0e7ff;
            --secondary: #10b981;
            --secondary-dark: #059669;
            --warning: #f59e0b;
            --danger: #ef4444;
            --danger-dark: #dc2626;
            --light: #f9fafb;
            --dark: #111827;
            --gray: #6b7280;
            --gray-light: #e5e7eb;
            
            --driver: #16a34a;
            --tuk-tuk: #059669;
            --economy: #2563eb;
            --comfort: #7c3aed;
            --vip: #d97706;
            --staff: #7c3aed;
            
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --radius: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        /* تصفير القيم الافتراضية — مهم جدًا */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        /* Body */
        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Container */
        .app-container {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--light);
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 2px;
            text-align: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 9999;
            border-bottom: 4px solid var(--primary-dark);
        }

        /*  هذا كان سبب الفراغ الأعلى والأسفل */
        .app-header h1 {
            margin: 0;              /* مهم جدًا */
            padding: 0;
            font-size: 24px;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            line-height: 1.2;       /* يمنع فراغ عمودي خفي */
        }

        /* Logo */
        .app-header .logo {
            max-height: 50px;
            width: auto;
            padding: 0;
            display: block;
        }
        
        /* Screens */
        .screen {
            padding: 0;
            min-height: calc(100vh - 76px);
            display: flex;
            flex-direction: column;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-light);
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 16px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        /* Buttons */
        .btn {
            padding: 16px 24px;
            border-radius: var(--radius);
            border: none;
            font-family: 'Tajawal', sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-bottom: 12px;
        }
        
        .btn:active {
            transform: translateY(2px);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.3);
        }
        
        .btn-secondary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-secondary:hover {
            background: var(--secondary-dark);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }
        
        .btn-driver {
            background: var(--driver);
            color: white;
        }
        
        .btn-driver:hover {
            background: #15803d;
            box-shadow: 0 6px 20px rgba(22, 163, 74, 0.3);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary-light);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: var(--danger-dark);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark);
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--gray-light);
            border-radius: var(--radius);
            font-family: 'Tajawal', sans-serif;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .form-input::placeholder {
            color: var(--gray);
        }
        
        /* Welcome Screen */
        .welcome-card {
            text-align: center;
            padding: 40px 24px;
            background: linear-gradient(135deg, #e0e7ff 0%, #ede9fe 100%);
            border: none;
            margin-top: 40px;
        }
        
        .welcome-icon {
            font-size: 64px;
            margin-bottom: 24px;
            color: var(--primary);
        }
        
        .welcome-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 12px;
        }
        
        .welcome-subtitle {
            color: var(--gray);
            font-size: 16px;
            margin-bottom: 40px;
            line-height: 1.6;
        }
        
        .role-selection {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .role-card {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            text-align: right;
        }
        
        .role-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
        }
        
        .role-icon {
            font-size: 32px;
            color: var(--primary);
        }
        
        .role-info h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--dark);
        }
        
        .role-info p {
            font-size: 14px;
            color: var(--gray);
            line-height: 1.5;
        }
        
        /* Login Screens */
        .login-form {
            max-width: 400px;
            margin: 0 auto;
            width: 100%;
        }
        
        .form-footer {
            text-align: center;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-light);
        }
        
        .form-footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .form-footer .register-text {
            margin-bottom: 20px;
        }
        
        .form-footer .register-text a {
            display: inline;
        }
        
        .form-footer .back-link {
            display: inline-flex;
            justify-content: center;
            margin-top: 8px;
            padding: 10px 16px;
            border-radius: 12px;
            background: #f1f2ff;
            font-size: 14px;
        }
        
        .form-footer a:hover {
            text-decoration: underline;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: white;
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--shadow-xl);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 12px;
            border-right: 4px solid var(--primary);
            animation: slideIn 0.3s ease;
            max-width: 500px;
            margin: 0 auto;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .notification-icon {
            font-size: 24px;
        }
        
        .notification-success {
            border-right-color: var(--secondary);
        }
        
        .notification-error {
            border-right-color: var(--danger);
        }
        
        .notification-warning {
            border-right-color: var(--warning);
        }
        
        /* Overlay Modals */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal {
            background: white;
            border-radius: var(--radius-xl);
            padding: 32px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.4s ease;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(40px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .modal-subtitle {
            color: var(--gray);
            font-size: 16px;
        }
        
        /* Home Screen */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 32px;
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: 700;
        }
        
        .user-info h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--dark);
        }
        
        .user-info p {
            color: var(--gray);
            font-size: 14px;
        }
        
        .verified-badge {
            background: var(--secondary);
            color: white;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 9px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .home-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        
        .action-card {
            background: white;
            border-radius: var(--radius);
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid var(--gray-light);
        }
        
        .action-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
            border-color: var(--primary-light);
        }
        
        .action-icon {
            font-size: 28px;
            margin-bottom: 9px;
            color: var(--primary);
        }
        
        .action-card h4 {
            font-size: 12px;
            font-weight: 700;
            color: var(--dark);
        }
        
        /* Ride Request - أنماط جديدة */
        .ride-screen-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 9999;
            box-shadow: var(--shadow);
        }
        
        .ride-screen-header h2 {
            font-size: 20px;
            font-weight: 700;
            margin: 0;
        }
        
        .ride-screen-header .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: var(--radius);
            font-family: 'Tajawal', sans-serif;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .ride-screen-header .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .ride-screen-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .map-wrapper {
            position: relative;
            border-radius: var(--radius);
            overflow: hidden;
            border: 2px solid var(--gray-light);
            margin-bottom: 20px;
        }
        
        .map-container {
            width: 100%;
            height: 350px;
            border-radius: var(--radius);
            overflow: hidden;
            position: relative;
        }
        
        .map-controls-top {
            position: absolute;
            top: 15px;
            left: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        
        .map-control-btn {
            width: 45px;
            height: 45px;
            background: white;
            border: 2px solid var(--gray-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            color: var(--primary);
            font-size: 20px;
        }
        
        .map-control-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary);
            transform: scale(1.05);
        }
        
        .start-marker {
            background: #4f46e5;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }
        
        .end-marker {
            background: #ef4444;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }
        
        .route-info-card {
            border-right: 4px solid var(--primary);
            background: #f8fafc;
            padding: 16px;
            border-radius: var(--radius);
            margin-bottom: 20px;
        }
        
        .route-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .route-detail-item:last-child {
            border-bottom: none;
        }
        
        .route-detail-label {
            color: var(--gray);
            font-size: 14px;
        }
        
        .route-detail-value {
            color: var(--dark);
            font-weight: 600;
            font-size: 14px;
        }
        
        /* Driver Dashboard */
        .driver-status {
            background: var(--light);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .status-offline {
            background: #fee2e2;
            color: var(--danger);
        }
        
        .status-online {
            background: #dcfce7;
            color: var(--secondary-dark);
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .status-offline .status-dot {
            background: var(--danger);
        }
        
        .status-online .status-dot {
            background: var(--secondary);
        }
        
        .driver-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 16px;
            text-align: center;
            border: 1px solid var(--gray-light);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--gray);
        }
        
        /* Responsive */
        @media (max-width: 480px) {
            .ride-screen-content {
                padding: 16px;
            }
            
            .map-container {
                height: 300px;
            }
            
            .map-control-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .home-actions {
                grid-template-columns: 1fr;
            }
        }
        
        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Utility Classes */
        .text-center { text-align: center; }
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .mb-3 { margin-bottom: 24px; }
        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }
        .mt-3 { margin-top: 24px; }
        .p-1 { padding: 8px; }
        .p-2 { padding: 16px; }
        .p-3 { padding: 24px; }
        
        /* PWA Install Prompt */
        #pwa-install-prompt {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideUp 0.3s ease;
        }
        
        .pwa-mode .app-header {
            padding-top: env(safe-area-inset-top, 20px);
        }
        
        .app-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-img {
            width: 70px;
            height: 70px;
            object-fit: contain;
        }
        
        /* In-app Notification */
        .in-app-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            left: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 99999;
            animation: slideDown 0.3s ease;
            border-right: 4px solid #4f46e5;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 400px;
            margin: 0 auto;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Notification Activation Modal */
        #notification-activation-prompt {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 99999;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        
        /* Sound Control */
        .sound-control-panel {
            position: fixed;
            bottom: 80px;
            left: 20px;
            z-index: 1000;
        }
        
        #volume-slider {
            display: none;
            margin-top: 10px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        /* تنسيق المربعات المختارة */
        .location-mode-btn.active {
            background: #4f46e5 !important;
            color: white !important;
        }

        /* تأثير النبض للوضع اليدوي */
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.7;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.3;
            }
            100% {
                transform: scale(1);
                opacity: 0.7;
            }
        }

        .pulsing-marker {
            animation: pulse 1.5s infinite;
        }
        
        /* تحسينات جديدة للبحث */
        .enhanced-loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(79, 70, 229, 0.3);
            border-radius: 50%;
            border-top-color: #4f46e5;
            animation: enhanced-spin 1s ease-in-out infinite;
        }
        
        @keyframes enhanced-spin {
            to { transform: rotate(360deg); }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        .slide-in-up {
            animation: slideInUp 0.3s ease-out;
        }
        
        @keyframes slideInUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>

<!-- Splash Screen -->
<div id="splash-screen">
  <div class="splash-content">

    <div class="pulse-ring"></div>

    <img src="icons/icon-512x512.png" alt="Tarhal Zoona Logo" class="splash-logo">

    <div class="loader"></div>
    <p class="splash-text">جاري تشغيل ترحال زونا…</p>

  </div>
</div>

<style>
/* ===============================
   Splash Screen - Zoona Theme
================================ */

#splash-screen {
  position: fixed;
  inset: 0;
  background: linear-gradient(
    135deg,
    #4338ca,
    #4f46e5,
    #6366f1
  );
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999999;
  transition: opacity 0.6s ease, visibility 0.6s ease;
}

.splash-content {
  text-align: center;
  position: relative;
}

/* Logo */
.splash-logo {
  width: 180px;
  max-width: 70vw;
  height: auto;
  position: relative;
  z-index: 2;
  animation: logoIn 0.9s ease;
}

/* Pulse Ring (حول الشعار) */
.pulse-ring {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 230px;
  height: 230px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.18);
  transform: translate(-50%, -50%);
  animation: pulse 1.9s infinite;
  z-index: 1;
}

/* Loader */
.loader {
  margin: 26px auto 10px;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 4px solid rgba(255,255,255,0.35);
  border-top-color: #ffffff;
  animation: spin 0.9s linear infinite;
}

/* Text */
.splash-text {
  font-family: "Tajawal", system-ui, sans-serif;
  font-size: 14px;
  color: #eef2ff;
  letter-spacing: 0.4px;
}

/* Animations */
@keyframes spin {
  to { transform: rotate(360deg); }
}

@keyframes pulse {
  0% {
    transform: translate(-50%, -50%) scale(0.9);
    opacity: 0.6;
  }
  100% {
    transform: translate(-50%, -50%) scale(1.25);
    opacity: 0;
  }
}

@keyframes logoIn {
  from {
    transform: scale(0.85);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}

/* Hide Splash */
#splash-screen.hide {
  opacity: 0;
  visibility: hidden;
}
</style>

<script>
/* إخفاء Splash بعد جاهزية التطبيق */
window.addEventListener("load", () => {
  setTimeout(() => {
    document.getElementById("splash-screen").classList.add("hide");
  }, 900);
});
</script>

    <!-- Notification Activation Modal (Dynamic) -->
    <div id="notification-activation-modal"></div>
    
    <!-- Sound Control Panel -->
    <div class="sound-control-panel">
        <button id="sound-toggle" onclick="toggleAppSound()" 
                style="width: 50px; height: 50px; border-radius: 50%; 
                       background: #4f46e5; border: none; color: white;
                       display: flex; align-items: center; justify-content: center;
                       cursor: pointer; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);">
            <ion-icon name="volume-high" id="sound-icon" style="font-size: 24px;"></ion-icon>
        </button>
        
        <div id="volume-slider">
            <input type="range" min="0" max="100" value="70" 
                   oninput="changeVolume(this.value)" style="width: 100%;">
        </div>
    </div>
    
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <h1 class="app-title">
                <img 
                    src="icons/icon-512x512.png" 
                    alt="ترحال زونا السودان" 
                    class="logo-img"
                >
                ترحــال زونــا
            </h1>
        </header>
        
        <!-- Welcome Screen -->
        <section id="welcome-screen" class="screen">
            <div class="welcome-card card">
                <h1 class="welcome-title">مرحباً بك في ترحال زونا</h1>
                <p class="welcome-subtitle">
                    تطبيق النقل الأول في السودان. اختر طريقة دخولك للبدء
                </p>
                
                <div class="role-selection">
                    <!-- طالب رحلة -->
                    <div class="role-card" onclick="showCustomerLogin()">
                        <div class="role-icon">
                            <i class="fa-solid fa-user"></i>
                        </div>
                        <div class="role-info">
                            <h3>طالب رحلة</h3>
                            <p>اطلب رحلة بسهولة وأمان من أقرب سائق لك</p>
                        </div>
                        <ion-icon name="chevron-forward-outline"></ion-icon>
                    </div>

                    <!-- سائق -->
                    <div class="role-card" onclick="showDriverLogin()">
                        <div class="role-icon">
                            <i class="fa-solid fa-car"></i>
                        </div>
                        <div class="role-info">
                            <h3>سائق</h3>
                            <p>انضم كسائق وابدأ كسب المال مع ترحال زونا</p>
                        </div>
                        <ion-icon name="chevron-forward-outline"></ion-icon>
                    </div>

                    <div class="form-footer mt-3">
                        <a href="/admin-login.html">
                            <ion-icon name="shield-checkmark-outline"></ion-icon>
                            دخول الموظفين
                        </a>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Customer Login -->
        <section id="customer-login-screen" class="screen hidden">
            <div class="card">
                <h2 class="card-title">
                    <ion-icon name="person-circle-outline"></ion-icon>
                    دخول طالب الرحلة
                </h2>
                
                <form class="login-form" id="customerLoginForm">
                    <div class="form-group">
                        <label class="form-label" for="customer-phone">رقم الواتساب</label>
                        <input type="tel" id="customer-phone" class="form-input" 
                               placeholder="ادخل رقم الواتساب" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="customer-password">كلمة المرور</label>
                        <input type="password" id="customer-password" class="form-input" 
                               placeholder="ادخل كلمة المرور" required>
                    </div>
                    
                    <button type="button" class="btn btn-primary" onclick="loginCustomer()">
                        <ion-icon name="log-in-outline"></ion-icon>
                        تسجيل الدخول
                    </button>
                </form>
                
                <div class="form-footer">
                    <p class="register-text">
                        ليس لديك حساب؟
                        <a href="#" onclick="showCustomerRegister()">سجل حساب الآن</a>
                    </p>

                    <a href="#" class="back-link" onclick="showWelcomeScreen()">
                        <ion-icon name="arrow-back-outline"></ion-icon>
                        العودة للخيارات
                    </a>
                </div>
            </div>
        </section>
        
        <!-- Customer Registration -->
        <section id="customer-register-screen" class="screen hidden">
            <div class="card">
                <h2 class="card-title">
                    <ion-icon name="person-add-outline"></ion-icon>
                    تسجيل حساب جديد
                </h2>
                
                <form class="login-form" id="customerRegisterForm">
                    <div class="form-group">
                        <label class="form-label" for="register-fullname">الاسم الرباعي</label>
                        <input type="text" id="register-fullname" class="form-input" 
                               placeholder="الاسم الرباعي" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="register-phone">رقم الواتساب</label>
                        <input type="tel" id="register-phone" class="form-input" 
                               placeholder="رقم الواتساب (للتسجيل)" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="register-phone2">رقم إضافي (اختياري)</label>
                        <input type="tel" id="register-phone2" class="form-input" 
                               placeholder="رقم إضافي للتواصل">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="register-password">كلمة المرور</label>
                        <input type="password" id="register-password" class="form-input" 
                               placeholder="اختر كلمة مرور قوية" required>
                    </div>
                    
                    <button type="button" class="btn btn-primary" onclick="registerCustomer()">
                        <ion-icon name="create-outline"></ion-icon>
                        تسجيل الحساب
                    </button>
                </form>
                
                <div id="verification-section" class="hidden mt-3">
                    <div class="card" style="background: #f0f9ff; border: 2px dashed var(--secondary);">
                        <h3 class="mb-2" style="color: var(--secondary);">
                            <ion-icon name="checkmark-circle-outline"></ion-icon>
                            تم التسجيل بنجاح!
                        </h3>
                        <p class="mb-2">لتفعيل حسابك، يرجى الضغط على الزر أدناه لإرسال رسالة تأكيد:</p>
                        
                        <button type="button" class="btn btn-secondary" onclick="sendVerificationWhatsApp()">
                            <ion-icon name="logo-whatsapp"></ion-icon>
                            تأكيد الحساب عبر واتساب
                        </button>
                        
                        <p class="mt-2" style="font-size: 14px; color: var(--gray);">
                            بعد إرسال الرسالة، سيتم تفعيل حسابك تلقائياً خلال دقائق
                        </p>
                    </div>
                </div>
                
                <div class="form-footer mt-3">
                    <a href="#" onclick="showCustomerLogin()">
                        <ion-icon name="arrow-back-outline"></ion-icon>
                        العودة لتسجيل الدخول
                    </a>
                </div>
            </div>
        </section>
        
        <!-- Driver Login -->
        <section id="driver-login-screen" class="screen hidden">
            <div class="card">
                <h2 class="card-title">
                    <ion-icon name="car-sport-outline"></ion-icon>
                    دخول السائقين
                </h2>
                
                <form class="login-form" id="driverLoginForm">
                    <div class="form-group">
                        <label class="form-label" for="driver-phone">رقم واتساب السائق</label>
                        <input type="tel" id="driver-phone" class="form-input" 
                               placeholder="رقم الواتساب المسجل" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="driver-password">كلمة المرور</label>
                        <input type="password" id="driver-password" class="form-input" 
                               placeholder="كلمة مرور السائق" required>
                    </div>
                    
                    <button type="button" class="btn btn-driver" onclick="loginDriver()">
                        <ion-icon name="log-in-outline"></ion-icon>
                        دخول السائق
                    </button>
                </form>
                
                <div class="form-footer">
                    <p>ليس لديك حساب؟ 
                        <a href="#" onclick="showDriverRegisterInfo()">سجل كسائق الآن</a>
                    </p><p></p>
                                        <a href="#" class="back-link" onclick="showWelcomeScreen()">
                        <ion-icon name="arrow-back-outline"></ion-icon>
                        العودة للخيارات
                    </a>
                </div>
            </div>
        </section>
        
        <!-- Driver Registration Info -->
        <section id="driver-register-info-screen" class="screen hidden">
            <div class="card">
                <h2 class="card-title">
                    <ion-icon name="information-circle-outline"></ion-icon>
                    التسجيل كسائق
                </h2>
                
                <div class="mb-3">
                    <p>للتسجيل كسائق في تطبيق ترحال زونا ، يرجى التواصل مع إدارتنا على واتساب لإكمال عملية التسجيل:</p>
                    
                    <div class="p-3" style="background: #f0f9ff; border-radius: var(--radius); margin: 20px 0;">
                        <h4 class="mb-2" style="color: var(--primary);">المستندات المطلوبة:</h4>
                        <ul style="padding-right: 20px; line-height: 1.8;">
                            <li>رخصة القيادة السارية</li>
                            <li>استمارة السيارة</li>
                            <li>صورة شخصية</li>
                            <li>صورة السيارة من الخارج</li>
                            <li>صورة لوحة السيارة</li>
                        </ul>
                    </div>
                </div>
                
                <button type="button" class="btn btn-driver" onclick="contactAdminForDriverRegistration()">
                    <ion-icon name="logo-whatsapp"></ion-icon>
                    التواصل مع الإدارة على واتساب
                </button>
                
                <div class="form-footer mt-3">
                    <a href="#" onclick="showDriverLogin()">
                        <ion-icon name="arrow-back-outline"></ion-icon>
                        العودة لتسجيل الدخول
                    </a>
                </div>
            </div>
        </section>
        
        <!-- Home Screen (After Login) -->
        <section id="home-screen" class="screen hidden">
            <div class="card">
                <div class="user-profile">
                    <div class="user-avatar" id="user-avatar">?</div>
                    <div class="user-info">
                        <h3 id="user-name">مرحباً</h3>
                        <p id="user-phone-display"></p>
                        <div id="verification-status" class="hidden mt-1">
                            <span class="verified-badge">
                                <ion-icon name="checkmark-circle"></ion-icon>
                                حساب موثق
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="home-actions">
                    <div class="action-card" onclick="requestRide()">
                        <div class="action-icon"></div>
                        <h4>طلب رحلة</h4>
                    </div>
                    
                    <div class="action-card" onclick="showMyRides()">
                        <div class="action-icon"></div>
                        <h4>رحلاتي</h4>
                    </div>
                    
                    <div class="action-card" onclick="showWallet()">
                        <div class="action-icon"></div>
                        <h4>المحفظة</h4>
                    </div>
                    
                    <div class="action-card" onclick="showSettings()">
                        <div class="action-icon">⚙️</div>
                        <h4>الإعدادات</h4>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="testAdvancedNotifications()" style="margin-top: 20px;">
                    <ion-icon name="notifications-outline"></ion-icon>
                     اختبار الإشعارات المتقدمة
                </button>
                
                <button id="driver-notification-btn" class="btn btn-secondary mt-2 hidden" onclick="setupDriverNotifications()">
                    <ion-icon name="notifications"></ion-icon>
                     تفعيل إشعارات السائق
                </button>
                
                <button class="btn btn-outline mt-3" onclick="logout()">
                    <ion-icon name="log-out-outline"></ion-icon>
                    تسجيل الخروج
                </button>
            </div>
        </section>
        
        <!-- Ride Request Screen -->
        <section id="ride-request-screen" class="screen hidden">
            <div class="ride-screen-header">
                <button class="back-btn" onclick="goHome()">
                    <ion-icon name="arrow-back-outline"></ion-icon>
                    إلغاء
                </button>
                <h2>طلب رحلة جديدة</h2>
                <div style="width: 50px;"></div> <!-- عنصر فارغ للمساواة -->
            </div>
            
            <div class="ride-screen-content">
                <!-- ملاحظة فوق الخريطة -->
                <div style="
                    background: #f0f9ff;
                    border: 2px solid #bae6fd;
                    border-radius: 12px;
                    padding: 12px 16px;
                    margin-bottom: 16px;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    flex-wrap: wrap;
                    gap: 10px;
                ">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <ion-icon name="information-circle" style="color: #0ea5e9; font-size: 20px;"></ion-icon>
                        <span style="font-weight: 600; color: #0369a1;">تأكد أن النقطة A هي مكانك الحالي</span>
                    </div>
                    
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span style="font-size: 14px; color: #475569;">تحديد النقطة A:</span>
                        <div style="
                            background: white;
                            border-radius: 20px;
                            border: 2px solid #e2e8f0;
                            display: flex;
                            overflow: hidden;
                        ">
                            <button id="auto-mode-btn" class="location-mode-btn active" onclick="setLocationMode('auto')" style="
                                padding: 8px 16px;
                                border: none;
                                background: #4f46e5;
                                color: white;
                                font-family: 'Tajawal';
                                font-size: 14px;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.3s ease;
                            ">
                                تلقائي
                            </button>
                            <button id="manual-mode-btn" class="location-mode-btn" onclick="setLocationMode('manual')" style="
                                padding: 8px 16px;
                                border: none;
                                background: #f1f5f9;
                                color: #64748b;
                                font-family: 'Tajawal';
                                font-size: 14px;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.3s ease;
                            ">
                                يدوي
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- الخريطة المعدلة -->
                <div class="map-wrapper">
                    <div class="map-container" id="ride-map">
                        <!-- سيتم تهيئة الخريطة هنا -->
                    </div>
                    
                    <!-- أزرار التحكم في مكان جديد -->
                    <div class="map-controls-top">
                        <button class="map-control-btn" onclick="recenterMap()" title="تحديد موقعك الحالي">
                            <ion-icon name="locate-outline"></ion-icon>
                        </button>
                        <button class="map-control-btn" onclick="refreshLocation()" title="تحديث الموقع">
                            <ion-icon name="refresh-outline"></ion-icon>
                        </button>
                    </div>
                    
                    <!-- زر حذف الوجهة -->
                    <div id="destination-clear-btn" class="hidden" style="position: absolute; top: 15px; right: 15px; z-index: 1000;">
                        <button onclick="clearDestination()" style="
                            background: var(--danger);
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 20px;
                            font-family: 'Tajawal';
                            font-size: 14px;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 5px;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                        ">
                            <ion-icon name="close-circle-outline"></ion-icon>
                            حذف الوجهة
                        </button>
                    </div>
                </div>
                
                <!-- تفاصيل المسار تظهر تلقائياً -->
                <div id="route-details-section" class="hidden">
                    <div class="route-info-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="color: var(--primary); font-weight: 700; margin: 0;">
                                <ion-icon name="navigate-outline" style="vertical-align: middle;"></ion-icon>
                                تفاصيل المسار
                            </h4>
                            <div style="font-size: 12px; color: var(--gray);">
                                <ion-icon name="time-outline" style="vertical-align: middle;"></ion-icon>
                                <span id="route-duration">0</span> دقيقة
                            </div>
                        </div>
                        
                        <div id="route-info-content">
                            <!-- سيتم تعبئة تفاصيل المسار هنا تلقائياً -->
                        </div>
                    </div>
                </div>
                
                <div style="
                    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                    border-radius: var(--radius);
                    padding: 16px;
                    margin-bottom: 16px;
                    border: 2px solid #e2e8f0;
                ">
                    <h4 class="form-label" style="
                        color: #334155;
                        font-weight: 700;
                        font-size: 16px;
                        margin-bottom: 16px;
                        text-align: center;
                    ">
                        <ion-icon name="car-outline" style="vertical-align: middle; margin-left: 8px;"></ion-icon>
                        اختر نوع المركبة
                    </h4>
                    <div class="vehicle-options" style="
  display: grid;
  grid-template-columns: repeat(4, auto);
  gap: 8px;
  justify-content: center;
  align-items: stretch;
  margin-bottom: 0;
">
                        <div class="vehicle-option" data-type="tuktuk" onclick="selectVehicle('tuktuk')" style="
                            border: 2px solid var(--gray-light);
                            border-radius: 10px;
                            padding: 12px 8px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            text-align: center;
                            background: white;
                        ">
                            <div class="vehicle-icon" style="font-size: 20px; margin-bottom: 6px;"></div>
                            <div class="vehicle-name" style="font-weight: 700; margin-bottom: 4px; font-size: 12px;">ركــشــــــــة</div>
                            <div class="vehicle-price" style="color: var(--primary); font-weight: 800; font-size: 14px;">5,000</div>
                        </div>
                        
                        <div class="vehicle-option" data-type="economy" onclick="selectVehicle('economy')" style="
                            border: 2px solid var(--gray-light);
                            border-radius: 10px;
                            padding: 12px 8px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            text-align: center;
                            background: white;
                        ">
                            <div class="vehicle-icon" style="font-size: 20px; margin-bottom: 6px;"></div>
                            <div class="vehicle-name" style="font-weight: 700; margin-bottom: 4px; font-size: 12px;">اقتصادية</div>
                            <div class="vehicle-price" style="color: var(--primary); font-weight: 800; font-size: 14px;">6,000</div>
                        </div>
                        
                        <div class="vehicle-option" data-type="comfort" onclick="selectVehicle('comfort')" style="
                            border: 2px solid var(--gray-light);
                            border-radius: 10px;
                            padding: 12px 8px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            text-align: center;
                            background: white;
                        ">
                            <div class="vehicle-icon" style="font-size: 20px; margin-bottom: 6px;"></div>
                            <div class="vehicle-name" style="font-weight: 700; margin-bottom: 4px; font-size: 12px;">متوسطة</div>
                            <div class="vehicle-price" style="color: var(--primary); font-weight: 800; font-size: 14px;">7,000</div>
                        </div>
                        
                        <div class="vehicle-option" data-type="vip" onclick="selectVehicle('vip')" style="
                            border: 2px solid var(--gray-light);
                            border-radius: 10px;
                            padding: 12px 8px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            text-align: center;
                            background: white;
                        ">
                            <div class="vehicle-icon" style="font-size: 20px; margin-bottom: 6px;">⭐</div>
                            <div class="vehicle-name" style="font-weight: 700; margin-bottom: 4px; font-size: 12px;">VIP</div>
                            <div class="vehicle-price" style="color: var(--primary); font-weight: 800; font-size: 14px;">10,000</div>
                        </div>
                    </div>
                </div>
                
                <div id="price-calculation" class="price-breakdown hidden" style="
                    background: var(--light);
                    border-radius: var(--radius);
                    padding: 20px;
                    margin-bottom: 24px;
                ">
                    <div class="price-row" style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--gray-light);">
                        <span>المسافة:</span>
                        <span id="distance-display">0 km</span>
                    </div>
                    <div class="price-row" style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--gray-light);">
                        <span>السعر الأساسي:</span>
                        <span id="base-price-display">0 SDG</span>
                    </div>
                    <div class="price-row" style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--gray-light);">
                        <span>رسوم إضافية:</span>
                        <span id="extra-price-display">0 SDG</span>
                    </div>
                    <div class="price-row" style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: none; font-weight: 800; font-size: 20px; color: var(--primary);">
                        <span>المجموع:</span>
                        <span id="total-price-display">0 SDG</span>
                    </div>
                </div>
                
                <button id="confirm-ride-btn" class="btn btn-primary" onclick="confirmRide()" disabled>
                    <ion-icon name="search-outline"></ion-icon>
                    بحث عن سائق
                </button>
            </div>
        </section>
        
        <!-- Driver Dashboard -->
        <section id="driver-dashboard-screen" class="screen hidden">
            <div class="card">
                <div class="user-profile">
                    <div class="user-avatar" id="driver-avatar">?</div>
                    <div class="user-info">
                        <h3 id="driver-name">سائق</h3>
                        <p id="driver-car-info">مركبة</p>
                    </div>
                </div>
                
                <div class="driver-status">
                    <div id="driver-status-indicator" class="status-indicator status-offline">
                        <span class="status-dot"></span>
                        <span id="driver-status-text">غير متصل</span>
                    </div>
                    
                    <button id="toggle-online-btn" class="btn btn-driver" onclick="toggleDriverStatus()">
                        <ion-icon name="power-outline"></ion-icon>
                        تفعيل وضع العمل
                    </button>
                </div>
                
                <div class="driver-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="driver-balance">0</div>
                        <div class="stat-label">رصيدك (SDG)</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-value" id="today-trips">0</div>
                        <div class="stat-label">رحلات اليوم</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-value" id="today-earnings">0</div>
                        <div class="stat-label">أرباح اليوم</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-value" id="total-trips">0</div>
                        <div class="stat-label">إجمالي الرحلات</div>
                    </div>
                </div>
                
                <!-- زر تفعيل إشعارات السائق في لوحة التحكم -->
                <button id="driver-notification-activation" class="btn btn-secondary" onclick="setupDriverNotifications()">
                    <ion-icon name="notifications-outline"></ion-icon>
                    تفعيل إشعارات الرحلات
                </button>
                
                <button class="btn btn-outline mt-2" onclick="showDriverProfile()">
                    <ion-icon name="person-outline"></ion-icon>
                    الملف الشخصي
                </button>
                
                <button class="btn btn-outline mt-2" onclick="logoutDriver()">
                    <ion-icon name="log-out-outline"></ion-icon>
                    تسجيل خروج السائق
                </button>
            </div>
        </section>
    </div>
    
    <!-- PWA Install Prompt -->
    <div id="pwa-install-prompt" style="display: none; position: fixed; bottom: 20px; left: 20px; right: 20px; background: white; padding: 16px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000;">
        <div style="text-align: center;">
            <h4 style="margin-bottom: 8px; color: var(--primary);">تثبيت تطبيق ترحال</h4>
            <p style="margin-bottom: 16px; color: var(--gray); font-size: 14px;">
                ثبّت التطبيق لاستخدامه بدون إنترنت وإشعارات فورية
            </p>
            <div style="display: flex; gap: 8px;">
                <button onclick="installPWA()" style="flex: 1; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-family: 'Tajawal'; font-weight: 700;">
                    تثبيت الآن
                </button>
                <button onclick="hideInstallPrompt()" style="flex: 1; padding: 12px; background: transparent; color: var(--gray); border: 1px solid var(--gray-light); border-radius: 8px; font-family: 'Tajawal';">
                    لاحقاً
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="notification-area"></div>
    
    <!-- Ride Request Modal (For Driver) -->
    <div id="incoming-ride-modal" class="overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <div style="font-size: 48px; margin-bottom: 16px;"></div>
                <h2 class="modal-title">طلب رحلة جديد!</h2>
                <p class="modal-subtitle">لديك 40 ثانية للرد</p>
            </div>
            
            <div class="card" style="background: #fef2f2;">
                <div id="ride-details">
                    <!-- سيتم تعبئة تفاصيل الرحلة هنا -->
                </div>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button class="btn btn-driver" onclick="acceptRide()" style="flex: 1;">
                    <ion-icon name="checkmark-outline"></ion-icon>
                    قبول الرحلة
                </button>
                <button class="btn btn-danger" onclick="declineRide()" style="flex: 1;">
                    <ion-icon name="close-outline"></ion-icon>
                    رفض
                </button>
            </div>
            
            <div class="countdown" style="text-align: center; font-size: 32px; font-weight: 800; color: var(--danger); margin-top: 20px;">
                40
            </div>
        </div>
    </div>
    
    <!-- Active Trip Modal -->
    <div id="active-trip-modal" class="overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <div style="font-size: 48px; margin-bottom: 16px;"></div>
                <h2 class="modal-title">الرحلة سارية الآن</h2>
            </div>
            
            <div id="trip-details">
                <!-- سيتم تعبئة تفاصيل الرحلة هنا -->
            </div>
        </div>
    </div>

    <script>
        // ============================================
        //  الجزء المعدل من الملف الرئيسي
        // التعديلات فقط كما طلبت
        // ============================================

        // --- Supabase Configuration ---
        const SB_URL = 'https://zsmlyiygjagmhnglrhoa.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzbWx5aXlnamFnbWhuZ2xyaG9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NDc3NjMsImV4cCI6MjA4MTUyMzc2M30.QviVinAng-ILq0umvI5UZCFEvNpP3nI0kW_hSaXxNps';
        
        const tarhalDB = supabase.createClient(SB_URL, SB_KEY);
        
        // --- Application State ---
        let currentUser = null;
        let currentDriver = null;
        let isDriverOnline = false;
        let selectedVehicleType = null;
        let rideMap = null;
        let startMarker = null;
        let endMarker = null;
        let userPosition = null;
        let destinationPosition = null;
        let currentRideId = null;
        let rideCountdownInterval = null;
        let rideTimeout = 40;
        let registeredPhone = null;
        let deferredPrompt = null;
        let routePolyline = null;
        let currentRoute = null;
        let routeCalculated = false;
        // في بداية index.html - بعد المتغيرات الأخرى
let notificationServiceUrl = 'https://zoona-go-eosin.vercel.app/api/send-ride-notification';
        
        // --- متغيرات جديدة لنظام البحث المحسن ---
        let locationMode = 'auto';
        let manualModeActive = false;
        let manualClickCount = 0;
        let pulsingMarker = null;
        let pulseInterval = null;
        
        // متغيرات النظام الجديد
        let notificationManager = null;
        let soundManager = null;
        let availableDrivers = [];
        let rideSearchInterval = null;
        let locationUpdateInterval = null;
        const MAX_SEARCH_RADIUS = 50; // أقصى نطاق بحث بالكيلومتر
        const SEARCH_STEP = 5; // زيادة النطاق كل مرة
        const MAX_SEARCH_TIME = 60000; // أقصى وقت بحث (60 ثانية)
        
        // Vehicle prices
        const VEHICLE_PRICES = {
            tuktuk: { base: 5000, perKm: 2000, name: 'ركشــــــة', icon: '' },
            economy: { base: 6000, perKm: 3000, name: 'اقتصادية', icon: '' },
            comfort: { base: 7000, perKm: 3500, name: 'متوسطة', icon: '' },
            vip: { base: 10000, perKm: 5000, name: 'VIP', icon: '⭐' }
        };
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log(' ترحال زونا - النظام المحسن');
            
            // تهيئة الأنظمة الأساسية
            initPWA();
            checkAuth();
            
            // تحميل إعدادات البحث
            const settings = JSON.parse(localStorage.getItem('tarhal_settings')) || {};
            if (settings.searchRadius) {
                MAX_SEARCH_RADIUS = settings.searchRadius;
            }
            
            // تحميل أنظمة الإشعارات بعد تأخير بسيط
// تحميل أنظمة الإشعارات بعد تأخير بسيط
setTimeout(() => {
  loadNotificationSystem();
  
  // تحميل إعدادات الصوت بعد تأكيد الإذن
  setTimeout(() => {
    if (soundManager && settings.soundsEnabled !== false) {
      soundManager.enabled = true;
      updateSoundButton();
      
      // ✅ تفعيل الصوت الفوري بعد 2 ثانية
      setTimeout(() => {
        if (window.soundManager) {
          console.log('🎵 جاري تفعيل النظام الصوتي...');
          window.soundManager.activateAudioImmediately();
        }
      }, 2000);
    }
  }, 1500);
}, 1000);
            
            // إضافة تحسينات لواجهة المستخدم
            addUIEnhancements();
        });
        
        function addUIEnhancements() {
            // إضافة تأثيرات تحميل إضافية
            const style = document.createElement('style');
            style.textContent = `
                .enhanced-loader {
                    display: inline-block;
                    width: 20px;
                    height: 20px;
                    border: 3px solid rgba(79, 70, 229, 0.3);
                    border-radius: 50%;
                    border-top-color: #4f46e5;
                    animation: enhanced-spin 1s ease-in-out infinite;
                }
                
                @keyframes enhanced-spin {
                    to { transform: rotate(360deg); }
                }
                
                .pulse-animation {
                    animation: pulse 2s infinite;
                }
                
                @keyframes pulse {
                    0% { transform: scale(1); opacity: 1; }
                    50% { transform: scale(1.05); opacity: 0.8; }
                    100% { transform: scale(1); opacity: 1; }
                }
                
                .slide-in-up {
                    animation: slideInUp 0.3s ease-out;
                }
                
                @keyframes slideInUp {
                    from { transform: translateY(30px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }
        
        // --- نظام PWA الأساسي ---
        // في ملف index.html - دالة initPWA() المعدلة
async function initPWA() {
  if (!('serviceWorker' in navigator)) {
    console.log('⚠️ Service Worker غير مدعوم في هذا المتصفح');
    return;
  }

  try {
    console.log('🔄 جاري تسجيل Service Workers...');
    
    // ✅ 1. تسجيل Service Worker الرئيسي (للـ PWA والكاش)
    const swRegistration = await navigator.serviceWorker.register(
      '/service-worker.js',
      { scope: '/' }
    );

    console.log('✅ Service Worker الرئيسي مسجل بنجاح');

    // ✅ 2. تسجيل Firebase Messaging Service Worker بشكل منفصل
    if ('serviceWorker' in navigator) {
      try {
        await navigator.serviceWorker.register('/firebase-messaging-sw.js', {
          scope: '/firebase-cloud-messaging-push-scope'
        });
        console.log('✅ Firebase Messaging SW مسجل بنجاح');
      } catch (firebaseSwError) {
        console.warn('⚠️ فشل تسجيل Firebase SW، استخدام الرئيسي:', firebaseSwError);
        // استخدم SW الرئيسي كاحتياطي للإشعارات
        if (window.firebase && firebase.messaging) {
          firebase.messaging().useServiceWorker(swRegistration);
        }
      }
    }

    // ✅ 3. تحديث Service Workers
    swRegistration.update();
    console.log('✅ تم تحديث Service Workers');

    // ✅ 4. تحميل Firebase فقط إذا كان المستخدم سائقاً أو كان مفعلاً سابقاً
    const isDriver = localStorage.getItem('tarhal_driver');
    const notificationsEnabled = localStorage.getItem('tarhal_notifications_asked');
    
    if (isDriver || notificationsEnabled) {
      await loadFirebase();
    }

  } catch (error) {
    console.error('❌ خطأ في تسجيل Service Workers:', error);
    
    // محاولة تسجيل Service Worker فقط بدون Firebase
    try {
      await navigator.serviceWorker.register('/service-worker.js', { scope: '/' });
      console.log('✅ تم تسجيل Service Worker الرئيسي فقط');
    } catch (simpleError) {
      console.error('❌ فشل تسجيل أي Service Worker');
    }
  }
            
            // معالجة تثبيت PWA
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                setTimeout(() => {
                    if (deferredPrompt) {
                        showInstallPrompt();
                    }
                }, 5000);
            });
            
            window.addEventListener('appinstalled', () => {
                console.log('✅ PWA مثبت');
                localStorage.setItem('pwa_installed', 'true');
                showNotification('تم تثبيت التطبيق بنجاح!', 'success');
            });
        }
        
        async function loadFirebase() {
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyBxQLDLqr4W3lApfYLPjSV5It7925a9Rr0",
                    authDomain: "double-carport-476915-j7.firebaseapp.com",
                    projectId: "double-carport-476915-j7",
                    storageBucket: "double-carport-476915-j7.firebasestorage.app",
                    messagingSenderId: "122641462099",
                    appId: "1:122641462099:web:345b777a88757d3ef7e7a6"
                };
                
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig);
                }
                console.log('✅ Firebase مهيأ');
            } catch (error) {
                console.log('⚠️ Firebase غير متاح، الاستمرار بدون إشعارات Firebase');
            }
        }
        
        // --- نظام الإشعارات المتقدم ---
        async function loadNotificationSystem() {
            try {
                // إنشاء مدير الإشعارات
                notificationManager = new TarhalNotificationManager();
                await notificationManager.initialize();
                window.notificationManager = notificationManager;
                
                console.log('✅ نظام الإشعارات جاهز');
                
                // إنشاء مدير الصوت
                soundManager = new TarhalSoundManager();
                window.soundManager = soundManager;
                
                // عرض نموذج التفعيل إذا لزم الأمر
                if (!localStorage.getItem('tarhal_notifications_asked')) {
                    setTimeout(() => {
                        notificationManager.showActivationPrompt();
                    }, 3000);
                }
                
            } catch (error) {
                console.error('❌ خطأ في تحميل نظام الإشعارات:', error);
            }
        }
        
        // --- PWA Functions ---
        function showInstallPrompt() {
            const prompt = document.getElementById('pwa-install-prompt');
            if (prompt) {
                prompt.style.display = 'block';
            }
        }
        
        function hideInstallPrompt() {
            const prompt = document.getElementById('pwa-install-prompt');
            if (prompt) {
                prompt.style.display = 'none';
            }
        }
        
        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    showNotification('تم تثبيت التطبيق بنجاح!', 'success');
                }
                
                deferredPrompt = null;
                hideInstallPrompt();
            }
        }
        
        // --- Screen Navigation ---
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
            
            // تحديث واجهة السائق عند التبديل
            if (screenId === 'driver-dashboard-screen') {
                updateDriverUI();
            }
            
            // إعادة ضبط حجم الخريطة عند عرض شاشة الرحلة
            if (screenId === 'ride-request-screen' && rideMap) {
                setTimeout(() => {
                    rideMap.invalidateSize();
                }, 300);
            }
        }
        
        function showWelcomeScreen() {
            showScreen('welcome-screen');
        }
        
        function showCustomerLogin() {
            showScreen('customer-login-screen');
            document.getElementById('customer-phone').focus();
        }
        
        function showCustomerRegister() {
            showScreen('customer-register-screen');
            document.getElementById('verification-section').classList.add('hidden');
            document.getElementById('register-fullname').focus();
            document.getElementById('customerRegisterForm').style.opacity = '1';
            document.querySelector('#customerRegisterForm button').disabled = false;
        }
        
        function showDriverLogin() {
            showScreen('driver-login-screen');
            document.getElementById('driver-phone').focus();
        }
        
        function showDriverRegisterInfo() {
            showScreen('driver-register-info-screen');
        }
        
        function goHome() {
            if (currentUser) {
                showScreen('home-screen');
            } else if (currentDriver) {
                showScreen('driver-dashboard-screen');
            } else {
                showScreen('welcome-screen');
            }
        }
        
        // --- تحديث واجهة السائق ---
        function updateDriverUI() {
            if (currentDriver) {
                // إظهار زر تفعيل الإشعارات إذا لم يكن مفعلاً
                const notificationBtn = document.getElementById('driver-notification-activation');
                if (notificationBtn && Notification.permission !== 'granted') {
                    notificationBtn.classList.remove('hidden');
                }
                
                // إظهار زر اختبار الإشعارات
                const testBtn = document.getElementById('driver-notification-btn');
                if (testBtn) {
                    testBtn.classList.remove('hidden');
                }
            }
        }
        
        // --- دوال الإشعارات المتقدمة ---
        async function testAdvancedNotifications() {
            if (notificationManager) {
                await notificationManager.sendTestNotification();
            } else {
                showNotification('⚠️ نظام الإشعارات غير جاهز بعد', 'warning');
            }
        }
        
        async function setupDriverNotifications() {
            if (!notificationManager) {
                showNotification('⚠️ جاري تهيئة نظام الإشعارات...', 'warning');
                await loadNotificationSystem();
            }
            
            if (notificationManager) {
                await notificationManager.enableAllFeatures();
                
                // إذا كان سائقاً، تسجيله في النظام
                if (currentDriver) {
                    await registerDriverForNotifications();
                }
            }
        }
        
        async function registerDriverForNotifications() {
            try {
                if (currentDriver && notificationManager) {
                    // الحصول على إذن الإشعارات
                    const permission = await Notification.requestPermission();
                    
                    if (permission === 'granted') {
                        // تسجيل السائق في قاعدة البيانات للإشعارات
                        await tarhalDB
                            .from('driver_notifications')
                            .upsert({
                                driver_id: currentDriver.id,
                                notification_enabled: true,
                                last_active: new Date().toISOString()
                            }, { onConflict: 'driver_id' });
                        
                        showNotification('✅ تم تفعيل إشعارات السائق بنجاح', 'success');
                        
                        // إخفاء زر التفعيل
                        const btn = document.getElementById('driver-notification-activation');
                        if (btn) btn.classList.add('hidden');
                        
                        return true;
                    }
                }
            } catch (error) {
                console.error('❌ خطأ في تسجيل السائق:', error);
                showNotification('⚠️ تعذر تفعيل الإشعارات', 'error');
            }
            return false;
        }
        
        // --- دوال الصوت ---
        function toggleAppSound() {
            if (soundManager) {
                const enabled = soundManager.toggle();
                updateSoundButton();
                
                const slider = document.getElementById('volume-slider');
                if (enabled) {
                    slider.style.display = 'block';
                    setTimeout(() => slider.style.display = 'none', 3000);
                } else {
                    slider.style.display = 'none';
                }
            }
        }
        
        function updateSoundButton() {
            if (!soundManager) return;
            
            const icon = document.getElementById('sound-icon');
            const enabled = soundManager.enabled;
            
            icon.name = enabled ? 'volume-high' : 'volume-mute';
            document.getElementById('sound-toggle').style.background = 
                enabled ? '#4f46e5' : '#6b7280';
        }
        
        function changeVolume(value) {
            if (soundManager) {
                const volume = value / 100;
                soundManager.setVolume(volume);
                
                if (volume > 0 && soundManager.enabled) {
                    soundManager.play('notification', { volume: volume * 0.5 });
                }
            }
        }
        
        // ============================================
        //  الوظائف المعدلة - النظام الجديد
        // ============================================
        
        // --- Customer Functions ---
        async function loginCustomer() {
            const phone = document.getElementById('customer-phone').value.trim();
            const password = document.getElementById('customer-password').value;
            
            if (!phone || !password) {
                showNotification('الرجاء إدخال رقم الواتساب وكلمة المرور', 'error');
                return;
            }
            
            if (!isValidSudanesePhone(phone)) {
                showNotification('الرجاء إدخال رقم واتساب سوداني صحيح', 'error');
                return;
            }
            
            const loginBtn = document.querySelector('#customerLoginForm button');
            const originalText = loginBtn.innerHTML;
            loginBtn.innerHTML = '<span class="loading"></span> جاري تسجيل الدخول...';
            loginBtn.disabled = true;
            
            try {
                const { data: customer, error } = await tarhalDB
                    .from('customers')
                    .select('*')
                    .eq('phone', phone)
                    .single();
                
                if (error) {
                    showNotification('رقم الواتساب غير مسجل', 'error');
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                    return;
                }
                
                if (customer.password !== password) {
                    showNotification('كلمة المرور غير صحيحة', 'error');
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                    return;
                }
                
                if (!customer.is_verified) {
                    showNotification('حسابك غير مفعل. يرجى تفعيل الحساب عبر واتساب الإدارة', 'warning');
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                    
                    setTimeout(() => {
                        if (confirm('هل تريد إعادة إرسال رسالة التفعيل إلى واتساب الإدارة؟')) {
                            sendVerificationWhatsApp(customer.phone);
                        }
                    }, 2000);
                    return;
                }
                
                currentUser = customer;
                localStorage.setItem('tarhal_customer', JSON.stringify(customer));
                
                showNotification('تم تسجيل الدخول بنجاح!', 'success');
                showScreen('home-screen');
                updateUserProfile();
                
            } catch (error) {
                console.error('Login error:', error);
                showNotification('حدث خطأ أثناء تسجيل الدخول', 'error');
            } finally {
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
            }
        }
        
        async function registerCustomer() {
            const fullname = document.getElementById('register-fullname').value.trim();
            const phone = document.getElementById('register-phone').value.trim();
            const phone2 = document.getElementById('register-phone2').value.trim();
            const password = document.getElementById('register-password').value;
            
            if (!fullname || !phone || !password) {
                showNotification('الرجاء ملء جميع الحقول المطلوبة', 'error');
                return;
            }
            
            if (!isValidSudanesePhone(phone)) {
                showNotification('الرجاء إدخال رقم واتساب سوداني صحيح', 'error');
                return;
            }
            
            const registerBtn = document.querySelector('#customerRegisterForm button');
            const originalText = registerBtn.innerHTML;
            registerBtn.innerHTML = '<span class="loading"></span> جاري التسجيل...';
            registerBtn.disabled = true;
            
            try {
                const { data: existingCustomer, error: checkError } = await tarhalDB
                    .from('customers')
                    .select('id')
                    .eq('phone', phone)
                    .single();
                
                if (existingCustomer) {
                    showNotification('رقم الواتساب مسجل بالفعل', 'error');
                    registerBtn.innerHTML = originalText;
                    registerBtn.disabled = false;
                    return;
                }
                
                const { data: newCustomer, error } = await tarhalDB
                    .from('customers')
                    .insert([{
                        full_name: fullname,
                        phone: phone,
                        phone2: phone2 || null,
                        password: password,
                        is_verified: false,
                        created_at: new Date().toISOString()
                    }])
                    .select()
                    .single();
                
                if (error) throw error;
                
                registeredPhone = phone;
                
                document.getElementById('verification-section').classList.remove('hidden');
                document.getElementById('customerRegisterForm').style.opacity = '0.5';
                registerBtn.disabled = true;
                
                // إضافة سجل للنشاط
                try {
                    await tarhalDB
                        .from('activity_logs')
                        .insert({
                            user_type: 'customer',
                            action: 'registration',
                            details: { 
                                phone: phone,
                                name: fullname 
                            }
                        });
                } catch (error) {
                    console.error('Error logging registration:', error);
                }
                
                showNotification('تم تسجيل الحساب بنجاح! قم بتأكيد الحساب عبر واتساب', 'success');
                
            } catch (error) {
                console.error('Registration error:', error);
                showNotification('حدث خطأ أثناء التسجيل: ' + error.message, 'error');
                registerBtn.innerHTML = originalText;
                registerBtn.disabled = false;
            }
        }
        
        function sendVerificationWhatsApp(phone = null) {
            const phoneToVerify = phone || registeredPhone;
            if (!phoneToVerify) return;
            
            const adminNumber = "249918183521";
            const message = "تفعيل ترحال زونا";
            const whatsappUrl = `https://wa.me/${adminNumber}?text=${encodeURIComponent(message)}`;
            
            window.open(whatsappUrl, '_blank');
            showNotification('تم فتح واتساب. أرسل الرسالة لتأكيد حسابك', 'info');
        }
        
        function updateUserProfile() {
            if (!currentUser) return;
            
            document.getElementById('user-avatar').textContent = currentUser.full_name.charAt(0);
            document.getElementById('user-name').textContent = currentUser.full_name;
            document.getElementById('user-phone-display').textContent = currentUser.phone;
            
            if (currentUser.is_verified) {
                document.getElementById('verification-status').classList.remove('hidden');
            }
        }
        
        // --- Driver Functions ---
        async function loginDriver() {
            const phone = document.getElementById('driver-phone').value.trim();
            const password = document.getElementById('driver-password').value;
            
            if (!phone || !password) {
                showNotification('الرجاء إدخال رقم الواتساب وكلمة المرور', 'error');
                return;
            }
            
            const loginBtn = document.querySelector('#driverLoginForm button');
            const originalText = loginBtn.innerHTML;
            loginBtn.innerHTML = '<span class="loading"></span> جاري تسجيل الدخول...';
            loginBtn.disabled = true;
            
            try {
                const { data: driver, error } = await tarhalDB
                    .from('drivers')
                    .select('*')
                    .eq('whatsapp_number', phone)
                    .eq('is_active', true)
                    .single();
                
                if (error) {
                    showNotification('رقم الواتساب غير مسجل أو الحساب غير مفعل', 'error');
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                    return;
                }
                
                if (driver.password !== password) {
                    showNotification('كلمة المرور غير صحيحة', 'error');
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                    return;
                }
                
                currentDriver = driver;
                localStorage.setItem('tarhal_driver', JSON.stringify(driver));
                
                showNotification('مرحباً بعودتك أيها السائق!', 'success');
                showScreen('driver-dashboard-screen');
                updateDriverDashboard();
                updateDriverUI();
                
            } catch (error) {
                console.error('Driver login error:', error);
                showNotification('حدث خطأ أثناء تسجيل الدخول', 'error');
            } finally {
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
            }
        }
        
        function contactAdminForDriverRegistration() {
            const adminNumber = "249918183521";
            const message = "مرحباً، أريد التسجيل كسائق في تطبيق ترحال السودان";
            const whatsappUrl = `https://wa.me/${adminNumber}?text=${encodeURIComponent(message)}`;
            
            window.open(whatsappUrl, '_blank');
            showNotification('تم فتح واتساب الإدارة', 'info');
        }
        
        async function updateDriverDashboard() {
            if (!currentDriver) return;
            
            document.getElementById('driver-avatar').textContent = currentDriver.full_name.charAt(0);
            document.getElementById('driver-name').textContent = currentDriver.full_name;
            document.getElementById('driver-car-info').textContent = 
                `${currentDriver.car_model || 'سيارة'} - ${getVehicleTypeName(currentDriver.car_type)}`;
            
            document.getElementById('driver-balance').textContent = 
                (currentDriver.balance || 0).toLocaleString();
            
            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const { data: rides, error } = await tarhalDB
                    .from('rides')
                    .select('*')
                    .eq('driver_id', currentDriver.id)
                    .gte('created_at', today.toISOString())
                    .eq('status', 'completed');
                
                if (!error && rides) {
                    const todayEarnings = rides.reduce((sum, ride) => sum + (ride.driver_earnings || 0), 0);
                    document.getElementById('today-trips').textContent = rides.length;
                    document.getElementById('today-earnings').textContent = todayEarnings.toLocaleString();
                }
                
                const { data: totalRides, error: totalError } = await tarhalDB
                    .from('rides')
                    .select('id')
                    .eq('driver_id', currentDriver.id)
                    .eq('status', 'completed');
                
                if (!totalError && totalRides) {
                    document.getElementById('total-trips').textContent = totalRides.length;
                }
                
            } catch (error) {
                console.error('Error fetching driver stats:', error);
            }
        }
        
        // ============================================
        //  الوظيفة المحسنة toggleDriverStatus
        // ============================================
        async function toggleDriverStatus() {
            const wasOnline = isDriverOnline;
            isDriverOnline = !isDriverOnline;
            
            // تحديث الواجهة
            const statusIndicator = document.getElementById('driver-status-indicator');
            const statusText = document.getElementById('driver-status-text');
            const toggleBtn = document.getElementById('toggle-online-btn');
            
            if (isDriverOnline) {
                statusIndicator.className = 'status-indicator status-online';
                statusText.textContent = 'متصل وجاهز';
                toggleBtn.innerHTML = '<ion-icon name="power-outline"></ion-icon> إيقاف وضع العمل';
                toggleBtn.classList.add('btn-danger');
                toggleBtn.classList.remove('btn-driver');
                
                // بدء تتبع الموقع
                startDriverTracking();
                
                // تسجيل حالة الاتصال
                await updateDriverOnlineStatus(true);
                
                showNotification('أنت الآن متصل وجاهز لاستقبال الطلبات', 'success');
                
                // تفعيل الإشعارات تلقائياً
                setupDriverNotifications();
                
            } else {
                statusIndicator.className = 'status-indicator status-offline';
                statusText.textContent = 'غير متصل';
                toggleBtn.innerHTML = '<ion-icon name="power-outline"></ion-icon> تفعيل وضع العمل';
                toggleBtn.classList.remove('btn-danger');
                toggleBtn.classList.add('btn-driver');
                
                // إيقاف تتبع الموقع
                stopDriverTracking();
                
                // تسجيل حالة الانقطاع
                await updateDriverOnlineStatus(false);
                
                showNotification('تم إيقاف وضع العمل', 'info');
            }
        }
        
        async function updateDriverOnlineStatus(isOnline) {
            if (!currentDriver) return;
            
            try {
                // الحصول على الموقع الحالي
                const position = await getCurrentPosition();
                
                // تحديث أو إنشاء سجل الموقع
                await tarhalDB
            .from('driver_locations')
            .upsert({
                driver_id: currentDriver.id,
                lat: position.coords.latitude, // تأكد من تحويله لرقم
                lng: position.coords.longitude,
                is_online: isOnline,
                last_seen: new Date().toISOString(),
                updated_at: new Date().toISOString()
            }, { 
                onConflict: 'driver_id',
                ignoreDuplicates: false 
            });
                
                // إذا كان متصلاً، تفعيل تحديث الموقع الدوري
                if (isOnline) {
                    startLocationUpdates();
                }
                
            } catch (error) {
                console.error('Error updating driver status:', error);
                
                // محاولة بدون موقع
                await tarhalDB
                    .from('driver_locations')
                    .upsert({
                        driver_id: currentDriver.id,
                        is_online: isOnline,
                        last_seen: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    }, { 
                        onConflict: 'driver_id',
                        ignoreDuplicates: false 
                    });
            }
        }
        
        function startLocationUpdates() {
            if (locationUpdateInterval) {
                clearInterval(locationUpdateInterval);
            }
            
            locationUpdateInterval = setInterval(async () => {
                if (!currentDriver || !isDriverOnline) {
                    clearInterval(locationUpdateInterval);
                    return;
                }
                
                try {
                    const position = await getCurrentPosition();
                    
                    await tarhalDB
                        .from('driver_locations')
                        .update({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            last_seen: new Date().toISOString()
                        })
                        .eq('driver_id', currentDriver.id);
                        
                } catch (error) {
                    console.error('Location update error:', error);
                    
                    // تحديث الوقت فقط
                    await tarhalDB
                        .from('driver_locations')
                        .update({
                            last_seen: new Date().toISOString()
                        })
                        .eq('driver_id', currentDriver.id);
                }
            }, 30000); // تحديث كل 30 ثانية
        }
        
        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    resolve,
                    reject,
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }
        
        function startDriverTracking() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    try {
                        await tarhalDB
                            .from('driver_locations')
                            .upsert({
                                driver_id: currentDriver.id,
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                car_type: currentDriver.car_type,
                                last_seen: new Date().toISOString()
                            }, { onConflict: 'driver_id' });
                        
                        showNotification('بدأ تتبع موقعك...', 'success');
                    } catch (error) {
                        console.error('Tracking error:', error);
                    }
                }, (error) => {
                    showNotification('خطأ في الوصول للموقع الجغرافي', 'error');
                });
            }
        }
        
        function stopDriverTracking() {
            console.log('Driver tracking stopped');
            if (locationUpdateInterval) {
                clearInterval(locationUpdateInterval);
                locationUpdateInterval = null;
            }
        }
        
        // ============================================
        //  نظام البحث الجديد - الرحلة
        // ============================================
        function requestRide() {
            if (!currentUser || !currentUser.is_verified) {
                showNotification('يجب تفعيل حسابك أولاً لطلب رحلة', 'error');
                return;
            }
            
            showScreen('ride-request-screen');
            
            // إعادة تعيين المتغيرات
            selectedVehicleType = null;
            destinationPosition = null;
            routeCalculated = false;
            locationMode = 'auto';
            manualModeActive = false;
            manualClickCount = 0;
            
            // إعادة تعيين الواجهة
            document.querySelectorAll('.vehicle-option').forEach(option => {
                option.classList.remove('selected');
                option.style.borderColor = 'var(--gray-light)';
                option.style.background = 'white';
                option.style.boxShadow = 'none';
            });
            document.getElementById('price-calculation').classList.add('hidden');
            document.getElementById('confirm-ride-btn').disabled = true;
            document.getElementById('route-details-section').classList.add('hidden');
            document.getElementById('destination-clear-btn').classList.add('hidden');
            
            // تفعيل الوضع التلقائي افتراضياً
            const autoBtn = document.getElementById('auto-mode-btn');
            const manualBtn = document.getElementById('manual-mode-btn');
            
            autoBtn.classList.add('active');
            autoBtn.style.background = '#4f46e5';
            autoBtn.style.color = 'white';
            
            manualBtn.classList.remove('active');
            manualBtn.style.background = '#f1f5f9';
            manualBtn.style.color = '#64748b';
            
            // تهيئة الخريطة بعد تأخير بسيط
            setTimeout(() => {
                initRideMap();
            }, 100);
        }
        
        function initRideMap() {
            // تنظيف الخريطة السابقة
            if (rideMap) {
                rideMap.remove();
                rideMap = null;
            }
            
            startMarker = null;
            endMarker = null;
            routePolyline = null;
            currentRoute = null;
            
            // إنشاء الخريطة الجديدة
            rideMap = L.map('ride-map', {
                zoomControl: false,
                tap: true
            }).setView([15.5007, 32.5599], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(rideMap);
            
            // تعيين الوضع الافتراضي (تلقائي)
            locationMode = 'auto';
            manualModeActive = false;
            manualClickCount = 0;
            
            // تفعيل الوضع التلقائي أولاً
            initAutoLocationMode();
            
            // حل مشكلة ظهور المربعات الرمادية
            setTimeout(() => {
                if (rideMap) {
                    rideMap.invalidateSize();
                }
            }, 400);
        }
        
        // --- Location Mode Functions ---
        function setLocationMode(mode) {
            locationMode = mode;
            
            const autoBtn = document.getElementById('auto-mode-btn');
            const manualBtn = document.getElementById('manual-mode-btn');
            
            if (mode === 'auto') {
                autoBtn.classList.add('active');
                autoBtn.style.background = '#4f46e5';
                autoBtn.style.color = 'white';
                
                manualBtn.classList.remove('active');
                manualBtn.style.background = '#f1f5f9';
                manualBtn.style.color = '#64748b';
                
                manualModeActive = false;
                manualClickCount = 0;
                
                // إيقاف النبض إذا كان نشطاً
                if (pulseInterval) {
                    clearInterval(pulseInterval);
                    pulseInterval = null;
                }
                
                if (pulsingMarker) {
                    rideMap.removeLayer(pulsingMarker);
                    pulsingMarker = null;
                }
                
                // تفعيل الوضع التلقائي
                initAutoLocationMode();
                showNotification('تم تفعيل الوضع التلقائي', 'info');
                
            } else {
                autoBtn.classList.remove('active');
                autoBtn.style.background = '#f1f5f9';
                autoBtn.style.color = '#64748b';
                
                manualBtn.classList.add('active');
                manualBtn.style.background = '#4f46e5';
                manualBtn.style.color = 'white';
                
                manualModeActive = true;
                manualClickCount = 0;
                
                // تفعيل الوضع اليدوي
                initManualLocationMode();
                showNotification('تم تفعيل الوضع اليدوي. اضغط على الخريطة لتحديد النقطة A', 'info');
            }
        }
        
        function initAutoLocationMode() {
            // إعادة تعيين وضع التلقائي
            if (rideMap) {
                rideMap.off('click');
                
                // تفعيل النقر على الخريطة لتحديد الوجهة فقط (النقطة B)
                rideMap.on('click', async (e) => {
                    if (!userPosition) {
                        showNotification('الرجاء تحديد النقطة A أولاً', 'warning');
                        return;
                    }
                    await setDestination(e.latlng.lat, e.latlng.lng);
                });
            }
            
            // محاولة الحصول على الموقع تلقائياً
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    userPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    if (rideMap) {
                        rideMap.flyTo([userPosition.lat, userPosition.lng], 16);
                        
                        // إضافة علامة نقطة البداية (A)
                        if (startMarker) {
                            startMarker.setLatLng([userPosition.lat, userPosition.lng]);
                        } else {
                            startMarker = L.marker([userPosition.lat, userPosition.lng], {
                                icon: L.divIcon({
                                    html: '<div class="start-marker">A</div>',
                                    className: 'start-marker-div',
                                    iconSize: [32, 32],
                                    iconAnchor: [16, 16]
                                })
                            }).addTo(rideMap).bindPopup("نقطة البداية").openPopup();
                        }
                        
                        showNotification('✓ تم تحديد موقعك الحالي تلقائياً. الآن حدد نقطة الوصول B', 'success');
                    }
                }, (err) => {
                    showNotification("يرجى تفعيل الـ GPS أو استخدام الوضع اليدوي", "warning");
                });
            }
        }
        
        function initManualLocationMode() {
            if (!rideMap) return;
            
            // إيقاف أي أحداث سابقة
            rideMap.off('click');
            
            // إعادة تعيين العداد
            manualClickCount = 0;
            
            // إزالة أي علامات سابقة
            if (startMarker) {
                rideMap.removeLayer(startMarker);
                startMarker = null;
            }
            
            if (endMarker) {
                rideMap.removeLayer(endMarker);
                endMarker = null;
            }
            
            if (pulsingMarker) {
                rideMap.removeLayer(pulsingMarker);
                pulsingMarker = null;
            }
            
            // عرض إشعار للتعليمات
            showNotification('الوضع اليدوي: اضغط على الخريطة لتحديد النقطة A (مكان الانطلاق)', 'info');
            
            // تفعيل النقر على الخريطة للوضع اليدوي
            rideMap.on('click', handleManualMapClick);
        }
        
        function handleManualMapClick(e) {
            if (!manualModeActive) return;
            
            manualClickCount++;
            
            if (manualClickCount === 1) {
                // النقرة الأولى: تحديد النقطة A
                setManualStartPoint(e.latlng.lat, e.latlng.lng);
                
            } else if (manualClickCount === 2) {
                // النقرة الثانية: تحديد النقطة B
                setManualDestination(e.latlng.lat, e.latlng.lng);
            }
        }
        
        function setManualStartPoint(lat, lng) {
            userPosition = { lat, lng };
            
            // إضافة علامة النقطة A مع تأثير النبض
            if (pulsingMarker) {
                rideMap.removeLayer(pulsingMarker);
            }
            
            startMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    html: '<div class="start-marker">A</div>',
                    className: 'start-marker-div',
                                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                })
            }).addTo(rideMap).bindPopup("نقطة البداية (يدوي)").openPopup();
            
            // إنشاء مؤثر النبض
            createPulsingEffect(lat, lng);
            
            // تحريك الخريطة للنقطة المحددة
            rideMap.flyTo([lat, lng], 16);
            
            // إشعار للمستخدم
            showNotification('✓ تم تحديد النقطة A يدوياً. اضغط مرة أخرى لتحديد النقطة B', 'success');
        }
        
        function createPulsingEffect(lat, lng) {
            if (pulseInterval) {
                clearInterval(pulseInterval);
            }
            
            let radius = 10;
            let maxRadius = 30;
            
            pulsingMarker = L.circleMarker([lat, lng], {
                radius: radius,
                color: '#4f46e5',
                fillColor: '#4f46e5',
                fillOpacity: 0.2,
                weight: 2
            }).addTo(rideMap);
            
            pulseInterval = setInterval(() => {
                radius += 2;
                if (radius > maxRadius) {
                    radius = 10;
                }
                
                pulsingMarker.setRadius(radius);
                pulsingMarker.setStyle({
                    fillOpacity: 0.5 - (radius / maxRadius) * 0.5
                });
            }, 200);
        }
        
        function setManualDestination(lat, lng) {
            // إيقاف تأثير النبض
            if (pulseInterval) {
                clearInterval(pulseInterval);
                pulseInterval = null;
            }
            
            if (pulsingMarker) {
                rideMap.removeLayer(pulsingMarker);
                pulsingMarker = null;
            }
            
            // تحديد النقطة B
            setDestination(lat, lng);
            
            // إعادة تعيين العداد للجولة التالية
            manualClickCount = 0;
            
            // تغيير حدث النقر ليحدد فقط النقطة B بعد ذلك
            rideMap.off('click');
            rideMap.on('click', async (e) => {
                await setDestination(e.latlng.lat, e.latlng.lng);
            });
        }
        
        async function setDestination(lat, lng) {
            destinationPosition = { lat, lng };
            
            // إظهار زر حذف الوجهة
            document.getElementById('destination-clear-btn').classList.remove('hidden');
            
            // إضافة أو تحديث علامة نقطة الوصول (B)
            if (endMarker) {
                endMarker.setLatLng([lat, lng]);
            } else {
                endMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        html: '<div class="end-marker">B</div>',
                        className: 'end-marker-div',
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    })
                }).addTo(rideMap).bindPopup('نقطة الوصول').openPopup();
            }
            
            // إذا كان هناك موقع مستخدم، حساب المسار الحقيقي مباشرة
            if (userPosition) {
                await calculateRealRouteAndDisplay();
            }
            
            if (selectedVehicleType) {
                calculateRidePrice();
            }
        }
        
        async function calculateRealRouteAndDisplay() {
            if (!userPosition || !destinationPosition) return;
            
            // عرض مؤشر التحميل
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'location-loading';
            loadingIndicator.innerHTML = `
                <div class="loading"></div>
                <div>جاري حساب المسار...</div>
            `;
            document.getElementById('ride-map').appendChild(loadingIndicator);
            
            try {
                // رابط OSRM
                const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${userPosition.lng},${userPosition.lat};${destinationPosition.lng},${destinationPosition.lat}?overview=full&geometries=geojson`;
                
                const response = await fetch(osrmUrl);
                const data = await response.json();
                
                loadingIndicator.remove();
                
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    
                    // حفظ بيانات المسار
                    currentRoute = {
                        distance: route.distance / 1000,
                        duration: route.duration / 60,
                        geometry: route.geometry
                    };
                    
                    // رسم المسار الحقيقي
                    if (route.geometry && route.geometry.coordinates.length > 1) {
                        drawRouteOnMap(route.geometry);
                    }
                    
                    routeCalculated = true;
                    
                    // عرض تفاصيل المسار تلقائياً
                    showRouteDetails();
                    
                    // تفعيل زر البحث عن سائق
                    document.getElementById('confirm-ride-btn').disabled = false;
                    
                    showNotification(`✓ تم حساب المسار: ${currentRoute.distance.toFixed(1)} كم`, 'success');
                    
                    return currentRoute;
                }
            } catch (error) {
                loadingIndicator.remove();
                console.error('خطأ في حساب المسار:', error);
                showNotification('⚠️ تعذر حساب المسار الدقيق', 'warning');
            }
        }
        
        function drawRouteOnMap(geometry) {
            if (!geometry || !geometry.coordinates || geometry.coordinates.length < 2) return;
            
            if (routePolyline) rideMap.removeLayer(routePolyline);
            
            const coords = geometry.coordinates.map(c => [c[1], c[0]]);
            routePolyline = L.polyline(coords, {
                color: '#4f46e5',
                weight: 5,
                opacity: 0.8,
                lineCap: 'round',
                dashArray: '10, 10',
                className: 'animated-route'
            }).addTo(rideMap);
            
            // تكبير العرض ليشمل المسار كاملاً
            const bounds = L.latLngBounds(coords);
            if (startMarker) bounds.extend(startMarker.getLatLng());
            if (endMarker) bounds.extend(endMarker.getLatLng());
            rideMap.fitBounds(bounds, { padding: [50, 50] });
        }
        
        function showRouteDetails() {
            if (!currentRoute) return;
            
            const duration = Math.round(currentRoute.duration);
            const distance = currentRoute.distance;
            const avgSpeed = Math.round((distance / currentRoute.duration) * 60);
            
            // تحديث مدة الرحلة
            document.getElementById('route-duration').textContent = duration;
            
            // إنشاء محتوى تفاصيل المسار
            const routeInfoContent = `
                <div class="route-detail-item">
                    <span class="route-detail-label">المسافة الإجمالية:</span>
                    <span class="route-detail-value">${distance.toFixed(1)} كم</span>
                </div>
                <div class="route-detail-item">
                    <span class="route-detail-label">الوقت المتوقع:</span>
                    <span class="route-detail-value">${duration} دقيقة</span>
                </div>
                <div class="route-detail-item">
                    <span class="route-detail-label">متوسط السرعة:</span>
                    <span class="route-detail-value">${avgSpeed} كم/ساعة</span>
                </div>
                <div class="route-detail-item">
                    <span class="route-detail-label">نوع المسار:</span>
                    <span class="route-detail-value">${distance > 10 ? 'طويل' : 'قصير'}</span>
                </div>
            `;
            
            document.getElementById('route-info-content').innerHTML = routeInfoContent;
            document.getElementById('route-details-section').classList.remove('hidden');
        }
        
        function clearDestination() {
            if (endMarker) {
                rideMap.removeLayer(endMarker);
                endMarker = null;
            }
            
            if (routePolyline) {
                rideMap.removeLayer(routePolyline);
                routePolyline = null;
            }
            
            destinationPosition = null;
            currentRoute = null;
            routeCalculated = false;
            
            document.getElementById('destination-clear-btn').classList.add('hidden');
            document.getElementById('route-details-section').classList.add('hidden');
            document.getElementById('price-calculation').classList.add('hidden');
            document.getElementById('confirm-ride-btn').disabled = true;
            
            showNotification('تم حذف الوجهة', 'info');
        }
        
        function selectVehicle(type) {
            selectedVehicleType = type;
            
            // إزالة التظليل من جميع المربعات
            document.querySelectorAll('.vehicle-option').forEach(option => {
                option.classList.remove('selected');
                option.style.borderColor = 'var(--gray-light)';
                option.style.background = 'white';
                option.style.boxShadow = 'none';
            });
            
            // تظليل المربع المختار
            const selectedOption = document.querySelector(`.vehicle-option[data-type="${type}"]`);
            selectedOption.classList.add('selected');
            selectedOption.style.borderColor = '#4f46e5';
            selectedOption.style.background = '#eef2ff';
            selectedOption.style.boxShadow = '0 4px 12px rgba(79, 70, 229, 0.15)';
            
            if (destinationPosition && currentRoute) {
                calculateRidePrice();
            }
        }
        
        function calculateRidePrice() {
            if (!userPosition || !destinationPosition || !selectedVehicleType || !currentRoute) return;
            
            const distance = currentRoute.distance;
            const vehicle = VEHICLE_PRICES[selectedVehicleType];
            const additionalKm = Math.max(0, distance - 1);
            const basePrice = vehicle.base;
            const extraPrice = additionalKm * vehicle.perKm;
            const totalPrice = basePrice + extraPrice;
            
            // عرض تفاصيل السعر بالأرقام الإنجليزية
            document.getElementById('price-calculation').classList.remove('hidden');
            document.getElementById('distance-display').textContent = `${distance.toFixed(1)} km`;
            document.getElementById('base-price-display').textContent = `${basePrice.toLocaleString('en-US')} SDG`;
            document.getElementById('extra-price-display').textContent = `${Math.round(extraPrice).toLocaleString('en-US')} SDG`;
            document.getElementById('total-price-display').textContent = `${Math.round(totalPrice).toLocaleString('en-US')} SDG`;
        }
        
        function formatPrice(amount) {
            // تقريب السعر وإزالة الكسور
            const roundedAmount = Math.round(amount);
            
            // تنسيق الرقم بفواصل الآلاف
            return `${roundedAmount.toLocaleString('en-US')} SDG`;
        }
        
        // ============================================
        //  الوظيفة المعدلة confirmRide
        // ============================================
        async function confirmRide() {
            if (!selectedVehicleType || !destinationPosition) {
                showNotification('الرجاء تحديد الوجهة واختيار نوع المركبة', 'warning');
                return;
            }
            
            if (!currentUser || !currentUser.is_verified) {
                showNotification('يجب تفعيل حسابك أولاً لطلب رحلة', 'error');
                return;
            }
            
            const confirmBtn = document.getElementById('confirm-ride-btn');
            const originalText = confirmBtn.innerHTML;
            confirmBtn.innerHTML = '<span class="loading"></span> جاري البحث عن سائق...';
            confirmBtn.disabled = true;
            
            try {
                // حساب المسافة والسعر
                const distance = currentRoute ? currentRoute.distance : 0;
                const vehicle = VEHICLE_PRICES[selectedVehicleType];
                const additionalKm = Math.max(0, distance - 1);
                const totalPrice = vehicle.base + (additionalKm * vehicle.perKm);
                
                // 1. إدخال طلب الرحلة
                const { data: ride, error: rideError } = await tarhalDB
                    .from('rides')
                    .insert([{
                        customer_id: currentUser.id,
                        customer_name: currentUser.full_name,
                        customer_phone: currentUser.phone,
                        customer_phone2: currentUser.phone2,
                        pickup_lat: userPosition.lat,
                        pickup_lng: userPosition.lng,
                        destination_lat: destinationPosition.lat,
                        destination_lng: destinationPosition.lng,
                        distance_km: parseFloat(distance.toFixed(1)),
                        vehicle_type: selectedVehicleType,
                        amount: totalPrice,
                        status: 'searching',
                        search_started_at: new Date().toISOString(),
                        created_at: new Date().toISOString()
                    }])
                    .select()
                    .single();
                
                if (rideError) throw rideError;
                
                currentRideId = ride.id;
                
                // 2. بدء البحث الفعلي عن السائقين
                startDriverSearch(ride);
                
                // 3. تحديث واجهة المستخدم
                showNotification(' جاري البحث عن سائقين قريبين...', 'info');
                
                // 4. إظهار لوحة البحث
                showSearchPanel(ride);
                
            } catch (error) {
                console.error('Ride request error:', error);
                showNotification('حدث خطأ في طلب الرحلة: ' + error.message, 'error');
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
            }
        }
        
        // ============================================
        //  نظام البحث الجديد عن السائقين
        // ============================================
        async function startDriverSearch(ride) {
            let searchRadius = 5; // بدء البحث من 5 كم
            let foundDriver = null;
            
            // إيقاف أي بحث سابق
            if (rideSearchInterval) {
                clearInterval(rideSearchInterval);
            }
            
            // تحديث حالة الرحلة
            await tarhalDB
            .from('rides')
            .update({ 
                status: 'searching',
                updated_at: new Date().toISOString()
            })
            .eq('id', ride.id);
    }
} catch (patchError) {
    console.error('❌ فشل تحديث الرحلة:', patchError);
}
            
            // بدء عملية البحث
            rideSearchInterval = setInterval(async () => {
                try {
                    // البحث عن السائقين في النطاق الحالي
                    const drivers = await findAvailableDrivers(
                parseFloat(ride.pickup_lat),
                parseFloat(ride.pickup_lng),
                ride.vehicle_type,
                searchRadius
            );
            
            availableDrivers = drivers;
                    
                    // تحديث واجهة البحث
                    updateSearchPanel(availableDrivers.length, searchRadius);
                    
                    if (drivers.length > 0) {
                        // وجدنا سائقين! إرسال طلبات لهم
                        foundDriver = await sendRideRequestsToDrivers(ride, drivers);
                        
                        if (foundDriver) {
                            // نجحنا في إيجاد سائق يقبل الرحلة
                            clearInterval(rideSearchInterval);
                            await handleDriverFound(ride, foundDriver);
                            return;
                        }
                    }
                    
                    // زيادة نطاق البحث إذا لم نجد
                    if (searchRadius < MAX_SEARCH_RADIUS) {
                        searchRadius += SEARCH_STEP;
                        
                        // تحديث نطاق البحث في قاعدة البيانات
                        await tarhalDB
                            .from('rides')
                            .update({ 
                                search_radius: searchRadius,
                                last_search_at: new Date().toISOString()
                            })
                            .eq('id', ride.id);
                    } else {
                        // وصلنا لأقصى نطاق بدون إيجاد سائق
                        clearInterval(rideSearchInterval);
                        await handleNoDriversFound(ride);
                    }
                    
                } catch (error) {
                    console.error('Search error:', error);
                }
            }, 3000); // بحث كل 3 ثواني
        }
        
        // ============================================
        //  البحث عن السائقين المتاحين
        // ============================================
        async function findAvailableDrivers(pickupLat, pickupLng, vehicleType, radiusKm = 20) {
    try {
        console.log(` البحث عن سائقين ${vehicleType} في نطاق ${radiusKm} كم`);
        
        try {
            // استخدام الدالة RPC مع معالجة الأخطاء
            const { data, error } = await tarhalDB.rpc('find_nearby_drivers', {
                p_lat: parseFloat(pickupLat),
                p_lng: parseFloat(pickupLng),
                p_radius_km: parseFloat(radiusKm),
                p_vehicle_type: vehicleType,
                p_limit: 10
            });
            
            if (error) {
                console.log('⚠️ خطأ في دالة RPC:', error.message);
                throw error;
            }
            
            if (data && data.length > 0) {
                console.log(`✅ وجد ${data.length} سائق عبر RPC`);
                
                // تحويل البيانات لتتناسب مع التطبيق
                return data.map(driver => ({
                    driver_id: driver.driver_id,
                    lat: parseFloat(driver.lat),
                    lng: parseFloat(driver.lng),
                    car_type: driver.car_type,
                    is_online: driver.is_online,
                    distance_km: parseFloat(driver.distance_km),
                    drivers: {
                        id: driver.driver_id,
                        full_name: driver.driver_name,
                        whatsapp_number: driver.driver_phone,
                        car_model: driver.car_model,
                        rating: parseFloat(driver.rating),
                        total_rides: parseInt(driver.total_rides),
                        is_active: true
                    }
                }));
            } else {
                console.log('⚠️ لا توجد نتائج من دالة RPC');
                return [];
            }
            
        } catch (rpcError) {
            console.log('⚠️ فشل الاتصال بدالة RPC:', rpcError.message);
            
            // استخدام البديل اليدوي
            return await findDriversManually(pickupLat, pickupLng, vehicleType, radiusKm);
        }
        
    } catch (error) {
        console.error('❌ خطأ في البحث عن السائقين:', error);
        return [];
    }
}
        
        // ============================================
//  دالة حساب المسافة (نفسها ولكن تأكد من وجودها)
// ============================================
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // نصف قطر الأرض بالكيلومتر
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function toRad(value) {
    return value * Math.PI / 180;
}

// ============================================
//  البحث اليدوي البديل (دالة جديدة تماماً)
// ============================================
async function findDriversManually(pickupLat, pickupLng, vehicleType, radiusKm) {
    try {
        // جلب جميع السائقين النشطين من النوع المطلوب
        const { data: drivers, error: driversError } = await tarhalDB
            .from('drivers')
            .select('*')
            .eq('is_active', true)
            .eq('car_type', vehicleType);
            
        if (driversError) {
            console.error('خطأ في جلب السائقين:', driversError);
            return [];
        }
        
        if (!drivers || drivers.length === 0) {
            console.log('⚠️ لا يوجد سائقين من النوع المطلوب');
            return [];
        }
        
        const driverIds = drivers.map(d => d.id);
        
        // جلب مواقع السائقين
        const { data: locations, error: locError } = await tarhalDB
            .from('driver_locations')
            .select('*')
            .in('driver_id', driverIds)
            .eq('is_online', true);
            
        if (locError) {
            console.error('خطأ في جلب المواقع:', locError);
            return [];
        }
        
        if (!locations || locations.length === 0) {
            console.log('⚠️ لا يوجد سائقين متصلين');
            return [];
        }
        
        // حساب المسافات وتصفية النتائج
        const nearbyDrivers = locations.filter(loc => {
            if (!loc.lat || !loc.lng) return false;
            
            const distance = calculateDistance(
                parseFloat(pickupLat),
                parseFloat(pickupLng),
                parseFloat(loc.lat),
                parseFloat(loc.lng)
            );
            
            return distance <= radiusKm;
        });
        
        console.log(`✅ وجد ${nearbyDrivers.length} سائق قريب`);
        
        // دمج البيانات
        const result = nearbyDrivers.map(loc => {
            const driver = drivers.find(d => d.id === loc.driver_id);
            const distance = calculateDistance(
                parseFloat(pickupLat),
                parseFloat(pickupLng),
                parseFloat(loc.lat),
                parseFloat(loc.lng)
            );
            
            return {
                driver_id: loc.driver_id,
                lat: parseFloat(loc.lat),
                lng: parseFloat(loc.lng),
                car_type: loc.car_type,
                is_online: loc.is_online,
                distance_km: distance,
                drivers: driver ? {
                    id: driver.id,
                    full_name: driver.full_name,
                    whatsapp_number: driver.whatsapp_number,
                    car_model: driver.car_model || '',
                    rating: parseFloat(driver.rating || 5.0),
                    total_rides: parseInt(driver.total_rides || 0),
                    is_active: driver.is_active
                } : null
            };
        }).filter(item => item.drivers !== null);
        
        // ترتيب حسب المسافة
        result.sort((a, b) => a.distance_km - b.distance_km);
        
        return result.slice(0, 10); // إرجاع أول 10 نتائج فقط
        
    } catch (error) {
        console.error('❌ خطأ في البحث اليدوي:', error);
        return [];
    }
}
        
        // ============================================
//  إرسال طلبات الرحلة للسائقين - النسخة المصححة
// ============================================
async function sendRideRequestsToDrivers(ride, drivers) {
    console.log(`📨 إرسال طلبات إلى ${drivers.length} سائق`);
    
    let acceptedDriver = null;
    
    // تحقق أولاً من السائقين الذين لديهم طلبات حالية
    const checkedDrivers = await Promise.all(
        drivers.map(async (driver) => {
            try {
                const driverId = driver.driver_id || driver.id;
                
                // التحقق إذا كان هناك طلب نشط بالفعل
                const { data: existingRequest, error } = await tarhalDB
                    .from('ride_requests')
                    .select('id, status')
                    .eq('ride_id', ride.id)
                    .eq('driver_id', driverId)
                    .maybeSingle();
                
                if (existingRequest) {
                    console.log(`⚠️ طلب موجود للسائق ${driverId}: ${existingRequest.status}`);
                    
                    // إذا كان الطلب مقبولاً بالفعل
                    if (existingRequest.status === 'accepted') {
                        console.log(`✅ السائق ${driverId} قبل الرحلة مسبقاً`);
                        return { driver, hasExistingRequest: true, status: 'accepted' };
                    }
                    
                    // إذا كان الطلب pending أو expired
                    return { driver, hasExistingRequest: true, status: existingRequest.status };
                }
                
                return { driver, hasExistingRequest: false };
                
            } catch (error) {
                console.error(`❌ خطأ في التحقق من السائق ${driver.driver_id}:`, error);
                return { driver, hasExistingRequest: false, error: error.message };
            }
        })
    );
    
    // تصفية السائقين الذين ليس لديهم طلبات حالية
    const newDrivers = checkedDrivers
        .filter(item => !item.hasExistingRequest || item.status === 'expired')
        .map(item => item.driver);
    
    console.log(`🎯 ${newDrivers.length} سائق جديد من ${drivers.length} إجمالي`);
    
    if (newDrivers.length === 0) {
        console.log('ℹ️ جميع السائقين لديهم طلبات حالية');
        return null;
    }
    
    // إرسال طلبات للسائقين الجدد فقط
    const requestPromises = newDrivers.map(async (driver) => {
        try {
            const driverId = driver.driver_id || driver.id;
            
            console.log(`📝 إنشاء طلب جديد للسائق ${driverId}`);
            
            // إنشاء طلب جديد مع try-catch
            let rideRequest;
            try {
                const { data, error } = await tarhalDB
                    .from('ride_requests')
                    .insert({
                        ride_id: ride.id,
                        driver_id: driverId,
                        status: 'pending',
                        expires_at: new Date(Date.now() + 40000).toISOString(),
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .select()
                    .single();
                
                if (error) {
                    // إذا كان duplicate key، تخطى هذا السائق
                    if (error.code === '23505') {
                        console.log(`ℹ️ تجاهل duplicate للسائق ${driverId}`);
                        return null;
                    }
                    throw error;
                }
                
                rideRequest = data;
                console.log(`✅ طلب جديد أنشئ للسائق ${driverId}: ${rideRequest.id}`);
                
            } catch (insertError) {
                console.error(`❌ فشل إنشاء طلب للسائق ${driverId}:`, insertError.message);
                return null;
            }
            
            // إرسال الإشعار
            const notificationResult = await sendDriverNotification(driver, ride, rideRequest.id);
            
            if (!notificationResult.success) {
                console.log(`⚠️ فشل إرسال إشعار للسائق ${driverId}:`, notificationResult.error);
            } else {
                console.log(`📲 إشعار أرسل للسائق ${driverId}`);
            }
            
            // انتظار الرد (مع timeout)
            const response = await Promise.race([
                waitForDriverResponse(rideRequest.id, 40000),
                new Promise(resolve => setTimeout(() => resolve('timeout'), 45000))
            ]);
            
            console.log(`🔄 رد السائق ${driverId}:`, response);
            
            if (response === 'accepted') {
                console.log(`🎉 السائق ${driverId} قبل الرحلة!`);
                acceptedDriver = driver;
                return driver;
            }
            
            return null;
            
        } catch (error) {
            console.error(`❌ خطأ في معالجة السائق ${driver.driver_id}:`, error);
            return null;
        }
    });
    
    // انتظار الردود مع timeout إجمالي
    const results = await Promise.race([
        Promise.allSettled(requestPromises),
        new Promise(resolve => {
            setTimeout(() => {
                console.log('⏰ انتهى وقت انتظار جميع السائقين');
                resolve([]);
            }, 60000); // 60 ثانية كحد أقصى
        })
    ]);
    
    // البحث عن أي سائق قبل
    if (Array.isArray(results)) {
        for (const result of results) {
            if (result?.status === 'fulfilled' && result.value) {
                return result.value;
            }
        }
    }
    
    return acceptedDriver;
}
        
        // ============================================
//  إرسال إشعار للسائق - النسخة المحسنة
// ============================================
async function sendDriverNotification(driver, ride, requestId) {
    try {
        console.log(`🚀 محاولة إرسال إشعار للسائق ${driver.driver_id || driver.id}`);
        
        // 1. جلب بيانات إشعارات السائق من Supabase
        const { data: notificationData, error: notificationError } = await tarhalDB
            .from('driver_notifications')
            .select('fcm_token, notification_enabled')
            .eq('driver_id', driver.driver_id || driver.id)
            .single();
        
        // إذا لم يكن هناك بيانات إشعارات أو التوكن مفقود
        if (notificationError || !notificationData) {
            console.log(`⚠️ السائق ${driver.driver_id} ليس لديه بيانات إشعارات في قاعدة البيانات`);
            return {
                success: false,
                message: 'السائق ليس لديه إشعارات مفعلة',
                driverId: driver.driver_id
            };
        }
        
        const { fcm_token, notification_enabled } = notificationData;
        
        // التحقق من وجود التوكن وتمكين الإشعارات
        if (!fcm_token || !notification_enabled) {
            console.log(`⚠️ السائق ${driver.driver_id}: لا يوجد توكن أو الإشعارات غير مفعلة`);
            return {
                success: false,
                message: 'توكن الإشعارات مفقود أو غير مفعل',
                driverId: driver.driver_id
            };
        }
        
        // التحقق من صحة التوكن (يجب أن يكون نصاً طويلاً)
        if (typeof fcm_token !== 'string' || fcm_token.length < 100) {
            console.error(`❌ توكن غير صالح للسائق ${driver.driver_id}: ${fcm_token?.substring(0, 50)}...`);
            
            // تحديث حالة التوكن ليكون غير صالح
            await tarhalDB
                .from('driver_notifications')
                .update({ 
                    fcm_token: null,
                    notification_enabled: false,
                    updated_at: new Date().toISOString()
                })
                .eq('driver_id', driver.driver_id);
            
            return {
                success: false,
                message: 'توكن الإشعارات غير صالح',
                driverId: driver.driver_id
            };
        }
        
        console.log(`✅ توكن صالح للسائق ${driver.driver_id}: ${fcm_token.substring(0, 30)}...`);
        
        // 2. إعداد بيانات الرحلة للإرسال
        const notificationPayload = {
            driverId: driver.driver_id,
            fcmToken: fcm_token,
            rideData: {
                rideId: ride.id,
                requestId: requestId,
                customerName: ride.customer_name,
                customerPhone: ride.customer_phone || '',
                pickupLocation: 'موقع الانطلاق', // ⬅️ يمكنك استبدال هذا بموقع حقيقي
                destination: 'الوجهة', // ⬅️ يمكنك استبدال هذا بوجهة حقيقية
                amount: ride.amount || 0,
                vehicleType: ride.vehicle_type || 'economy',
                distance: ride.distance_km || 0,
                pickupLat: ride.pickup_lat,
                pickupLng: ride.pickup_lng,
                destinationLat: ride.destination_lat,
                destinationLng: ride.destination_lng,
                timestamp: new Date().toISOString()
            },
            notificationConfig: {
                title: '🚖 طلب رحلة جديد - ترحال زونا',
                body: `${ride.customer_name} يطلب رحلة ${getVehicleTypeName(ride.vehicle_type)}`,
                icon: '/icons/icon-192x192.png',
                badge: '/icons/icon-72x72.png',
                requireInteraction: true,
                vibrate: [200, 100, 200]
            }
        };
        
        // 3. خيارات الإرسال
        const sendOptions = {
            // إما استخدام Firebase مباشرة
            useFirebaseDirectly: false, // ⬅️ ضع true إذا تريد استخدام Firebase مباشرة
            // أو استخدام API مخصصة
            apiEndpoint: notificationServiceUrl,
            timeout: 10000 // 10 ثواني
        };
        
        let result;
        
        if (sendOptions.useFirebaseDirectly && window.firebase && firebase.messaging) {
            // 4A. الإرسال المباشر عبر Firebase (إذا كان يعمل)
            result = await sendViaFirebaseDirectly(notificationPayload);
        } else {
            // 4B. الإرسال عبر API مخصصة (مفضّل)
            result = await sendViaCustomAPI(notificationPayload, sendOptions.apiEndpoint);
        }
        
        // 5. تسجيل نتيجة الإرسال
        if (result.success) {
            console.log(`✅ تم إرسال الإشعار بنجاح للسائق ${driver.driver_id}`);
            
            // تسجيل في سجل النشاط
            try {
                await tarhalDB
                    .from('activity_logs')
                    .insert({
                        user_id: driver.driver_id,
                        user_type: 'driver',
                        action: 'notification_sent',
                        details: { 
                            rideId: ride.id, 
                            requestId: requestId,
                            method: result.method,
                            timestamp: new Date().toISOString()
                        }
                    });
            } catch (logError) {
                console.error('❌ خطأ في تسجيل النشاط:', logError);
            }
            
            return {
                success: true,
                message: 'تم إرسال الإشعار',
                driverId: driver.driver_id,
                details: result
            };
        } else {
            console.error(`❌ فشل إرسال الإشعار للسائق ${driver.driver_id}:`, result.error);
            
            // إذا كان الفشل بسبب توكن غير صالح
            if (result.error?.includes('invalid-registration-token') || 
                result.error?.includes('registration-token-not-registered')) {
                
                console.log(`🔄 تحديث توكن السائق ${driver.driver_id} ليكون غير صالح`);
                
                await tarhalDB
                    .from('driver_notifications')
                    .update({ 
                        fcm_token: null,
                        updated_at: new Date().toISOString()
                    })
                    .eq('driver_id', driver.driver_id);
            }
            
            return {
                success: false,
                message: 'فشل إرسال الإشعار',
                driverId: driver.driver_id,
                error: result.error
            };
        }
        
    } catch (error) {
        console.error(`❌ خطأ غير متوقع في إرسال إشعار للسائق:`, error);
        
        return {
            success: false,
            message: 'حدث خطأ غير متوقع',
            error: error.message,
            driverId: driver.driver_id
        };
    }
}

// ============================================
//  دالة الإرسال عبر Firebase مباشرة
// ============================================
async function sendViaFirebaseDirectly(payload) {
    try {
        if (!window.firebase || !firebase.messaging) {
            throw new Error('Firebase غير متاح');
        }
        
        const messaging = firebase.messaging();
        
        const message = {
            notification: {
                title: payload.notificationConfig.title,
                body: payload.notificationConfig.body,
                icon: payload.notificationConfig.icon,
                badge: payload.notificationConfig.badge,
                vibrate: payload.notificationConfig.vibrate,
                requireInteraction: payload.notificationConfig.requireInteraction
            },
            data: {
                ...payload.rideData,
                type: 'ride_request',
                action: 'accept_ride',
                click_action: 'ACCEPT_RIDE',
                urgency: 'high'
            },
            token: payload.fcmToken,
            webpush: {
                fcmOptions: {
                    link: `/driver/accept-ride.html?rideId=${payload.rideData.rideId}&requestId=${payload.rideData.requestId}`
                },
                headers: {
                    Urgency: 'high'
                }
            }
        };
        
        const response = await messaging.send(message);
        
        return {
            success: true,
            method: 'firebase_direct',
            messageId: response,
            timestamp: new Date().toISOString()
        };
        
    } catch (error) {
        console.error('❌ فشل الإرسال عبر Firebase:', error);
        
        return {
            success: false,
            method: 'firebase_direct',
            error: error.message,
            errorCode: error.code
        };
    }
}

// ============================================
//  دالة الإرسال عبر API مخصصة
// ============================================
async function sendViaCustomAPI(payload, apiEndpoint) {
    try {
        console.log(`📤 إرسال طلب إلى API: ${apiEndpoint}`);
        
        const response = await fetch(apiEndpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                rideId: payload.rideData.rideId,
                customerName: payload.rideData.customerName,
                customerPhone: payload.rideData.customerPhone,
                pickupLocation: payload.rideData.pickupLocation,
                destination: payload.rideData.destination,
                amount: payload.rideData.amount,
                vehicleType: payload.rideData.vehicleType,
                fcmToken: payload.fcmToken,
                driverId: payload.driverId,
                action: 'send_immediately' // ⬅️ أضف هذا
            }),
            signal: AbortSignal.timeout(10000)
        });
        
        if (!response.ok) {
            throw new Error(`خطأ API: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('📨 API Response:', result);
        
        return {
            success: result.success || false,
            method: 'custom_api_only',
            apiResponse: result,
            timestamp: new Date().toISOString()
        };
        
    } catch (error) {
        console.error('❌ فشل الاتصال بالـ API:', error);
        
        // بديل: استخدام إشعارات المتصفح المباشرة
        if ('Notification' in window && Notification.permission === 'granted') {
            console.log('🔄 استخدام إشعارات المتصفح كبديل');
            
            try {
                const notification = new Notification('🚖 طلب رحلة', {
                    body: `${payload.rideData.customerName} يطلب رحلة`,
                    icon: '/icons/icon-192x192.png',
                    tag: `ride-${payload.rideData.rideId}`,
                    data: payload.rideData
                });
                
                return {
                    success: true,
                    method: 'browser_notification_fallback',
                    notification: notification,
                    timestamp: new Date().toISOString()
                };
            } catch (notifError) {
                console.error('❌ فشل إشعار المتصفح:', notifError);
            }
        }
        
        return {
            success: false,
            method: 'api_failed',
            error: error.message,
            timestamp: new Date().toISOString()
        };
    }
}
        
        // ============================================
        //  انتظار رد السائق
        // ============================================
        function waitForDriverResponse(requestId, timeoutMs = 40000) {
            return new Promise((resolve) => {
                let responded = false;
                const startTime = Date.now();
                
                // الاستماع للتحديثات في الوقت الفعلي
                const subscription = tarhalDB
                    .channel(`ride_request_${requestId}`)
                    .on('postgres_changes', {
                        event: 'UPDATE',
                        schema: 'public',
                        table: 'ride_requests',
                        filter: `id=eq.${requestId}`
                    }, (payload) => {
                        if (payload.new.driver_response && !responded) {
                            responded = true;
                            subscription.unsubscribe();
                            resolve(payload.new.driver_response);
                        }
                    })
                    .subscribe();
                
                // التحقق الدوري من قاعدة البيانات
                const checkInterval = setInterval(async () => {
                    if (responded) {
                        clearInterval(checkInterval);
                        return;
                    }
                    
                    // التحقق من انتهاء الوقت
                    if (Date.now() - startTime > timeoutMs) {
                        clearInterval(checkInterval);
                        subscription.unsubscribe();
                        
                        // تحديث حالة الطلب إلى منتهي
                        await tarhalDB
                            .from('ride_requests')
                            .update({ 
                                status: 'expired',
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', requestId);
                        
                        resolve('expired');
                        return;
                    }
                    
                    // التحقق المباشر من قاعدة البيانات
                    try {
                        const { data: request } = await tarhalDB
                            .from('ride_requests')
                            .select('driver_response, status')
                            .eq('id', requestId)
                            .single();
                        
                        if (request?.driver_response) {
                            clearInterval(checkInterval);
                            subscription.unsubscribe();
                            responded = true;
                            resolve(request.driver_response);
                        }
                    } catch (error) {
                        // تجاهل الأخطاء
                    }
                }, 1000); // التحقق كل ثانية
            });
        }
        
        // ============================================
        //  معالجة إيجاد السائق
        // ============================================
        async function handleDriverFound(ride, driver) {
            try {
                // 1. تحديث حالة الرحلة
                await tarhalDB
                    .from('rides')
                    .update({
                        status: 'driver_assigned',
                        driver_id: driver.driver_id || driver.id,
                        driver_name: driver.drivers?.full_name || driver.driver_name,
                        driver_phone: driver.drivers?.whatsapp_number || driver.phone,
                        driver_assigned_at: new Date().toISOString(),
                        search_ended_at: new Date().toISOString()
                    })
                    .eq('id', ride.id);
                
                // 2. تحديث حالة السائق
                await tarhalDB
                    .from('driver_locations')
                    .update({
                        is_available: false,
                        current_ride_id: ride.id,
                        updated_at: new Date().toISOString()
                    })
                    .eq('driver_id', driver.driver_id || driver.id);
                
                // 3. إلغاء جميع طلبات الرحلة الأخرى
                await tarhalDB
                    .from('ride_requests')
                    .update({ 
                        status: 'cancelled',
                        updated_at: new Date().toISOString()
                    })
                    .eq('ride_id', ride.id)
                    .neq('status', 'accepted');
                
                // 4. إظهار رسالة النجاح
                showNotification(`✅ تم العثور على السائق: ${driver.drivers?.full_name || 'سائق'}`, 'success');
                
                // 5. إظهار تفاصيل الرحلة
                setTimeout(() => {
                    showActiveRideModal({
                        ...ride,
                        driver_name: driver.drivers?.full_name || driver.driver_name,
                        driver_phone: driver.drivers?.whatsapp_number || driver.phone,
                        car_model: driver.drivers?.car_model || driver.car_model,
                        car_type: driver.car_type
                    });
                }, 1000);
                
                // 6. إخفاء لوحة البحث
                hideSearchPanel();
                
                // 7. إرسال إشعار للعميل
                showNotificationToCustomer(ride, driver);
                
            } catch (error) {
                console.error('Error handling driver found:', error);
                showNotification('حدث خطأ في تأكيد السائق', 'error');
            }
        }
        
        function showNotificationToCustomer(ride, driver) {
            if (notificationManager) {
                notificationManager.showInAppNotification({
                    title: ' تم تعيين سائق لرحلتك',
                    body: `السائق ${driver.drivers?.full_name || driver.driver_name} في طريقه إليك`,
                    data: {
                        rideId: ride.id,
                        driverName: driver.drivers?.full_name || driver.driver_name,
                        driverPhone: driver.drivers?.whatsapp_number || driver.phone,
                        action: 'driver_assigned'
                    }
                });
            }
        }
        
        // ============================================
        //  معالجة عدم إيجاد سائقين
        // ============================================
        async function handleNoDriversFound(ride) {
            try {
                // 1. تحديث حالة الرحلة
                await tarhalDB
                    .from('rides')
                    .update({
                        status: 'no_drivers',
                        search_ended_at: new Date().toISOString(),
                        search_radius: MAX_SEARCH_RADIUS
                    })
                    .eq('id', ride.id);
                
                // 2. تحديث جميع طلبات الرحلة
                await tarhalDB
                    .from('ride_requests')
                    .update({ 
                        status: 'expired',
                        updated_at: new Date().toISOString()
                    })
                    .eq('ride_id', ride.id);
                
                // 3. إظهار رسالة للمستخدم
                showNotification('⚠️ لم نتمكن من إيجاد سائق في نطاق 50 كم. حاول مرة أخرى لاحقاً', 'warning');
                
                // 4. إعادة تفعيل زر البحث
                const confirmBtn = document.getElementById('confirm-ride-btn');
                confirmBtn.innerHTML = '<ion-icon name="search-outline"></ion-icon> بحث عن سائق';
                confirmBtn.disabled = false;
                
                // 5. إخفاء لوحة البحث
                hideSearchPanel();
                
            } catch (error) {
                console.error('Error handling no drivers found:', error);
            }
        }
        
        // ============================================
        //  لوحة البحث الجديدة
        // ============================================
        function showSearchPanel(ride) {
            // إنشاء لوحة البحث إذا لم تكن موجودة
            let searchPanel = document.getElementById('search-panel');
            if (!searchPanel) {
                searchPanel = document.createElement('div');
                searchPanel.id = 'search-panel';
                searchPanel.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 20px;
                    right: 20px;
                    background: white;
                    border-radius: 16px;
                    padding: 20px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                    z-index: 10000;
                    text-align: center;
                `;
                
                searchPanel.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 15px;">
                        <div class="loader" style="width: 24px; height: 24px;"></div>
                        <h3 style="color: #4f46e5; margin: 0;">جاري البحث عن سائقين</h3>
                    </div>
                    
                    <div id="search-stats" style="margin-bottom: 15px;">
                        <p style="color: #6b7280; margin: 5px 0;">
                            <span id="drivers-count">0</span> سائق في نطاق <span id="search-radius">5</span> كم
                        </p>
                        <div style="display: flex; align-items: center; gap: 8px; justify-content: center;">
                            <div style="flex: 1; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                                <div id="search-progress" style="height: 100%; background: #4f46e5; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <span id="progress-text" style="font-size: 14px; color: #4f46e5; font-weight: 600;">0%</span>
                        </div>
                    </div>
                    
                    <div id="found-drivers-list" style="max-height: 150px; overflow-y: auto; margin-bottom: 15px; text-align: right;"></div>
                    
                    <button onclick="cancelSearch()" style="
                        width: 100%;
                        padding: 14px;
                        background: #f1f5f9;
                        color: #64748b;
                        border: none;
                        border-radius: 12px;
                        font-family: 'Tajawal';
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s;
                    ">
                        <ion-icon name="close-circle-outline"></ion-icon>
                        إلغاء البحث
                    </button>
                `;
                
                document.body.appendChild(searchPanel);
            }
            
            searchPanel.style.display = 'block';
        }
        
        function updateSearchPanel(driversCount, searchRadius) {
            const driversCountEl = document.getElementById('drivers-count');
            const searchRadiusEl = document.getElementById('search-radius');
            const searchProgressEl = document.getElementById('search-progress');
            const progressTextEl = document.getElementById('progress-text');
            const foundDriversListEl = document.getElementById('found-drivers-list');
            
            if (driversCountEl) driversCountEl.textContent = driversCount;
            if (searchRadiusEl) searchRadiusEl.textContent = searchRadius;
            
            // تحديث شريط التقدم
            const progressPercent = Math.min((searchRadius / MAX_SEARCH_RADIUS) * 100, 100);
            if (searchProgressEl) searchProgressEl.style.width = `${progressPercent}%`;
            if (progressTextEl) progressTextEl.textContent = `${Math.round(progressPercent)}%`;
            
            // تحديث قائمة السائقين
            if (foundDriversListEl && availableDrivers.length > 0) {
                foundDriversListEl.innerHTML = `
                    <div style="color: #4f46e5; font-weight: 600; margin-bottom: 8px; text-align: center;">
                        السائقون المتاحون:
                    </div>
                    ${availableDrivers.slice(0, 3).map((driver, index) => `
                        <div style="
                            background: #f8fafc;
                            padding: 10px 15px;
                            border-radius: 10px;
                            margin-bottom: 8px;
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                        ">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="
                                    width: 36px;
                                    height: 36px;
                                    background: #4f46e5;
                                    color: white;
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-weight: 700;
                                ">
                                    ${index + 1}
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: #1f2937;">${driver.drivers?.full_name || driver.driver_name || 'سائق'}</div>
                                    <div style="font-size: 12px; color: #6b7280;">
                                        ${driver.car_type} • ${driver.drivers?.rating?.toFixed(1) || '5.0'} ⭐
                                    </div>
                                </div>
                            </div>
                            <div style="font-size: 14px; color: #059669;">
                                ${Math.round(calculateDistance(
                                    userPosition.lat, userPosition.lng,
                                    driver.lat, driver.lng
                                ))} كم
                            </div>
                        </div>
                    `).join('')}
                    
                    ${availableDrivers.length > 3 ? `
                        <div style="text-align: center; color: #6b7280; font-size: 14px; margin-top: 8px;">
                            +${availableDrivers.length - 3} سائقين آخرين
                        </div>
                    ` : ''}
                `;
            }
        }
        
        function hideSearchPanel() {
            const searchPanel = document.getElementById('search-panel');
            if (searchPanel) {
                searchPanel.style.display = 'none';
            }
        }
        
        async function cancelSearch() {
            if (rideSearchInterval) {
                clearInterval(rideSearchInterval);
                rideSearchInterval = null;
            }
            
            if (currentRideId) {
                try {
                    await tarhalDB
                        .from('rides')
                        .update({
                            status: 'cancelled_by_customer',
                            search_ended_at: new Date().toISOString()
                        })
                        .eq('id', currentRideId);
                    
                    // إلغاء جميع طلبات الرحلة
                    await tarhalDB
                        .from('ride_requests')
                        .update({ 
                            status: 'cancelled',
                            updated_at: new Date().toISOString()
                        })
                        .eq('ride_id', currentRideId);
                } catch (error) {
                    console.error('Error cancelling search:', error);
                }
            }
            
            hideSearchPanel();
            showNotification('تم إلغاء البحث عن سائق', 'info');
            
            // إعادة تفعيل الزر
            const confirmBtn = document.getElementById('confirm-ride-btn');
            confirmBtn.innerHTML = '<ion-icon name="search-outline"></ion-icon> بحث عن سائق';
            confirmBtn.disabled = false;
        }
        
        function recenterMap() {
            if (userPosition && rideMap) {
                if (routePolyline && currentRoute) {
                    // إذا كان هناك مسار، عرض المسار كاملاً
                    const bounds = routePolyline.getBounds();
                    if (startMarker) bounds.extend(startMarker.getLatLng());
                    if (endMarker) bounds.extend(endMarker.getLatLng());
                    rideMap.fitBounds(bounds, { padding: [50, 50] });
                } else {
                    // إذا لم يكن هناك مسار، التمركز على نقطة البداية فقط
                    rideMap.setView([userPosition.lat, userPosition.lng], 15);
                }
                
                showNotification('تم التمركز على الخريطة', 'success');
            }
        }
        
        async function refreshLocation() {
            if (navigator.geolocation) {
                showNotification('جاري تحديث الموقع...', 'info');
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // تحديث علامة البداية
                        if (startMarker) {
                            startMarker.setLatLng([userPosition.lat, userPosition.lng]);
                        } else {
                            startMarker = L.marker([userPosition.lat, userPosition.lng], {
                                icon: L.divIcon({
                                    html: '<div class="start-marker">A</div>',
                                    className: 'start-marker-div',
                                    iconSize: [32, 32],
                                    iconAnchor: [16, 16]
                                })
                            }).addTo(rideMap).bindPopup("نقطة البداية").openPopup();
                        }
                        
                        // إذا كان هناك وجهة محددة، إعادة حساب المسار
                        if (destinationPosition) {
                            calculateRealRouteAndDisplay();
                        }
                        
                        showNotification('تم تحديث موقعك بنجاح', 'success');
                    },
                    (error) => {
                        showNotification('تعذر تحديث الموقع', 'error');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000
                    }
                );
            }
        }
        
        // ============================================
        //  تحسينات واجهة الرحلة النشطة
        // ============================================
        function showActiveRideModal(ride) {
            const modal = document.getElementById('active-trip-modal');
            modal.classList.remove('hidden');
            
            const tripDetails = document.getElementById('trip-details');
            tripDetails.innerHTML = `
                <div class="card mb-3">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <div style="
                            width: 60px;
                            height: 60px;
                            background: linear-gradient(135deg, #4f46e5, #7c3aed);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 24px;
                            font-weight: 700;
                        ">
                            ${ride.driver_name?.charAt(0) || 'س'}
                        </div>
                        <div>
                            <h3 style="color: #1f2937; margin: 0 0 5px 0;">${ride.driver_name || 'سائق'}</h3>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="
                                    background: #dcfce7;
                                    color: #059669;
                                    padding: 4px 12px;
                                    border-radius: 20px;
                                    font-size: 12px;
                                    font-weight: 600;
                                ">
                                    ${getVehicleTypeName(ride.car_type || ride.vehicle_type)}
                                </span>
                                <span style="color: #6b7280; font-size: 14px;">
                                    ${ride.car_model || ''}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="price-row" style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e5e7eb;">
                        <span style="color: #6b7280;">رقم السائق:</span>
                        <span style="font-weight: 600; color: #1f2937;">${ride.driver_phone || 'غير متوفر'}</span>
                    </div>
                    
                    <div class="price-row" style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e5e7eb;">
                        <span style="color: #6b7280;">منطقة الانطلاق:</span>
                        <span style="font-weight: 600; color: #1f2937;">${getNeighborhoodName(ride.pickup_lat, ride.pickup_lng)}</span>
                    </div>
                    
                    <div class="price-row" style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e5e7eb;">
                        <span style="color: #6b7280;">منطقة الوصول:</span>
                        <span style="font-weight: 600; color: #1f2937;">${getNeighborhoodName(ride.destination_lat, ride.destination_lng)}</span>
                    </div>
                    
                    <div class="price-row" style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e5e7eb;">
                        <span style="color: #6b7280;">المسافة:</span>
                        <span style="font-weight: 600; color: #1f2937;">${ride.distance_km || '0'} كم</span>
                    </div>
                    
                    <div class="price-row" style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: none; font-weight: 800; color: #4f46e5; font-size: 20px;">
                        <span>المجموع:</span>
                        <span>${(ride.amount || 0).toLocaleString('en-US')} SDG</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="callDriver('${ride.driver_phone || ''}')" style="
                        padding: 14px;
                        background: #10b981;
                        color: white;
                        border: none;
                        border-radius: 12px;
                        font-family: 'Tajawal';
                        font-weight: 600;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                    ">
                        <ion-icon name="call-outline"></ion-icon>
                        الاتصال بالسائق
                    </button>
                    
                    <button class="btn btn-outline" onclick="sendMessageToDriver('${ride.driver_phone || ''}')" style="
                        padding: 14px;
                        background: white;
                        color: #4f46e5;
                        border: 2px solid #4f46e5;
                        border-radius: 12px;
                        font-family: 'Tajawal';
                        font-weight: 600;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                    ">
                        <ion-icon name="chatbubble-outline"></ion-icon>
                        مراسلة
                    </button>
                </div>
                
                <div class="mb-3">
                    <button class="btn btn-danger" onclick="cancelRide()" style="
                        width: 100%;
                        padding: 14px;
                        background: #ef4444;
                        color: white;
                        border: none;
                        border-radius: 12px;
                        font-family: 'Tajawal';
                        font-weight: 600;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                    ">
                        <ion-icon name="close-outline"></ion-icon>
                        إلغاء الرحلة
                    </button>
                </div>
                
                <p style="text-align: center; color: #6b7280; font-size: 14px; margin-top: 20px;">
                    <ion-icon name="time-outline" style="vertical-align: middle;"></ion-icon>
                    السائق في طريقه إليك الآن
                </p>
            `;
            
            // تحديث زر البحث في الشاشة الرئيسية
            document.getElementById('confirm-ride-btn').innerHTML = '<ion-icon name="search-outline"></ion-icon> بحث عن سائق';
            document.getElementById('confirm-ride-btn').disabled = false;
        }
        
        async function callDriver(phoneNumber) {
            if (!phoneNumber) {
                showNotification('رقم السائق غير متوفر', 'warning');
                return;
            }
            
            // تنظيف رقم الهاتف
            const cleanNumber = phoneNumber.replace(/\D/g, '');
            const telUrl = `tel:${cleanNumber}`;
            
            showNotification('جاري الاتصال بالسائق...', 'info');
            
            // محاولة فتح تطبيق الهاتف
            window.open(telUrl, '_blank');
            
            // تسجيل المكالمة
            try {
                await tarhalDB
                    .from('activity_logs')
                    .insert({
                        user_id: currentUser?.id,
                        user_type: 'customer',
                        action: 'call_driver',
                        details: { 
                            driver_phone: phoneNumber,
                            ride_id: currentRideId 
                        }
                    });
            } catch (error) {
                console.error('Error logging call:', error);
            }
        }
        
        async function sendMessageToDriver(phoneNumber) {
            if (!phoneNumber) {
                showNotification('رقم السائق غير متوفر', 'warning');
                return;
            }
            
            // تنظيف رقم الهاتف
            const cleanNumber = phoneNumber.startsWith('+') ? phoneNumber : `+${phoneNumber}`;
            const message = encodeURIComponent('مرحباً، أنا العميل على تطبيق ترحال زونا');
            const whatsappUrl = `https://wa.me/${cleanNumber}?text=${message}`;
            
            showNotification('جاري فتح واتساب...', 'info');
            window.open(whatsappUrl, '_blank');
        }
        
        function cancelRide() {
            document.getElementById('active-trip-modal').classList.add('hidden');
            showNotification('تم إلغاء الرحلة', 'info');
            goHome();
        }
        
        function acceptRide() {
            document.getElementById('incoming-ride-modal').classList.add('hidden');
            showNotification('تم قبول الرحلة بنجاح', 'success');
            showActiveRideModal({
                vehicle_type: 'economy',
                amount: 10000,
                distance_km: 5.2
            });
        }
        
        function declineRide() {
            document.getElementById('incoming-ride-modal').classList.add('hidden');
            showNotification('تم رفض الرحلة', 'info');
        }
        
        // ============================================
        //  إعدادات التطبيق المحسنة
        // ============================================
        function showSettings() {
            // إنشاء نافذة الإعدادات
            const settingsModal = document.createElement('div');
            settingsModal.id = 'settings-modal';
            settingsModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 99999;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;
            
            settingsModal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 20px;
                    padding: 30px;
                    max-width: 500px;
                    width: 100%;
                    max-height: 90vh;
                    overflow-y: auto;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h2 style="color: #4f46e5; margin: 0;">
                            <ion-icon name="settings-outline" style="vertical-align: middle;"></ion-icon>
                            الإعدادات
                        </h2>
                        <button onclick="document.getElementById('settings-modal').remove()" style="
                            background: none;
                            border: none;
                            color: #6b7280;
                            font-size: 24px;
                            cursor: pointer;
                        ">
                            ×
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #374151; margin-bottom: 15px;">إعدادات البحث</h4>
                        
                        <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="color: #4b5563;">نطاق البحث الافتراضي</span>
                                <span id="search-radius-value" style="color: #4f46e5; font-weight: 600;">20 كم</span>
                            </div>
                            <input type="range" min="5" max="50" value="20" 
                                oninput="updateSearchRadius(this.value)" style="width: 100%;">
                        </div>
                        
                        <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="color: #4b5563;">تفضيلات نوع المركبة</span>
                                <span id="preferred-vehicle" style="color: #4f46e5; font-weight: 600;">اقتصادية</span>
                            </div>
                            <select id="vehicle-preference" onchange="updateVehiclePreference(this.value)" style="
                                width: 100%;
                                padding: 12px;
                                border: 2px solid #e5e7eb;
                                border-radius: 8px;
                                font-family: 'Tajawal';
                                font-size: 16px;
                            ">
                                <option value="tuktuk">توك توك</option>
                                <option value="economy" selected>اقتصادية</option>
                                <option value="comfort">متوسطة</option>
                                <option value="vip">VIP</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #374151; margin-bottom: 15px;">الإشعارات</h4>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8fafc; border-radius: 12px; margin-bottom: 10px;">
                            <span style="color: #4b5563;">إشعارات الطلبات</span>
                            <label style="position: relative; display: inline-block; width: 50px; height: 26px;">
                                <input type="checkbox" id="notifications-toggle" checked style="opacity: 0; width: 0; height: 0;">
                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px;">
                                    <span style="position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;"></span>
                                </span>
                            </label>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8fafc; border-radius: 12px;">
                            <span style="color: #4b5563;">أصوات التنبيه</span>
                            <label style="position: relative; display: inline-block; width: 50px; height: 26px;">
                                <input type="checkbox" id="sounds-toggle" checked style="opacity: 0; width: 0; height: 0;">
                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px;">
                                    <span style="position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;"></span>
                                </span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <button onclick="saveSettings()" style="
                            width: 100%;
                            padding: 16px;
                            background: #4f46e5;
                            color: white;
                            border: none;
                            border-radius: 12px;
                            font-family: 'Tajawal';
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            margin-bottom: 15px;
                        ">
                            حفظ الإعدادات
                        </button>
                        
                        <button onclick="document.getElementById('settings-modal').remove()" style="
                            width: 100%;
                            padding: 16px;
                            background: #f1f5f9;
                            color: #64748b;
                            border: none;
                            border-radius: 12px;
                            font-family: 'Tajawal';
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                        ">
                            إلغاء
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(settingsModal);
            
            // تحميل الإعدادات المحفوظة
            loadSettings();
        }
        
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('tarhal_settings')) || {};
            
            // نطاق البحث
            const radiusSlider = document.querySelector('#settings-modal input[type="range"]');
            if (radiusSlider && settings.searchRadius) {
                radiusSlider.value = settings.searchRadius;
                document.getElementById('search-radius-value').textContent = `${settings.searchRadius} كم`;
            }
            
            // نوع المركبة المفضل
            const vehicleSelect = document.getElementById('vehicle-preference');
            if (vehicleSelect && settings.preferredVehicle) {
                vehicleSelect.value = settings.preferredVehicle;
                document.getElementById('preferred-vehicle').textContent = 
                    getVehicleTypeName(settings.preferredVehicle);
            }
            
            // الإشعارات
            const notificationsToggle = document.getElementById('notifications-toggle');
            if (notificationsToggle) {
                notificationsToggle.checked = settings.notificationsEnabled !== false;
            }
            
            // الأصوات
            const soundsToggle = document.getElementById('sounds-toggle');
            if (soundsToggle) {
                soundsToggle.checked = settings.soundsEnabled !== false;
            }
        }
        
        function updateSearchRadius(value) {
            document.getElementById('search-radius-value').textContent = `${value} كم`;
        }
        
        function updateVehiclePreference(value) {
            document.getElementById('preferred-vehicle').textContent = getVehicleTypeName(value);
        }
        
        function saveSettings() {
            const settings = {
                searchRadius: parseInt(document.querySelector('#settings-modal input[type="range"]').value),
                preferredVehicle: document.getElementById('vehicle-preference').value,
                notificationsEnabled: document.getElementById('notifications-toggle').checked,
                soundsEnabled: document.getElementById('sounds-toggle').checked,
                savedAt: new Date().toISOString()
            };
            
            localStorage.setItem('tarhal_settings', JSON.stringify(settings));
            showNotification('تم حفظ الإعدادات بنجاح', 'success');
            
            setTimeout(() => {
                document.getElementById('settings-modal').remove();
            }, 1500);
        }
        
        // ============================================
        // ️ دوال مساعدة محسنة
        // ============================================
        
        function showNotification(message, type = 'info') {
            const notificationArea = document.getElementById('notification-area');
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            let icon = 'ℹ️';
            if (type === 'success') icon = '✅';
            else if (type === 'error') icon = '❌';
            else if (type === 'warning') icon = '⚠️';
            
            notification.innerHTML = `
                <div class="notification-icon">${icon}</div>
                <div style="flex: 1;">${message}</div>
            `;
            
            notificationArea.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-20px)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        async function getNeighborhoodName(lat, lng) {
            try {
                // محاولة الحصول على اسم المنطقة من خدمة عكسية
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`
                );
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // محاولة الحصول على أفضل اسم للمنطقة
                    const address = data.address;
                    return address.neighbourhood || 
                           address.suburb || 
                           address.city_district || 
                           address.city || 
                           'موقع غير محدد';
                }
            } catch (error) {
                console.error('Error getting neighborhood:', error);
            }
            
            // العودة إلى الافتراضي
            const neighborhoods = [
                'الخرطوم - العمارات',
                'أم درمان - السوق',
                'بحري - السوق',
                'الخرطوم - الرياض',
                'أم درمان - إركويت',
                'بحري - كافوري'
            ];
            
            // استخدام الموقع التقريبي لتحديد المنطقة
            const index = Math.floor(Math.abs(lat + lng) * 1000) % neighborhoods.length;
            return neighborhoods[index];
        }
        
        function getVehicleTypeName(type) {
            const names = {
                tuktuk: 'توك توك',
                economy: 'اقتصادية',
                comfort: 'متوسطة',
                vip: 'VIP'
            };
            return names[type] || type;
        }
        
        function isValidSudanesePhone(phone) {
            const sudanesePhoneRegex = /^(?:\+249|0)?(?:9[0123456789]|1[012])\d{7}$/;
            return sudanesePhoneRegex.test(phone);
        }
        
        function checkAuth() {
            const savedUser = localStorage.getItem('tarhal_customer');
            const savedDriver = localStorage.getItem('tarhal_driver');
            
            if (savedDriver) {
                try {
                    currentDriver = JSON.parse(savedDriver);
                    showScreen('driver-dashboard-screen');
                    updateDriverDashboard();
                    updateDriverUI();
                } catch (e) {
                    localStorage.removeItem('tarhal_driver');
                    showScreen('welcome-screen');
                }
            } else if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showScreen('home-screen');
                    updateUserProfile();
                } catch (e) {
                    localStorage.removeItem('tarhal_customer');
                    showScreen('welcome-screen');
                }
            } else {
                showScreen('welcome-screen');
            }
        }
        
        function logout() {
            localStorage.removeItem('tarhal_customer');
            currentUser = null;
            showScreen('welcome-screen');
            showNotification('تم تسجيل الخروج بنجاح', 'success');
        }
        
        function logoutDriver() {
            if (isDriverOnline) {
                toggleDriverStatus();
            }
            localStorage.removeItem('tarhal_driver');
            currentDriver = null;
            showScreen('welcome-screen');
            showNotification('تم تسجيل خروج السائق', 'success');
        }
        
        // Placeholder functions
        function showMyRides() {
            showNotification('قريباً: عرض الرحلات السابقة', 'info');
        }
        
        function showWallet() {
            showNotification('قريباً: المحفظة الإلكترونية', 'info');
        }
        
        function showDriverProfile() {
            showNotification('قريباً: الملف الشخصي للسائق', 'info');
        }
        
        // تحميل Leaflet ديناميكياً
        window.addEventListener('load', function() {
            if (typeof L === 'undefined') {
                const leafletScript = document.createElement('script');
                leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                leafletScript.onload = function() {
                    console.log('✅ Leaflet loaded successfully');
                };
                document.head.appendChild(leafletScript);
            }
            
            // طلب إذن الإشعارات عند تحميل الصفحة
            if ('Notification' in window && Notification.permission === 'default') {
                // ننتظر حتى يكون هناك تفاعل من المستخدم
            }
        });
        
        console.log('✅ تم تحميل النظام المحسن لتطبيق ترحال زونا');</script>
    
    <!-- ملفات النظام الجديد -->
    <script src="notification-manager.js"></script>
    <script src="sound-manager.js">// ============================================
//  تفعيل الصوت التلقائي
// ============================================

// تفعيل الصوت بعد تحميل الصفحة بالكامل
window.addEventListener('load', function() {
  setTimeout(function() {
    if (window.soundManager) {
      console.log('🔊 محاولة تفعيل الصوت التلقائي...');
      
      // طريقة 1: تفعيل فوري
      try {
        window.soundManager.activateAudioImmediately();
      } catch (e) {
        console.log('⚠️ تعذر التفعيل الفوري:', e);
      }
      
      // طريقة 2: تفعيل عند أول نقر
      document.addEventListener('click', function activateOnClick() {
        if (window.soundManager) {
          window.soundManager.enabled = true;
          window.soundManager.savePreferences();
          console.log('✅ تم تفعيل الصوت بنقرة المستخدم');
        }
        document.removeEventListener('click', activateOnClick);
      }, { once: true });
    }
  }, 3000);
});

// تفعيل الصوت عند أول تفاعل حقيقي مع المستخدم
['click', 'touchstart', 'keydown'].forEach(event => {
  document.addEventListener(event, function activateSound() {
    if (window.soundManager && !window.soundManager.enabled) {
      // ✅ التفعيل الصحيح المسموح
      window.soundManager.enable();

      // صوت تأكيد خفيف
      window.soundManager.playSound('beep');

      console.log('🎵 تم تفعيل الصوت بتفاعل:', event);

      // إزالة كل المستمعين بعد التفعيل
      ['click', 'touchstart', 'keydown'].forEach(e => {
        document.removeEventListener(e, activateSound);
      });
    }
  }, { once: true });
});
</script>
   
</body>
</html>